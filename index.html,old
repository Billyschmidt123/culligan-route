<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Culligan Route - Professional v27.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin:0; height:100vh; display:flex; font-family:'Segoe UI',sans-serif; background:#111; color:white; overflow:hidden;} [cite: 2]
        #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column;} [cite: 3]
        #sidebar-header { padding:15px; border-bottom:1px solid #444;} [cite: 4]
        #stop-list { flex:1; overflow-y:auto; padding:10px;} [cite: 5]
        .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer; position: relative;} [cite: 5, 6]
        #customer-profile { display:none; padding:15px; background:#222; overflow-y:auto; height:100%; } [cite: 8]
        .profile-group { margin-bottom:12px; } [cite: 9]
        .profile-group label { display:block; font-size:11px; color:#0078ff; font-weight:bold; margin-bottom:4px; text-transform: uppercase;} [cite: 10, 11]
        .profile-group input, .profile-group textarea { width:100%; padding:8px; background:#333; border:1px solid #444; color:white; border-radius:4px; box-sizing:border-box; } [cite: 12]
        #sig-canvas { background:white; border-radius:4px; width:100%; height:150px; touch-action: none; border: 2px solid #555; display: block;} [cite: 12, 13]
        .form-btns { display:flex; gap:10px; margin-top:20px; padding-bottom: 40px;} [cite: 13, 14]
        .btn-del { flex:1; background:#28a745; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold;} [cite: 14, 15]
        .btn-not { flex:1; background:#dc3545; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold;} [cite: 15, 16]
        #main-view { flex:1; display:flex; flex-direction:column; position: relative;} [cite: 16, 17]
        #controls { background:#222; padding:15px; border-bottom:2px solid #0078ff; display: flex; align-items: center; gap: 10px;} [cite: 17, 18]
        #map { flex:1; } [cite: 18, 19]
        .btn { padding:10px 15px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;} [cite: 19, 20]
        #status { font-size:13px; color:#0078ff; font-weight: bold;} [cite: 22, 23]
        .number-pin { background:#0078ff; color:white; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white;} [cite: 23, 24]
    </style>
</head>
<body>

<div id="sidebar">
    <div id="list-view">
        <div id="sidebar-header">
            <h3 style="margin:0">Route Stops</h3>
            <p id="stop-count" style="font-size:12px; color:#aaa;">No route loaded</p> [cite: 38]
        </div>
        <div id="stop-list"></div>
    </div>

    <div id="customer-profile">
        <button onclick="closeProfile()" style="background:#444; color:white; border:none; padding:10px; width:100%; margin-bottom:15px; cursor:pointer;">‚Üê BACK TO LIST</button>
        <h3 id="prof-name" style="margin:0;">Customer Name</h3> [cite: 38]
        <p id="prof-addr" style="font-size:12px; color:#aaa; margin-bottom:15px;"></p> [cite: 38]
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="profile-group"><label>18L BOTTLES</label><input type="number" id="p-18l" value="0"></div> [cite: 38]
            <div class="profile-group"><label>18L RETURNS</label><input type="number" id="p-18l-ret" value="0"></div> [cite: 38]
            <div class="profile-group"><label>SMALL BOTTLES</label><input type="number" id="p-small" value="0"></div> [cite: 38]
            <div class="profile-group"><label>SMALL RETURNS</label><input type="number" id="p-small-ret" value="0"></div> [cite: 38]
            <div class="profile-group" style="grid-column: span 2;"><label>CASES</label><input type="number" id="p-cases" value="0"></div> [cite: 38]
        </div>

        <div class="profile-group"><label>RECEIVED BY</label><input type="text" id="p-rec-by" placeholder="Name"></div> [cite: 39]
        <div class="profile-group"><label>NOTES / INSTRUCTIONS</label><textarea id="p-notes" rows="2"></textarea></div> [cite: 39]
        
        <label style="font-size:11px; color:#0078ff; font-weight:bold;">SIGNATURE</label> [cite: 40]
        <canvas id="sig-canvas"></canvas>
        <button onclick="clearSig()" style="width:100%; margin:5px 0; background:#444; color:white; border:none; padding:5px; cursor:pointer;">CLEAR SIGNATURE</button>

        <div class="form-btns">
            <button class="btn-del" onclick="submitLog('DELIVERED')">DELIVERED</button> [cite: 14, 15]
            <button class="btn-not" onclick="submitLog('NOT DELIVERED')">NOT DELIVERED</button> [cite: 15, 16]
        </div>
    </div>
</div>

<div id="main-view">
    <div id="controls">
        <select id="route-select">
            <optgroup label="Week 1">
                <option value="917509026">WEEK 1 MONDAY</option> 
                <option value="405991289">WEEK 1 TUESDAY</option> 
                <option value="405991289">WEEK 1 WEDNESDAY</option> 
                <option value="850217841">WEEK 1 THURSDAY</option> 
                <option value="524003696">WEEK 1 FRIDAY</option> 
            </optgroup>
            <optgroup label="Special Routes">
                <option value="458612538">VALLEYVIEW</option> [cite: 45]
                <option value="1773492755">SALT</option> [cite: 46]
            </optgroup>
        </select>
        <button class="btn" onclick="loadRoute()">Load Route</button> [cite: 46]
        <div id="status">Status: Ready</div> [cite: 46]
    </div>
    <div id="map"></div>
</div>

<script>
// --- CORE CONNECTION ---
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwarIJVpFBV2mbD0z3A5OHTQ2GT0xdt7dRuTqO-7gb6kRE-7Odch7FehiyP7HnZeLc3/exec"; 
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio"; [cite: 57]

let map, markerLayer, stops = [], currentStopIndex = null, drawing = false;
let canvas, ctx;

window.onload = () => {
    map = L.map("map").setView([55.1707, -118.7947], 11); [cite: 57]
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map); [cite: 57]
    markerLayer = L.layerGroup().addTo(map); [cite: 57]
    initSig();
};

function initSig() {
    canvas = document.getElementById('sig-canvas'); ctx = canvas.getContext('2d');
    const getPos = (e) => {
        const r = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - r.left, y: clientY - r.top };
    };
    const start = (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); if(e.cancelable) e.preventDefault(); };
    const move = (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.lineWidth = 2; ctx.stroke(); if(e.cancelable) e.preventDefault(); };
    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('touchstart', start, {passive: false}); canvas.addEventListener('touchmove', move, {passive: false});
    window.addEventListener('touchend', () => drawing = false);
}

function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

async function loadRoute() {
    const gid = document.getElementById('route-select').value; [cite: 58]
    const statusDiv = document.getElementById('status');
    statusDiv.innerText = "Status: Connecting..."; [cite: 58]
    
    stops = [];
    markerLayer.clearLayers(); [cite: 58]
    document.getElementById('stop-list').innerHTML = ""; [cite: 58]

    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}&t=${Date.now()}`; [cite: 58]
        const res = await fetch(url); [cite: 59]
        const data = await res.text(); [cite: 59]
        
        const lines = data.split('\n'); [cite: 59]
        statusDiv.innerText = "Status: Geocoding..."; [cite: 59]

        for (let i = 1; i < lines.length; i++) { [cite: 60]
            const cols = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); [cite: 60]
            if (cols.length > 3) {
                const company = cols[2]?.replace(/"/g, '').trim(); [cite: 60]
                const address = cols[3]?.replace(/"/g, '').trim(); [cite: 61]
                const email = cols[7]?.replace(/"/g, '').trim(); 
                
                if (address && address.length > 5) { [cite: 61]
                    const resGeo = await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(address)}&maxLocations=1`); [cite: 66]
                    const gData = await resGeo.json(); [cite: 67]
                    
                    if (gData.candidates && gData.candidates.length) { [cite: 67]
                        stops.push({
                            company: company || "Customer", [cite: 62]
                            address: address, [cite: 62]
                            email: email || "",
                            lat: gData.candidates[0].location.y, [cite: 67]
                            lng: gData.candidates[0].location.x, [cite: 67]
                            status: 'pending'
                        });
                    }
                }
            }
        }

        renderSidebar(); [cite: 63]
        renderMapMarkers(); [cite: 63]
       
        if (stops.length > 0) { [cite: 64]
            statusDiv.innerText = `Status: Loaded (${stops.length})`; [cite: 64]
            document.getElementById('stop-count').innerText = `${stops.length} Stops Found`; [cite: 64]
        } else {
            statusDiv.innerText = "Status: No Data"; [cite: 64]
        }
    } catch (e) {
        statusDiv.innerText = "Status: Load Failed"; [cite: 65]
    }
}

function renderMapMarkers() {
    markerLayer.clearLayers(); [cite: 68]
    stops.forEach((s, i) => { [cite: 69]
        L.marker([s.lat, s.lng], { 
            icon: L.divIcon({ 
                className:'custom-div-icon', 
                html:`<div class="number-pin" style="background:${s.status==='completed'?'#28a745':'#0078ff'}">${i+1}</div>` 
            }) 
        }).addTo(markerLayer); [cite: 69]
    });
}

function renderSidebar() {
    const list = document.getElementById("stop-list"); [cite: 70]
    list.innerHTML = ""; [cite: 70]
    stops.forEach((s, i) => { [cite: 71]
        const div = document.createElement("div"); [cite: 71]
        div.className = "stop-card"; [cite: 71]
        div.style.opacity = s.status === 'completed' ? '0.4' : '1';
        div.innerHTML = `<b>${i+1}. ${s.company}</b><br><small>${s.address}</small>`; [cite: 71]
        div.onclick = () => openProfile(i); [cite: 71]
        list.appendChild(div); [cite: 71]
    });
}

function openProfile(i) {
    currentStopIndex = i; [cite: 72]
    const s = stops[i]; [cite: 72]
    document.getElementById('list-view').style.display = 'none'; [cite: 72]
    document.getElementById('customer-profile').style.display = 'block'; [cite: 72]
    document.getElementById('prof-name').innerText = s.company; [cite: 73]
    document.getElementById('prof-addr').innerText = s.address; [cite: 73]
    clearSig();
    map.setView([s.lat, s.lng], 16); [cite: 73]
}

function closeProfile() {
    document.getElementById('list-view').style.display = 'block'; [cite: 74]
    document.getElementById('customer-profile').style.display = 'none'; [cite: 74]
}

function submitLog(status) {
    const s = stops[currentStopIndex];
    const payload = {
        routeName: document.getElementById('route-select').options[document.getElementById('route-select').selectedIndex].text,
        customer: s.company,
        address: s.address,
        customerEmail: s.email,
        status: status,
        d18: document.getElementById('p-18l').value || 0,
        r18: document.getElementById('p-18l-ret').value || 0,
        dSm: document.getElementById('p-small').value || 0,
        rSm: document.getElementById('p-small-ret').value || 0,
        cs: document.getElementById('p-cases').value || 0,
        receivedBy: document.getElementById('p-rec-by').value || "N/A",
        notes: document.getElementById('p-notes').value || "None",
        sig: canvas.toDataURL(),
        timestamp: new Date().toLocaleString()
    };

    fetch(WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(payload)
    });

    s.status = 'completed';
    closeProfile();
    renderSidebar();
    renderMapMarkers();
}
</script>
</body>
</html>
