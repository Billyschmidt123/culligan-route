<!DOCTYPE html>
<html>
<head>
    <title>Culligan Route Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --culligan-blue: #0078ff; --sidebar-width: 280px; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; background: #f0f2f5; }
        
        /* RESTORED LOADING BAR */
        #loading-bar-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #e0e0e0; z-index: 10000; display: none; }
        #loading-bar { height: 100%; width: 0%; background: var(--culligan-blue); transition: width 0.3s; }

        /* RESTORED SIDE PANEL */
        #sidebar { width: var(--sidebar-width); background: #1e1e2d; color: white; display: flex; flex-direction: column; transition: 0.3s; z-index: 1001; }
        .sidebar-header { padding: 20px; background: #1a1a27; text-align: center; border-bottom: 1px solid #333; }
        .menu-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #2d2d3f; }
        .menu-item:hover { background: var(--culligan-blue); }
        
        #main { flex: 1; display: flex; flex-direction: column; }
        header { background: var(--culligan-blue); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        #map { flex: 1; width: 100%; }
        #stop-list { height: 250px; overflow-y: auto; padding: 15px; background: white; border-top: 2px solid #ddd; }
        
        .stop-card { background: white; border-left: 5px solid var(--culligan-blue); padding: 12px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; color: white; }
        .modal-box { background: #fff; color: #333; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; }
        
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        input, textarea { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        
        #sig-canvas { border: 1px solid #000; background: #fff; width: 100%; height: 120px; touch-action: none; }
        .btn { padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-blue { background: var(--culligan-blue); color: white; }
    </style>
</head>
<body>

<div id="loading-bar-container"><div id="loading-bar"></div></div>

<div id="sidebar">
    <div class="sidebar-header"><h2>CULLIGAN</h2></div>
    <div class="menu-item" onclick="loadRouteList()">Refresh Route List</div>
    <div id="route-list-container"></div>
    <div class="menu-item" style="margin-top:auto; background:#dc3545;">Logout</div>
</div>

<div id="main">
    <header>
        <span onclick="toggleSidebar()" style="cursor:pointer; font-size:20px;">â˜°</span>
        <div id="current-route">Culligan Route Manager</div>
        <div id="stop-count">0 Stops</div>
    </header>
    <div id="map"></div>
    <div id="stop-list"></div>
</div>

<div id="dataModal" class="overlay">
    <div class="modal-box">
        <h2 id="mCustName" style="color:var(--culligan-blue); margin-top:0;">Customer</h2>
        <div class="input-grid">
            <input type="number" id="inv18" placeholder="18L Del">
            <input type="number" id="ret18" placeholder="18L Ret">
            <input type="number" id="invSm" placeholder="Sm Del">
            <input type="number" id="retSm" placeholder="Sm Ret">
            <input type="number" id="cases" placeholder="Cases">
            <input type="text" id="recv" placeholder="Recv By">
        </div>
        <textarea id="notes" placeholder="Notes"></textarea>
        <p>Signature:</p>
        <canvas id="sig-canvas"></canvas>
        <button class="btn btn-blue" onclick="submitData()">SUBMIT DELIVERY</button>
        <button class="btn" style="background:#eee;" onclick="closeModals()">CANCEL</button>
    </div>
</div>

<script>
    const API = "YOUR_WEB_APP_URL";
    let map, activeIdx, canvas, ctx, drawing = false;
    let stops = [];

    // RESTORED: Route Loading Features
    async function loadRouteList() {
        showLoading(true);
        updateProgress(30);
        try {
            const resp = await fetch(API);
            const routes = await resp.json();
            const container = document.getElementById('route-list-container');
            container.innerHTML = "";
            updateProgress(70);
            routes.forEach(r => {
                if(r === "Deliveries") return;
                const div = document.createElement('div');
                div.className = "menu-item";
                div.innerText = r;
                div.onclick = () => loadRouteData(r);
                container.appendChild(div);
            });
            updateProgress(100);
        } catch (e) { alert("Load Error"); }
        setTimeout(() => showLoading(false), 500);
    }

    async function loadRouteData(routeName) {
        showLoading(true);
        updateProgress(50);
        try {
            const resp = await fetch(`${API}?sheet=${routeName}`);
            stops = await resp.json();
            document.getElementById('current-route').innerText = routeName;
            renderStops();
            updateProgress(100);
        } catch (e) { alert("Data Error"); }
        setTimeout(() => showLoading(false), 500);
    }

    function showLoading(show) { document.getElementById('loading-bar-container').style.display = show ? 'block' : 'none'; }
    function updateProgress(val) { document.getElementById('loading-bar').style.width = val + '%'; }

    function renderStops() {
        const list = document.getElementById('stop-list');
        list.innerHTML = "";
        stops.forEach((s, i) => {
            const card = document.createElement('div');
            card.className = "stop-card";
            card.innerHTML = `<b>#${i+1} ${s.Customer || s.company}</b><br><small>${s.Address || s.address}</small>`;
            card.onclick = () => openModal(i);
            list.appendChild(card);
        });
        document.getElementById('stop-count').innerText = stops.length + " Stops";
    }

    // Preservation of existing Signature and Submission logic
    function openModal(idx) {
        activeIdx = idx;
        document.getElementById('mCustName').innerText = stops[idx].Customer || stops[idx].company;
        document.getElementById('dataModal').style.display = 'flex';
        initCanvas();
    }

    function closeModals() { document.getElementById('dataModal').style.display = 'none'; }

    window.onload = () => {
        map = L.map("map").setView([55.17, -118.79], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        loadRouteList();
    };
</script>
</body>
</html>
