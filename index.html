<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Culligan - Force Load Route</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    body { margin:0; height:100vh; display:flex; font-family:'Segoe UI',sans-serif; background:#111; color:white; overflow:hidden;}
    #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column; z-index: 20;}
    #sidebar-header { padding:15px; border-bottom:1px solid #444;}
    .nav-ctrls { display: flex; gap: 5px; padding: 10px; background: #333; border-bottom: 1px solid #444; }
    .nav-btn { flex: 1; padding: 8px; background: #444; border: 1px solid #555; color: white; cursor: pointer; font-weight: bold; border-radius: 4px; }
    #stop-list { flex:1; overflow-y:auto; padding:10px;}
    .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer;}
    #main-view { flex:1; display:flex; flex-direction:column; position: relative;}
    #controls { background:#222; padding:10px; border-bottom:2px solid #0078ff; display: flex; align-items: center; gap: 10px; z-index: 100;}
    #map { flex:1; z-index: 1;}
    .btn-import { padding:10px 20px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;}
    #status { font-size:12px; color:#ffcc00; font-weight: bold; margin-left: auto; padding-right: 10px;}
    .pin { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white; color: white; background:#0078ff;}
</style>
</head>

<body>

<div id="sidebar">
    <div id="list-view">
        <div class="nav-ctrls">
            <button class="nav-btn" onclick="navStop(-1)">← PREV</button>
            <button class="nav-btn" onclick="navStop(1)">NEXT →</button>
        </div>
        <div id="sidebar-header">
            <h3 style="margin:0">Route Stops</h3>
            <p id="stop-count" style="font-size:12px; color:#aaa;">Ready</p>
        </div>
        <div id="stop-list"></div>
    </div>
</div>

<div id="main-view">
    <div id="controls">
        <select id="route-select" style="padding:10px; min-width:250px; background:#333; color:white; border:1px solid #444; border-radius:4px; font-weight:bold;">
            <option value="600570743">VALLEY VIEW</option>
            <option value="423376712">NORTH</option>
            <option value="567832101">DAWSON CREEK</option>
            <option value="0">WEEK 1 MONDAY</option>
            <option value="1285038317">WEEK 1 TUESDAY</option>
            <option value="1547432021">WEEK 1 WEDNESDAY</option>
            <option value="1211029272">WEEK 1 THURSDAY</option>
            <option value="1144026362">WEEK 1 FRIDAY</option>
        </select>
        <button class="btn-import" onclick="forceLoadCSV()">FORCE LOAD</button>
        <div id="status">MODE: CSV_DIRECT</div>
    </div>
    <div id="map"></div>
</div>

<script>
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";
let map = L.map("map").setView([55.1707, -118.7947], 9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let markerLayer = L.layerGroup().addTo(map);
let stops = [], currentIdx = null;

async function forceLoadCSV() {
    const gid = document.getElementById("route-select").value;
    const statusDiv = document.getElementById("status");
    
    statusDiv.innerText = "FORCING DOWNLOAD...";
    stops = []; 
    markerLayer.clearLayers();
    document.getElementById('stop-list').innerHTML = "";

    try {
        // Direct CSV export link - bypasses the Visualization API entirely
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
        
        const res = await fetch(url);
        const data = await res.text();
        
        // Simple CSV parser (assumes Company Name is Column C and Address is Column D)
        const lines = data.split('\n');
        for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // RegEx to handle commas inside quotes
            if (cols.length > 3) {
                const companyName = cols[2]?.replace(/"/g, '').trim();
                const address = cols[3]?.replace(/"/g, '').trim();
                
                if (address && address.length > 5) {
                    const geo = await geocodeArcGIS(address);
                    stops.push({
                        company: companyName || "Unknown",
                        address: address,
                        lat: geo ? geo.lat : 55.1707,
                        lng: geo ? geo.lng : -118.7947
                    });
                }
            }
        }
        
        renderSidebar(); 
        updateMapVisuals();
        
        if (stops.length > 0) {
            const group = new L.featureGroup(markerLayer.getLayers());
            map.fitBounds(group.getBounds().pad(0.1));
            statusDiv.innerText = "FORCE LOADED: " + stops.length;
        } else {
            statusDiv.innerText = "NO DATA FOUND ON TAB";
        }
    } catch (e) { 
        statusDiv.innerText = "DOWNLOAD FAILED";
        console.error(e);
    }
}

async function geocodeArcGIS(addr) {
    try {
        const res = await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(addr)}&maxLocations=1`);
        const data = await res.json();
        return data.candidates.length ? { lat: data.candidates[0].location.y, lng: data.candidates[0].location.x } : null;
    } catch (e) { return null; }
}

function updateMapVisuals() {
    markerLayer.clearLayers();
    stops.forEach((s, i) => {
        L.marker([s.lat, s.lng], { 
            icon: L.divIcon({ className:'', html:`<div class="pin">${i+1}</div>`, iconSize: [26, 26] }) 
        }).addTo(markerLayer);
    });
}

function renderSidebar() {
    const list = document.getElementById("stop-list");
    list.innerHTML = "";
    document.getElementById("stop-count").innerText = `${stops.length} Stops`;
    stops.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = `stop-card`;
        div.innerHTML = `<b>${i+1}. ${s.company}</b><br><small>${s.address}</small>`;
        div.onclick = () => {
            currentIdx = i;
            map.setView([s.lat, s.lng], 14);
        };
        list.appendChild(div);
    });
}

function navStop(dir) {
    if (!stops.length) return;
    if (currentIdx === null) currentIdx = 0;
    else currentIdx = (currentIdx + dir + stops.length) % stops.length;
    const s = stops[currentIdx];
    map.setView([s.lat, s.lng], 14);
}
</script>
</body>
</html>
