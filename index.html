function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const myEmail = Session.getActiveUser().getEmail();
  
  try {
    const data = JSON.parse(e.postData.contents);
    const dateStr = new Date().toLocaleDateString('en-CA');
    
    // 1. LOG TO TRIP REPORT
    const reportName = data.routeName + " - " + dateStr + " Trip Report";
    let sheet = ss.getSheetByName(reportName) || ss.insertSheet(reportName);
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(["Timestamp", "Customer", "Status", "18L Del", "18L Ret", "Sm Del", "Sm Ret", "Cases", "Notes"]);
    }
    sheet.appendRow([new Date(), data.customer, data.status, data.d18, data.r18, data.dSm, data.rSm, data.cs, data.notes]);

    // 2. PDF & EMAIL
    if (data.status === "DELIVERED") {
      const htmlBody = `<div style="font-family:sans-serif; padding:20px; border:2px solid #0078ff; border-radius:10px;">
          <h2 style="color:#0078ff;">Culligan Delivery Receipt</h2>
          <p><b>Customer:</b> ${data.customer}</p>
          <hr>
          <p><b>18L:</b> ${data.d18} Del / ${data.r18} Ret</p>
          <p><b>Small:</b> ${data.dSm} Del / ${data.rSm} Ret</p>
          <p><b>Cases:</b> ${data.cs}</p>
          <br><p><b>Signature:</b></p>
          <img src="${data.sig}" width="300" style="border:1px solid #ccc;">
        </div>`;
      
      const blob = Utilities.newBlob(htmlBody, "text/html", "Receipt.html").getAs("application/pdf");
      blob.setName("Receipt_" + data.customer + "_" + dateStr + ".pdf");

      DriveApp.createFile(blob); // Save to Drive

      // Email Customer
      if (data.customerEmail && data.customerEmail.includes("@")) {
        MailApp.sendEmail({
          to: data.customerEmail,
          subject: "Culligan Receipt - " + data.customer,
          body: "Your delivery receipt is attached.",
          attachments: [blob]
        });
      }
      
      // Email YOU (Confirmation)
      MailApp.sendEmail(myEmail, "CULLIGAN SUCCESS: " + data.customer, "PDF Generated and Saved.");
    }
    return ContentService.createTextOutput("Success").setMimeType(ContentService.MimeType.TEXT);
  } catch (err) {
    return ContentService.createTextOutput("Error: " + err.toString());
  }
}
