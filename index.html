<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Culligan Route - Professional</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { margin:0; height:100vh; display:flex; font-family:'Segoe UI',sans-serif; background:#111; color:white; overflow:hidden;}
        #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column;}
        #sidebar-header { padding:15px; border-bottom:1px solid #444;}
        #stop-list { flex:1; overflow-y:auto; padding:10px;}
        .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer; position: relative;}
        .stop-card.rush-order { border-left-color: #a335ee; background: #331d44; border-left-width: 8px;}
        #customer-profile { display:none; padding:15px; background:#222; overflow-y:auto; height:100%; }
        .profile-group { margin-bottom:12px; }
        .profile-group label { display:block; font-size:11px; color:#0078ff; font-weight:bold; margin-bottom:4px; text-transform: uppercase;}
        .profile-group input, .profile-group textarea { width:100%; padding:8px; background:#333; border:1px solid #444; color:white; border-radius:4px; box-sizing:border-box; }
        #sig-canvas { background:white; border-radius:4px; width:100%; height:150px; touch-action: none; border: 2px solid #555; cursor: crosshair;}
        .form-btns { display:flex; gap:10px; margin-top:20px; padding-bottom: 40px;}
        .btn-del { flex:1; background:#28a745; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold;}
        .btn-not { flex:1; background:#dc3545; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold;}
        .nav-btns { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .nav-btn { background: #444; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;}
        #main-view { flex:1; display:flex; flex-direction:column; position: relative;}
        #controls { background:#222; padding:15px; border-bottom:2px solid #0078ff; display: flex; align-items: center; gap: 10px;}
        #map { flex:1; }
        .btn { padding:10px 15px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;}
        .btn-mgr { background:#6c757d; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer; font-weight:bold;}
        #status { font-size:13px; color:#0078ff; font-weight: bold;}
        .number-pin { color:white; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.5);}
        #manager-panel { position: absolute; bottom: -100%; left: 0; width: 100%; height: 80%; background: #1a1a1a; z-index: 1000; transition: bottom 0.4s ease; border-top: 3px solid #0078ff; }
        #manager-panel.open { bottom: 0; }
        .mgr-tabs { display: flex; background: #222; border-bottom: 1px solid #444; }
        .mgr-tab-btn { padding: 15px 25px; border: none; background: none; color: #aaa; cursor: pointer; font-weight: bold; }
        .mgr-tab-btn.active { color: #0078ff; border-bottom: 2px solid #0078ff; background: #2a2a2a; }
        .mgr-content { padding: 20px; display: none; overflow-y: auto; height: calc(100% - 150px); color: white;}
        .mgr-content.active { display: block; }
        .close-mgr { position: absolute; top: 10px; right: 20px; background: none; border: none; color: #dc3545; font-size: 24px; cursor: pointer; }
        .animated-line { stroke-dasharray: 10, 10; animation: dash 3s linear infinite; }
        @keyframes dash { to { stroke-dashoffset: -100; } }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="list-view">
        <div id="sidebar-header">
            <h3 style="margin:0">Route Stops</h3>
            <p id="stop-count" style="font-size:12px; color:#aaa;">No route loaded</p>
        </div>
        <div id="stop-list"></div>
    </div>
    <div id="customer-profile">
        <div class="nav-btns">
            <button class="nav-btn" onclick="navStop(-1)">← BACK</button>
            <button class="nav-btn" onclick="closeProfile()">CLOSE</button>
            <button class="nav-btn" onclick="navStop(1)">FORWARD →</button>
        </div>
        <h3 id="prof-name">Customer Name</h3>
        <p id="prof-addr" style="font-size:12px; color:#aaa;"></p>
        <div class="profile-group"><label>18L BOTTLES</label><input type="number" id="p-18l" value="0"></div>
        <div class="profile-group"><label>RECEIVED BY</label><input type="text" id="p-rec-by" placeholder="Name"></div>
        <div class="profile-group"><label>NOTES</label><textarea id="p-notes" rows="2"></textarea></div>
        <label style="font-size:11px; color:#0078ff; font-weight:bold;">SIGNATURE</label>
        <canvas id="sig-canvas"></canvas>
        <button onclick="clearSig()" style="width:100%; margin-top:5px; background:#444; color:white; border:none; padding:5px; cursor:pointer; font-size:10px;">CLEAR SIGNATURE</button>
        <div class="form-btns">
            <button class="btn-del" onclick="submitLog('DELIVERED')">DELIVERED</button>
            <button class="btn-not" onclick="submitLog('NOT DELIVERED')">NOT DELIVERED</button>
        </div>
    </div>
</div>

<div id="main-view">
    <div id="controls">
        <select id="route-select">
            <optgroup label="Week 1">
                <option value="917509026">WEEK 1 MONDAY</option>
                <option value="405991289">WEEK 1 TUESDAY</option>
                <option value="405991289">WEEK 1 WEDNESDAY</option>
                <option value="850217841">WEEK 1 THURSDAY</option>
                <option value="524003696">WEEK 1 FRIDAY</option>
            </optgroup>
            <optgroup label="Week 2">
                <option value="1669161107">WEEK 2 MONDAY</option>
                <option value="158782334">WEEK 2 TUESDAY</option>
                <option value="534069449">WEEK 2 WEDNESDAY</option>
                <option value="1664558192">WEEK 2 THURSDAY</option>
                <option value="1943566050">WEEK 2 FRIDAY</option>
            </optgroup>
            <optgroup label="Week 3">
                <option value="922640253">WEEK 3 MONDAY</option>
                <option value="1892780278">WEEK 3 TUESDAY</option>
                <option value="1329388834">WEEK 3 WEDNESDAY</option>
                <option value="692623993">WEEK 3 THURSDAY</option>
                <option value="598312956">WEEK 3 FRIDAY</option>
            </optgroup>
            <optgroup label="Week 4">
                <option value="1528227290">WEEK 4 MONDAY</option>
                <option value="774741269">WEEK 4 TUESDAY</option>
                <option value="1776511227">WEEK 4 WEDNESDAY</option>
                <option value="730189704">WEEK 4 THURSDAY</option>
                <option value="1062369681">WEEK 4 FRIDAY</option>
            </optgroup>
            <optgroup label="Special Routes">
                <option value="458612538">VALLEYVIEW</option>
                <option value="364553460">NORTH</option>
                <option value="1909249906">DAWSON CREEK</option>
                <option value="1773492755">SALT</option>
            </optgroup>
        </select>
        <button class="btn" onclick="loadRoute()">Load Route</button>
        <div id="status">Status: Ready</div>
        <button class="btn-mgr" onclick="toggleManager()" style="margin-left: auto;">Manager Panel</button>
    </div>
    <div id="map"></div>
    <div id="manager-panel">
        <button class="close-mgr" onclick="toggleManager()">&times;</button>
        <div class="mgr-tabs">
            <button class="mgr-tab-btn active">CUSTOMER MAINTENANCE</button>
        </div>
        <div class="mgr-content active">
             <p>Summaries and completions updated in real-time.</p>
        </div>
    </div>
</div>

<script>
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";
let map, markerLayer, polylineLayer, stops = [], currentStopIndex = null;
let canvas, ctx, isDrawing = false;

window.onload = () => {
    map = L.map("map").setView([55.1707, -118.7947], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    markerLayer = L.layerGroup().addTo(map);
    polylineLayer = L.layerGroup().addTo(map);

    canvas = document.getElementById('sig-canvas');
    ctx = canvas.getContext('2d');
    const resize = () => { const rect = canvas.getBoundingClientRect(); canvas.width = rect.width; canvas.height = rect.height; };
    window.addEventListener('resize', resize);
    resize();

    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        return { x: (e.clientX || (e.touches ? e.touches[0].clientX : 0)) - rect.left, y: (e.clientY || (e.touches ? e.touches[0].clientY : 0)) - rect.top };
    };
    const start = (e) => { isDrawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
    const draw = (e) => { if (!isDrawing) return; if (e.cancelable) e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.strokeStyle = "#000"; ctx.lineWidth = 2; ctx.stroke(); };
    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('touchstart', start, {passive: false}); canvas.addEventListener('touchmove', draw, {passive: false}); canvas.addEventListener('touchend', () => isDrawing = false);
};

function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

async function loadRoute() {
    const gid = document.getElementById('route-select').value;
    document.getElementById('status').innerText = "Status: Loading...";
    stops = []; markerLayer.clearLayers(); polylineLayer.clearLayers();
    try {
        const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`);
        const data = await res.text();
        const lines = data.split('\n').slice(1);
        for (let line of lines) {
            const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if (cols[3]) {
                const addr = cols[3].replace(/"/g, '');
                const resGeo = await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(addr)}&maxLocations=1`);
                const geo = await resGeo.json();
                if (geo.candidates.length) {
                    stops.push({
                        company: cols[2].replace(/"/g, ''), address: addr,
                        lat: geo.candidates[0].location.y, lng: geo.candidates[0].location.x,
                        status: 'pending', isRush: cols[0]?.toLowerCase().includes('rush')
                    });
                }
            }
        }
        renderSidebar(); updateMapVisuals();
        document.getElementById('status').innerText = `Status: ${stops.length} Stops`;
    } catch (e) { document.getElementById('status').innerText = "Status: Error"; }
}

function updateMapVisuals() {
    markerLayer.clearLayers(); polylineLayer.clearLayers();
    const activeCoords = [];
    stops.forEach((s, i) => {
        let color = s.status === 'completed' ? '#28a745' : (s.isRush ? '#a335ee' : '#0078ff');
        const m = L.marker([s.lat, s.lng], {
            icon: L.divIcon({ html: `<div class="number-pin" style="background:${color}">${i+1}</div>`, className: '' })
        }).addTo(markerLayer);
        m.bindTooltip(`<b>${s.company}</b><br>${s.address}`);
        m.on('click', () => openProfile(i));
        if (s.status !== 'completed') activeCoords.push([s.lat, s.lng]);
    });
    if (activeCoords.length > 1) {
        L.polyline(activeCoords, { color: '#0078ff', weight: 3, opacity: 0.5, className: 'animated-line' }).addTo(polylineLayer);
    }
}

function renderSidebar() {
    const list = document.getElementById("stop-list"); list.innerHTML = "";
    stops.forEach((s, i) => {
        const d = document.createElement("div");
        d.className = `stop-card ${s.isRush ? 'rush-order' : ''}`;
        if (s.status === 'completed') d.style.opacity = "0.4";
        d.innerHTML = `<b>${i+1}. ${s.company}</b><br><small>${s.address}</small>`;
        d.onclick = () => openProfile(i);
        list.appendChild(d);
    });
}

function openProfile(i) {
    currentStopIndex = i;
    document.getElementById('list-view').style.display = 'none';
    document.getElementById('customer-profile').style.display = 'block';
    document.getElementById('prof-name').innerText = stops[i].company;
    document.getElementById('prof-addr').innerText = stops[i].address;
    clearSig(); map.setView([stops[i].lat, stops[i].lng], 16);
}

function closeProfile() { document.getElementById('list-view').style.display = 'block'; document.getElementById('customer-profile').style.display = 'none'; }
function navStop(dir) { let n = currentStopIndex + dir; if (n >= 0 && n < stops.length) openProfile(n); }

async function submitLog(val) {
    const s = stops[currentStopIndex];
    if (val === 'DELIVERED') s.status = 'completed';
    const doc = new jspdf.jsPDF();
    doc.text(`Log: ${s.company}\nStatus: ${val}`, 20, 20);
    doc.addImage(canvas.toDataURL("image/png"), 'PNG', 20, 50, 60, 30);
    try {
        const pdfBlob = doc.output('blob');
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify({name: `${s.company}_Log.pdf`, mimeType: 'application/pdf'})], {type: 'application/json'}));
        form.append('file', pdfBlob);
        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST', headers: {'Authorization': 'Bearer ' + gapi.auth.getToken().access_token}, body: form
        });
    } catch (e) { doc.save(`${s.company}_Log.pdf`); }
    updateMapVisuals(); renderSidebar(); closeProfile();
}

function toggleManager() { document.getElementById('manager-panel').classList.toggle('open'); }
</script>
</body>
</html>
