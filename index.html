<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Culligan Route - Driver View</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    body { margin:0; height:100vh; display:flex; font-family:'Segoe UI',sans-serif; background:#111; color:white; overflow:hidden;}
    #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column; z-index: 20;}
    #sidebar-header { padding:15px; border-bottom:1px solid #444;}
    .nav-ctrls { display: flex; gap: 5px; padding: 10px; background: #333; border-bottom: 1px solid #444; }
    .nav-btn { flex: 1; padding: 8px; background: #444; border: 1px solid #555; color: white; cursor: pointer; font-weight: bold; border-radius: 4px; }
    #stop-list { flex:1; overflow-y:auto; padding:10px;}
    .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer;}
    .stop-card.done { border-left-color: #28a745; opacity: 0.8; }
    #main-view { flex:1; display:flex; flex-direction:column; position: relative;}
    #controls { background:#222; padding:10px; border-bottom:2px solid #0078ff; display: flex; flex-wrap: nowrap; align-items: center; gap: 8px; z-index: 100;}
    #map { flex:1; z-index: 1;}
    .btn-import { padding:10px 15px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold; white-space: nowrap;}
    .btn-scan { background:#0078ff; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer; font-weight:bold; white-space: nowrap;}
    #status { font-size:12px; color:#0078ff; font-weight: bold; margin-left: auto; padding-right: 10px;}
    .pin { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white; color: white; background:#0078ff;}
    #customer-profile { display:none; padding:15px; background:#222; height: 100%; overflow-y: auto;}
</style>
</head>

<body>

<div id="sidebar">
    <div class="nav-ctrls">
        <button class="nav-btn" onclick="navStop(-1)">← BACK</button>
        <button class="nav-btn" onclick="navStop(1)">FORWARD →</button>
    </div>
    <div id="list-view">
        <div id="sidebar-header">
            <h3 style="margin:0">Route Stops</h3>
            <p id="stop-count" style="font-size:12px; color:#aaa;">Ready</p>
        </div>
        <div id="stop-list"></div>
    </div>
    <div id="customer-profile">
        <button onclick="closeProfile()" style="background:none; border:none; color:#0078ff; cursor:pointer; margin-bottom:10px;">← BACK TO LIST</button>
        <h3 id="prof-name"></h3>
        <p id="prof-addr" style="font-size:12px; color:#aaa; margin-bottom:15px;"></p>
        <button onclick="markStop('delivered')" style="background:#28a745; color:white; padding:12px; border:none; border-radius:4px; cursor:pointer; width:100%;">COMPLETE STOP</button>
    </div>
</div>

<div id="main-view">
    <div id="controls">
        <button class="btn-scan" onclick="initRoutes()">LOAD ALL ROUTES</button>
        <select id="route-select" style="padding:10px; min-width:200px; background:#333; color:white; border:1px solid #444; border-radius:4px;">
            <option value="">-- Select Route --</option>
        </select>
        <button class="btn-import" onclick="loadData()">IMPORT</button>
        <div id="status">STATUS: READY</div>
    </div>
    <div id="map"></div>
</div>

<script>
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";
// HIDDEN DATA TABLE
const routeData = [
    { name: "VALLEY VIEW", gid: "600570743" },
    { name: "NORTH", gid: "423376712" },
    { name: "DAWSON CREEK", gid: "567832101" },
    { name: "WEEK 1 MONDAY", gid: "0" },
    { name: "WEEK 1 TUESDAY", gid: "1285038317" },
    { name: "WEEK 1 WEDNESDAY", gid: "1547432021" },
    { name: "WEEK 1 THURSDAY", gid: "1211029272" },
    { name: "WEEK 1 FRIDAY", gid: "1144026362" },
    { name: "WEEK 2 MONDAY", gid: "1090629633" },
    { name: "WEEK 2 TUESDAY", gid: "1855644723" },
    { name: "WEEK 2 WEDNESDAY", gid: "103991206" },
    { name: "WEEK 2 THURSDAY", gid: "1750530747" },
    { name: "WEEK 2 FRIDAY", gid: "1561081699" },
    { name: "WEEK 3 MONDAY", gid: "1173641214" },
    { name: "WEEK 3 TUESDAY", gid: "1382442220" },
    { name: "WEEK 3 WEDNESDAY", gid: "1410444322" },
    { name: "WEEK 3 THURSDAY", gid: "1119420011" },
    { name: "WEEK 3 FRIDAY", gid: "1904422332" },
    { name: "WEEK 4 MONDAY", gid: "1122334455" },
    { name: "WEEK 4 TUESDAY", gid: "1122334466" },
    { name: "WEEK 4 WEDNESDAY", gid: "1122334477" },
    { name: "WEEK 4 THURSDAY", gid: "1122334488" },
    { name: "WEEK 4 FRIDAY", gid: "1122334499" }
];

let map = L.map("map").setView([55.1707, -118.7947], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let markerLayer = L.layerGroup().addTo(map);
let stops = [], currentIdx = null;

function initRoutes() {
    const select = document.getElementById("route-select");
    select.innerHTML = '<option value="">-- Select Route --</option>';
    routeData.forEach(r => {
        let opt = document.createElement("option");
        opt.value = r.gid; // Computer sees GID
        opt.text = r.name;  // Driver sees Name
        select.appendChild(opt);
    });
    document.getElementById("status").innerText = "ROUTES LOADED";
}

async function loadData() {
    const gid = document.getElementById("route-select").value;
    if(!gid) return;
    
    document.getElementById("status").innerText = "IMPORTING...";
    stops = []; markerLayer.clearLayers();
    document.getElementById('stop-list').innerHTML = "";

    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}&t=${Date.now()}`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf("(") + 1, text.lastIndexOf(")")));
        const rows = json.table.rows;
        
        for (let i = 0; i < rows.length; i++) {
            const cols = rows[i].c;
            if (cols && cols[3] && cols[3].v) {
                const geo = await geocodeArcGIS(cols[3].v);
                stops.push({
                    company: cols[2] ? cols[2].v : "Customer", 
                    address: cols[3].v, 
                    lat: geo ? geo.lat : 55.1707, 
                    lng: geo ? geo.lng : -118.7947,
                    status: 'pending'
                });
            }
        }
        renderSidebar(); updateMapVisuals();
        document.getElementById("status").innerText = "SUCCESS";
    } catch (e) { document.getElementById("status").innerText = "ERROR"; }
}

async function geocodeArcGIS(addr) {
    const res = await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(addr)}&maxLocations=1`);
    const data = await res.json();
    return data.candidates.length ? { lat: data.candidates[0].location.y, lng: data.candidates[0].location.x } : null;
}

function updateMapVisuals() {
    markerLayer.clearLayers();
    stops.forEach((s, i) => {
        let pinClass = s.status === 'delivered' ? 'background:#28a745;' : 'background:#0078ff;';
        L.marker([s.lat, s.lng], { 
            icon: L.divIcon({ className:'', html:`<div class="pin" style="${pinClass}">${i+1}</div>`, iconSize: [26, 26] }) 
        }).addTo(markerLayer);
    });
}

function renderSidebar() {
    const list = document.getElementById("stop-list");
    list.innerHTML = "";
    document.getElementById("stop-count").innerText = `${stops.length} Stops`;
    stops.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = `stop-card ${s.status === 'delivered' ? 'done' : ''}`;
        div.style.opacity = s.status === 'delivered' ? '0.5' : '1';
        div.innerHTML = `<b>${i+1}. ${s.company}</b><br><small>${s.address}</small>`;
        div.onclick = () => openProfile(i);
        list.appendChild(div);
    });
}

function openProfile(i) {
    currentIdx = i; const s = stops[i];
    document.getElementById('list-view').style.display = 'none';
    document.getElementById('customer-profile').style.display = 'block';
    document.getElementById('prof-name').innerText = s.company;
    document.getElementById('prof-addr').innerText = s.address;
    map.setView([s.lat, s.lng], 15);
}

function closeProfile() {
    document.getElementById('list-view').style.display = 'block';
    document.getElementById('customer-profile').style.display = 'none';
}

function markStop(status) {
    stops[currentIdx].status = 'delivered';
    renderSidebar(); updateMapVisuals(); closeProfile();
}

function navStop(dir) {
    if (!stops.length) return;
    let nIdx = (currentIdx === null) ? 0 : currentIdx + dir;
    if (nIdx < 0) nIdx = stops.length - 1;
    if (nIdx >= stops.length) nIdx = 0;
    openProfile(nIdx);
}
</script>
</body>
</html>
