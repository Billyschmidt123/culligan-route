<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Culligan Route Manager Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary: #0078ff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --rush: #a335ee;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #111; color: white; overflow: hidden; height: 100vh; }
        .app-container { display: flex; height: 100vh; }
        #sidebar { width: 380px; background: #222; border-right: 2px solid var(--primary); display: flex; flex-direction: column; z-index: 100; }
        #sidebar-header { padding: 20px; border-bottom: 1px solid #444; background: linear-gradient(135deg, #1a1a1a 0%, #222 100%); }
        #sidebar-header h3 { margin: 0 0 10px 0; color: var(--primary); font-size: 1.5rem; }
        #stop-count { font-size: 13px; color: #aaa; }
        #stop-list { flex: 1; overflow-y: auto; padding: 15px; }
        .stop-card { background: #2a2a2a; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--primary); cursor: pointer; transition: all 0.3s; }
        .stop-card:hover { background: #333; transform: translateX(5px); }
        .stop-card:active { transform: scale(0.98); }
        .stop-card.completed { opacity: 0.6; border-left-color: var(--success); }
        .stop-card.rush-order { border-left-color: var(--rush); background: #331d44; border-left-width: 8px; }
        #customer-profile { display: none; padding: 20px; background: #222; overflow-y: auto; height: 100%; }
        .back-btn { background: #444; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 20px; width: 100%; transition: all 0.3s; }
        .back-btn:hover { background: #555; }
        .profile-group { margin-bottom: 15px; }
        .profile-group label { display: block; font-size: 11px; color: var(--primary); font-weight: bold; margin-bottom: 6px; text-transform: uppercase; }
        .profile-group input, .profile-group textarea { width: 100%; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 6px; font-size: 14px; }
        .profile-group input:focus, .profile-group textarea:focus { outline: none; border-color: var(--primary); }
        #sig-canvas { background: white; border-radius: 6px; width: 100%; height: 180px; touch-action: none; border: 2px solid #555; cursor: crosshair; display: block; }
        .btn-clear-sig { width: 100%; background: #6c757d; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin: 10px 0 20px 0; font-weight: bold; }
        .form-btns { display: flex; gap: 12px; margin-top: 25px; padding-bottom: 40px; }
        .btn-del, .btn-not { flex: 1; border: none; padding: 16px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 15px; transition: all 0.3s; }
        .btn-del { background: linear-gradient(135deg, var(--success) 0%, #1e7e34 100%); }
        .btn-del:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4); }
        .btn-not { background: linear-gradient(135deg, var(--danger) 0%, #bd2130 100%); }
        .btn-not:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4); }
        #main-view { flex: 1; display: flex; flex-direction: column; position: relative; }
        #controls { background: #222; padding: 20px; border-bottom: 2px solid var(--primary); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        #route-select { flex: 1; min-width: 200px; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 6px; font-size: 14px; cursor: pointer; }
        #map { flex: 1; background: #1a1a1a; }
        .btn { padding: 12px 20px; background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; white-space: nowrap; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 120, 255, 0.4); }
        .btn-mgr { background: #6c757d; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #status { font-size: 14px; color: var(--primary); font-weight: bold; padding: 8px 15px; background: rgba(0, 120, 255, 0.1); border-radius: 6px; }
        .number-pin { background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-size: 14px; }
        .rush-pin { background: var(--rush) !important; }
        .completed-pin { background: var(--success) !important; }
        #manager-panel { position: absolute; bottom: -100%; left: 0; width: 100%; height: 85%; background: #1a1a1a; z-index: 1000; transition: bottom 0.4s; border-top: 3px solid var(--primary); box-shadow: 0 -4px 20px rgba(0,0,0,0.5); }
        #manager-panel.open { bottom: 0; }
        .mgr-tabs { display: flex; background: #222; border-bottom: 1px solid #444; overflow-x: auto; }
        .mgr-tab-btn { padding: 18px 30px; border: none; background: none; color: #aaa; cursor: pointer; font-weight: bold; white-space: nowrap; transition: all 0.3s; }
        .mgr-tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #2a2a2a; }
        .mgr-content { padding: 25px; display: none; overflow-y: auto; height: calc(100% - 70px); }
        .mgr-content.active { display: block; }
        .close-mgr { position: absolute; top: 15px; right: 25px; background: none; border: none; color: var(--danger); font-size: 32px; cursor: pointer; z-index: 10; width: 40px; height: 40px; }
        .toast { position: fixed; top: 20px; right: 20px; background: #222; border: 2px solid var(--success); padding: 15px 25px; border-radius: 8px; z-index: 3000; opacity: 0; transform: translateX(400px); transition: all 0.3s; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.error { border-color: var(--danger); }
        .toast.warning { border-color: var(--warning); }
        .mobile-menu-btn { display: none; position: fixed; top: 20px; left: 20px; z-index: 150; background: var(--primary); color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        @media (max-width: 1024px) {
            .mobile-menu-btn { display: block; }
            #sidebar { position: absolute; width: 100%; max-width: 400px; height: 100%; z-index: 200; transform: translateX(-100%); transition: transform 0.3s; }
            #sidebar.open { transform: translateX(0); }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }
    </style>
</head>
<body>
<button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

<div class="app-container">
    <div id="sidebar">
        <div id="list-view">
            <div id="sidebar-header">
                <h3>üöö Route Stops</h3>
                <p id="stop-count">No route loaded</p>
            </div>
            <div id="stop-list"></div>
        </div>
        <div id="customer-profile">
            <button class="back-btn" onclick="closeProfile()">‚Üê BACK TO LIST</button>
            <h3 id="prof-name" style="color: var(--primary); margin-bottom: 5px;">Customer</h3>
            <p id="prof-addr" style="font-size: 13px; color: #aaa; margin-bottom: 25px;"></p>
            <div class="profile-group"><label>18L BOTTLES</label><input type="number" id="p-18l" value="0" min="0"></div>
            <div class="profile-group"><label>SMALL BOTTLES</label><input type="number" id="p-small" value="0" min="0"></div>
            <div class="profile-group"><label>18L RETURNS</label><input type="number" id="p-18l-ret" value="0" min="0"></div>
            <div class="profile-group"><label>CASES</label><input type="number" id="p-cases" value="0" min="0"></div>
            <div class="profile-group"><label>SMALL RETURNS</label><input type="number" id="p-small-ret" value="0" min="0"></div>
            <div class="profile-group"><label>RECEIVED BY</label><input type="text" id="p-rec-by" placeholder="Name"></div>
            <div class="profile-group"><label>CUSTOMER EMAIL</label><input type="email" id="p-email" placeholder="customer@email.com"></div>
            <div class="profile-group"><label>CUSTOMER PHONE</label><input type="tel" id="p-phone" placeholder="(555) 123-4567"></div>
            <div class="profile-group"><label>NOTES</label><textarea id="p-notes" rows="3" placeholder="Delivery instructions..."></textarea></div>
            <label style="font-size: 11px; color: var(--primary); font-weight: bold; margin: 20px 0 10px 0; display: block;">CUSTOMER SIGNATURE</label>
            <canvas id="sig-canvas"></canvas>
            <button class="btn-clear-sig" onclick="clearSignature()">Clear Signature</button>
            <div class="form-btns">
                <button class="btn-del" onclick="submitLog('DELIVERED')">‚úì DELIVERED</button>
                <button class="btn-not" onclick="submitLog('NOT DELIVERED')">‚úó NOT HOME</button>
            </div>
        </div>
    </div>
    <div id="main-view">
        <div id="controls">
            <select id="route-select">
                <optgroup label="Week 1">
                    <option value="917509026">WEEK 1 MONDAY</option>
                    <option value="405991289">WEEK 1 TUESDAY</option>
                    <option value="405991289">WEEK 1 WEDNESDAY</option>
                    <option value="850217841">WEEK 1 THURSDAY</option>
                    <option value="524003696">WEEK 1 FRIDAY</option>
                </optgroup>
                <optgroup label="Week 2">
                    <option value="1669161107">WEEK 2 MONDAY</option>
                    <option value="158782334">WEEK 2 TUESDAY</option>
                    <option value="534069449">WEEK 2 WEDNESDAY</option>
                    <option value="1664558192">WEEK 2 THURSDAY</option>
                    <option value="1943566050">WEEK 2 FRIDAY</option>
                </optgroup>
                <optgroup label="Week 3">
                    <option value="922640253">WEEK 3 MONDAY</option>
                    <option value="1892780278">WEEK 3 TUESDAY</option>
                    <option value="1329388834">WEEK 3 WEDNESDAY</option>
                    <option value="692623993">WEEK 3 THURSDAY</option>
                    <option value="598312956">WEEK 3 FRIDAY</option>
                </optgroup>
                <optgroup label="Week 4">
                    <option value="1528227290">WEEK 4 MONDAY</option>
                    <option value="774741269">WEEK 4 TUESDAY</option>
                    <option value="1776511227">WEEK 4 WEDNESDAY</option>
                    <option value="730189704">WEEK 4 THURSDAY</option>
                    <option value="1062369681">WEEK 4 FRIDAY</option>
                </optgroup>
                <optgroup label="Special Routes">
                    <option value="458612538">VALLEYVIEW</option>
                    <option value="364553460">NORTH</option>
                    <option value="1909249906">DAWSON CREEK</option>
                    <option value="1773492755">SALT</option>
                </optgroup>
                <optgroup label="üìÅ Uploaded Routes" id="uploaded-routes-group"></optgroup>
            </select>
            <button class="btn" onclick="loadRoute()">üìç Load Route</button>
            <label for="file-upload" class="btn" style="margin: 0; cursor: pointer;">üìÅ Upload File</label>
            <input type="file" id="file-upload" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
            <div id="status">Ready</div>
            <button class="btn-mgr" onclick="toggleManager()" style="margin-left: auto;">‚öôÔ∏è Manager</button>
        </div>
        <div id="map"></div>
        <div id="manager-panel">
            <button class="close-mgr" onclick="toggleManager()">&times;</button>
            <div class="mgr-tabs">
                <button class="mgr-tab-btn active" onclick="switchTab(event, 'reports')">DAILY SUMMARY</button>
                <button class="mgr-tab-btn" onclick="switchTab(event, 'export')">EXPORT PDF</button>
                <button class="mgr-tab-btn" onclick="switchTab(event, 'storage')">FILE STORAGE</button>
            </div>
            <div id="reports" class="mgr-content active">
                <h3 style="color: var(--primary); margin-bottom: 20px;">üìä Daily Route Summary</h3>
                <div id="summary-data" style="background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444;">
                    <p style="color: #777; text-align: center; padding: 20px;">Load a route to see summary</p>
                </div>
            </div>
            <div id="export" class="mgr-content">
                <h3 style="color: var(--primary); margin-bottom: 20px;">üìÑ Export & Email</h3>
                <div style="background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444;">
                    
                    <div class="profile-group">
                        <label>üìß Email Delivery Receipt</label>
                        <input type="email" id="customer-email" placeholder="customer@email.com">
                        <small style="color: #aaa; font-size: 11px; display: block; margin-top: 5px;">
                            Email the PDF receipt to the customer
                        </small>
                    </div>
                    
                    <button class="btn" style="width: 100%; margin-top: 15px;" onclick="emailPDF()">
                        üìß Email PDF to Customer
                    </button>
                    
                    <div style="border-top: 1px solid #444; margin: 20px 0; padding-top: 20px;">
                        <label style="display: block; font-size: 11px; color: var(--primary); font-weight: bold; margin-bottom: 10px;">
                            üíæ DOWNLOAD OPTIONS
                        </label>
                        <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="downloadPDF()">
                            üìÑ Download PDF Receipt
                        </button>
                        <button class="btn" style="width: 100%; background: #4285f4;" onclick="saveToGoogleDrive()">
                            üìÅ Save to Google Drive
                        </button>
                    </div>
                    
                    <div style="border-top: 1px solid #444; margin: 20px 0; padding-top: 20px;">
                        <label style="display: block; font-size: 11px; color: var(--primary); font-weight: bold; margin-bottom: 10px;">
                            üìä EXPORT ALL DELIVERIES
                        </label>
                        <button class="btn" style="width: 100%; margin-bottom: 10px; background: var(--success);" onclick="exportToCSV()">
                            üìä Export Daily Summary (CSV)
                        </button>
                        <p style="font-size: 11px; color: #777; text-align: center; margin-top: 10px;">
                            Export all today's deliveries to spreadsheet
                        </p>
                    </div>
                    
                    <div id="email-status" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none; text-align: center;">
                    </div>
                </div>
            </div>
            <div id="storage" class="mgr-content">
                <h3 style="color: var(--primary); margin-bottom: 20px;">üíæ File Storage Manager</h3>
                <div style="background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #aaa; margin: 0;">Your Uploaded Routes:</h4>
                        <button class="btn" onclick="clearAllRoutes()" style="background: var(--danger); padding: 8px 16px; font-size: 12px;">üóëÔ∏è Clear All</button>
                    </div>
                    <div id="uploaded-files-list" style="margin-bottom: 20px;"></div>
                    <button class="btn" style="width: 100%;" onclick="document.getElementById('file-upload').click()">üìÅ Upload New Route File</button>
                    <p style="font-size: 12px; color: #777; margin-top: 10px; text-align: center;">Supported: CSV, Excel (.xlsx, .xls)</p>
                    <p style="font-size: 11px; color: #555; margin-top: 5px; text-align: center;">Files are stored in your browser's local storage</p>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="toast" id="toast"></div>

<!-- Load libraries synchronously -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";
const STORAGE_KEY = "culligan_route_data";
const FILES_KEY = "culligan_uploaded_files";
let map, markerLayer, stops = [], currentStopIndex = null, deliveryLogs = [];
let sigCanvas, sigCtx, isDrawing = false;
let uploadedFiles = {};
let librariesLoaded = false;

// Wait for page to fully load
window.addEventListener('load', function() {
    console.log('Page loaded, checking libraries...');
    let attempts = 0;
    const maxAttempts = 50;
    
    const checkInterval = setInterval(() => {
        attempts++;
        
        if (typeof L !== 'undefined' && typeof XLSX !== 'undefined') {
            console.log('‚úì All libraries loaded successfully!');
            clearInterval(checkInterval);
            librariesLoaded = true;
            initApp();
        } else if (attempts >= maxAttempts) {
            console.error('Libraries failed to load after', attempts, 'attempts');
            console.error('L:', typeof L, 'XLSX:', typeof XLSX);
            clearInterval(checkInterval);
            showToast('Failed to load required libraries. Please refresh the page.', 'error');
        } else {
            if (attempts % 5 === 0) {
                console.log('Attempt', attempts, '- L:', typeof L, 'XLSX:', typeof XLSX);
            }
        }
    }, 200);
});

function initApp() {
    console.log('Initializing app...');
    initMap();
    initSignaturePad();
    loadStoredData();
    loadUploadedFiles();
    updateUploadedRoutesDropdown();
    updateStorageManager();
    console.log('App initialized successfully!');
}

function initMap() {
    map = L.map("map").setView([55.1707, -118.7947], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '¬© OpenStreetMap',
        maxZoom: 19
    }).addTo(map);
    markerLayer = L.layerGroup().addTo(map);
}

function initSignaturePad() {
    sigCanvas = document.getElementById('sig-canvas');
    sigCtx = sigCanvas.getContext('2d');
    const rect = sigCanvas.getBoundingClientRect();
    sigCanvas.width = rect.width;
    sigCanvas.height = rect.height;
    sigCtx.strokeStyle = '#000';
    sigCtx.lineWidth = 2;
    sigCtx.lineCap = 'round';
    
    sigCanvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        isDrawing = true;
        const touch = e.touches[0];
        const r = sigCanvas.getBoundingClientRect();
        sigCtx.beginPath();
        sigCtx.moveTo(touch.clientX - r.left, touch.clientY - r.top);
    }, { passive: false });
    
    sigCanvas.addEventListener('touchmove', function(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const touch = e.touches[0];
        const r = sigCanvas.getBoundingClientRect();
        sigCtx.lineTo(touch.clientX - r.left, touch.clientY - r.top);
        sigCtx.stroke();
    }, { passive: false });
    
    sigCanvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        isDrawing = false;
    });
    
    sigCanvas.addEventListener('mousedown', function(e) {
        isDrawing = true;
        const r = sigCanvas.getBoundingClientRect();
        sigCtx.beginPath();
        sigCtx.moveTo(e.clientX - r.left, e.clientY - r.top);
    });
    
    sigCanvas.addEventListener('mousemove', function(e) {
        if (!isDrawing) return;
        const r = sigCanvas.getBoundingClientRect();
        sigCtx.lineTo(e.clientX - r.left, e.clientY - r.top);
        sigCtx.stroke();
    });
    
    sigCanvas.addEventListener('mouseup', () => isDrawing = false);
    sigCanvas.addEventListener('mouseleave', () => isDrawing = false);
}

function clearSignature() {
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    showToast('Signature cleared', 'warning');
}

async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    showToast('Processing file...', 'success');
    try {
        let data;
        if (file.name.endsWith('.csv')) {
            const text = await file.text();
            data = parseCSV(text);
        } else {
            const buffer = await file.arrayBuffer();
            const workbook = XLSX.read(buffer, { type: 'array' });
            data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        }
        const fileName = file.name.replace(/\.[^/.]+$/, "");
        const fileId = Date.now().toString();
        uploadedFiles[fileId] = { name: fileName, data: data, uploadDate: new Date().toISOString() };
        saveUploadedFiles();
        updateUploadedRoutesDropdown();
        updateStorageManager();
        showToast(`${fileName} uploaded!`, 'success');
        event.target.value = '';
    } catch (e) {
        showToast('Failed to process file', 'error');
    }
}

function parseCSV(text) {
    const lines = text.split('\n').filter(l => l.trim());
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
        const obj = {};
        headers.forEach((h, idx) => obj[h] = values[idx] ? values[idx].replace(/"/g, '').trim() : '');
        data.push(obj);
    }
    return data;
}

function updateUploadedRoutesDropdown() {
    const group = document.getElementById('uploaded-routes-group');
    group.innerHTML = '';
    Object.entries(uploadedFiles).forEach(([id, file]) => {
        const opt = document.createElement('option');
        opt.value = `uploaded:${id}`;
        opt.textContent = `üìÅ ${file.name}`;
        group.appendChild(opt);
    });
}

function updateStorageManager() {
    const div = document.getElementById('uploaded-files-list');
    if (Object.keys(uploadedFiles).length === 0) {
        div.innerHTML = '<p style="color: #777; text-align: center; padding: 20px;">No files uploaded yet</p>';
        return;
    }
    div.innerHTML = Object.entries(uploadedFiles).map(([id, f]) => `
        <div style="background: #2a2a2a; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div><strong style="color: white;">${f.name}</strong><br><small style="color: #aaa;">${new Date(f.uploadDate).toLocaleDateString()} ‚Ä¢ ${f.data.length} stops</small></div>
            <button class="btn" onclick="deleteUploadedFile('${id}')" style="background: var(--danger); padding: 8px 12px;">üóëÔ∏è</button>
        </div>
    `).join('');
}

function deleteUploadedFile(id) {
    if (confirm('Delete this route file?')) {
        delete uploadedFiles[id];
        saveUploadedFiles();
        updateUploadedRoutesDropdown();
        updateStorageManager();
        showToast('File deleted', 'error');
    }
}

function clearAllRoutes() {
    if (confirm('Delete ALL uploaded route files? This cannot be undone!')) {
        uploadedFiles = {};
        saveUploadedFiles();
        updateUploadedRoutesDropdown();
        updateStorageManager();
        showToast('All uploaded routes cleared', 'warning');
    }
}

function saveUploadedFiles() {
    try { localStorage.setItem(FILES_KEY, JSON.stringify(uploadedFiles)); } catch (e) { showToast('Storage full', 'error'); }
}

function loadUploadedFiles() {
    try {
        const stored = localStorage.getItem(FILES_KEY);
        if (stored) uploadedFiles = JSON.parse(stored);
    } catch (e) {}
}

async function loadRoute() {
    const val = document.getElementById('route-select').value;
    const status = document.getElementById('status');
    
    console.log('Loading route with GID:', val);
    
    if (!val) {
        showToast('Please select a route first', 'warning');
        return;
    }
    
    stops = [];
    deliveryLogs = [];
    markerLayer.clearLayers();
    document.getElementById('stop-list').innerHTML = "";
    status.innerText = "Loading...";
    
    try {
        let data;
        if (val.startsWith('uploaded:')) {
            const fileId = val.replace('uploaded:', '');
            console.log('Loading uploaded file:', fileId);
            data = uploadedFiles[fileId].data;
            await processRouteData(data);
            showToast(`Loaded ${stops.length} stops from file`, 'success');
        } else {
            console.log('Loading from Google Sheets, GID:', val);
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${val}&t=${Date.now()}`;
            console.log('Fetching URL:', url);
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            
            const text = await res.text();
            console.log('Received data, length:', text.length);
            
            const parsed = [];
            const lines = text.split('\n');
            console.log('Total lines:', lines.length);
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                
                const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (cols.length > 3) {
                    const company = cols[2]?.replace(/"/g, '').trim();
                    const address = cols[3]?.replace(/"/g, '').trim();
                    if (address && address.length > 5) {
                        parsed.push({ Company: company, Address: address });
                    }
                }
            }
            
            console.log('Parsed entries:', parsed.length);
            await processRouteData(parsed);
            showToast(`Loaded ${stops.length} stops from Google Sheets`, 'success');
        }
        
        renderSidebar();
        renderRoute();
        saveToStorage();
        
        if (stops.length > 0) {
            const g = new L.featureGroup(markerLayer.getLayers());
            map.fitBounds(g.getBounds().pad(0.1));
            status.innerText = `‚úì ${stops.length} stops`;
            document.getElementById('stop-count').innerText = `${stops.length} Stops`;
            updateDailySummary();
        } else {
            status.innerText = "‚ö† No stops found";
            showToast('No valid addresses found in this sheet', 'warning');
        }
    } catch (e) {
        console.error('Load route error:', e);
        status.innerText = "‚úó Failed";
        showToast('Failed to load route: ' + e.message, 'error');
    }
}

async function processRouteData(data) {
    for (let i = 0; i < data.length; i++) {
        const r = data[i];
        const company = r.Company || r.company || r.Name || r.name || r.Customer || `Stop ${i+1}`;
        const address = r.Address || r.address || r.ADDRESS || '';
        const email = r.Email || r.email || r.EMAIL || '';
        const phone = r.Phone || r.phone || r.PHONE || r.Tel || r.tel || '';
        
        if (address && address.length > 5) {
            const geo = await geocodeArcGIS(address);
            stops.push({ 
                id: Date.now() + i, 
                company, 
                address, 
                email: email,
                phone: phone,
                lat: geo ? geo.lat : 55.1707, 
                lng: geo ? geo.lng : -118.7947, 
                completed: false, 
                deliveryData: null 
            });
            await new Promise(r => setTimeout(r, 100));
        }
    }
}

async function geocodeArcGIS(addr) {
    try {
        const res = await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(addr)}&maxLocations=1`);
        const data = await res.json();
        return data.candidates.length ? { lat: data.candidates[0].location.y, lng: data.candidates[0].location.x } : null;
    } catch (e) { return null; }
}

function renderRoute() {
    markerLayer.clearLayers();
    stops.forEach((s, i) => {
        L.marker([s.lat, s.lng], { 
            icon: L.divIcon({ className: 'custom-div-icon', html: `<div class="number-pin ${s.completed ? 'completed-pin' : ''}">${i+1}</div>` }) 
        }).addTo(markerLayer).bindPopup(`<strong>${s.company}</strong><br><small>${s.address}</small>`);
    });
}

function renderSidebar() {
    const list = document.getElementById("stop-list");
    list.innerHTML = "";
    stops.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = `stop-card ${s.completed ? 'completed' : ''}`;
        div.innerHTML = `<strong style="font-size: 15px;">${i+1}. ${s.company}</strong><br><small style="color: #aaa;">${s.address}</small>${s.completed ? '<br><small style="color: var(--success); font-weight: bold;">‚úì COMPLETED</small>' : ''}`;
        div.onclick = () => openProfile(i);
        list.appendChild(div);
    });
}

function openProfile(i) {
    currentStopIndex = i;
    const s = stops[i];
    document.getElementById('list-view').style.display = 'none';
    document.getElementById('customer-profile').style.display = 'block';
    document.getElementById('prof-name').innerText = s.company;
    document.getElementById('prof-addr').innerText = s.address;
    
    setTimeout(() => {
        const canvas = document.getElementById('sig-canvas');
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        sigCtx = canvas.getContext('2d');
        sigCtx.strokeStyle = '#000';
        sigCtx.lineWidth = 2;
        sigCtx.lineCap = 'round';
    }, 100);
    
    if (s.deliveryData) {
        document.getElementById('p-18l').value = s.deliveryData.bottles18L || 0;
        document.getElementById('p-small').value = s.deliveryData.smallBottles || 0;
        document.getElementById('p-18l-ret').value = s.deliveryData.returns18L || 0;
        document.getElementById('p-cases').value = s.deliveryData.cases || 0;
        document.getElementById('p-small-ret').value = s.deliveryData.smallReturns || 0;
        document.getElementById('p-rec-by').value = s.deliveryData.receivedBy || '';
        document.getElementById('p-email').value = s.deliveryData.email || s.email || '';
        document.getElementById('p-phone').value = s.deliveryData.phone || s.phone || '';
        document.getElementById('p-notes').value = s.deliveryData.notes || '';
    } else {
        document.getElementById('p-18l').value = 0;
        document.getElementById('p-small').value = 0;
        document.getElementById('p-18l-ret').value = 0;
        document.getElementById('p-cases').value = 0;
        document.getElementById('p-small-ret').value = 0;
        document.getElementById('p-rec-by').value = '';
        document.getElementById('p-email').value = s.email || '';
        document.getElementById('p-phone').value = s.phone || '';
        document.getElementById('p-notes').value = '';
        clearSignature();
    }
    map.setView([s.lat, s.lng], 16);
}

function closeProfile() {
    document.getElementById('list-view').style.display = 'block';
    document.getElementById('customer-profile').style.display = 'none';
}

function submitLog(status) {
    if (currentStopIndex === null) return;
    const s = stops[currentStopIndex];
    s.deliveryData = {
        bottles18L: parseInt(document.getElementById('p-18l').value) || 0,
        smallBottles: parseInt(document.getElementById('p-small').value) || 0,
        returns18L: parseInt(document.getElementById('p-18l-ret').value) || 0,
        cases: parseInt(document.getElementById('p-cases').value) || 0,
        smallReturns: parseInt(document.getElementById('p-small-ret').value) || 0,
        receivedBy: document.getElementById('p-rec-by').value,
        email: document.getElementById('p-email').value,
        phone: document.getElementById('p-phone').value,
        notes: document.getElementById('p-notes').value,
        signature: sigCanvas.toDataURL(),
        status: status,
        timestamp: new Date().toISOString()
    };
    s.completed = (status === 'DELIVERED');
    deliveryLogs.push({ customer: s.company, address: s.address, ...s.deliveryData });
    saveToStorage();
    renderSidebar();
    renderRoute();
    updateDailySummary();
    closeProfile();
    showToast(`${s.company} marked as ${status}`, 'success');
}

function saveToStorage() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ stops, deliveryLogs, lastUpdate: new Date().toISOString() })); } catch (e) {}
}

function loadStoredData() {
    try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            const data = JSON.parse(stored);
            stops = data.stops || [];
            deliveryLogs = data.deliveryLogs || [];
            if (stops.length > 0) { renderSidebar(); renderRoute(); updateDailySummary(); showToast('Route restored', 'success'); }
        }
    } catch (e) {}
}

function updateDailySummary() {
    const completed = stops.filter(s => s.completed).length;
    const total = stops.length;
    const b18 = deliveryLogs.reduce((s, l) => s + (l.bottles18L || 0), 0);
    const bs = deliveryLogs.reduce((s, l) => s + (l.smallBottles || 0), 0);
    const ret = deliveryLogs.reduce((s, l) => s + (l.returns18L || 0), 0);
    document.getElementById('summary-data').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary);"><h4 style="color: var(--primary);">Completed</h4><p style="font-size: 36px; font-weight: bold; color: white;">${completed} / ${total}</p></div>
            <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border-left: 4px solid var(--success);"><h4 style="color: var(--success);">18L Bottles</h4><p style="font-size: 36px; font-weight: bold; color: white;">${b18}</p></div>
            <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border-left: 4px solid var(--warning);"><h4 style="color: var(--warning);">Small Bottles</h4><p style="font-size: 36px; font-weight: bold; color: white;">${bs}</p></div>
            <div style="background: #2a2a2a; padding: 20px; border-radius: 8px; border-left: 4px solid var(--danger);"><h4 style="color: var(--danger);">Returns</h4><p style="font-size: 36px; font-weight: bold; color: white;">${ret}</p></div>
        </div>
    `;
}

async function downloadPDF() {
    showToast('Generating PDF...', 'success');
    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        pdf.setFontSize(22);
        pdf.setTextColor(0, 120, 255);
        pdf.text('CULLIGAN WATER DELIVERY', 20, 20);
        
        pdf.setFontSize(12);
        pdf.setTextColor(0, 0, 0);
        pdf.text(`Date: ${new Date().toLocaleDateString()}`, 20, 30);
        pdf.text(`Time: ${new Date().toLocaleTimeString()}`, 20, 37);
        
        if (currentStopIndex !== null) {
            const s = stops[currentStopIndex];
            pdf.setFontSize(14);
            pdf.text('Customer Information', 20, 50);
            pdf.setFontSize(11);
            pdf.text(`Name: ${s.company}`, 20, 58);
            pdf.text(`Address: ${s.address}`, 20, 65);
            
            if (s.deliveryData) {
                const d = s.deliveryData;
                pdf.text(`Received By: ${d.receivedBy || 'N/A'}`, 20, 72);
                
                let y = 90;
                pdf.setFontSize(12);
                pdf.text('DELIVERY ITEMS', 20, y);
                y += 10;
                
                pdf.setFontSize(10);
                if (d.bottles18L > 0) { pdf.text(`18L Bottles: ${d.bottles18L}`, 25, y); y += 7; }
                if (d.smallBottles > 0) { pdf.text(`Small Bottles: ${d.smallBottles}`, 25, y); y += 7; }
                if (d.cases > 0) { pdf.text(`Cases: ${d.cases}`, 25, y); y += 7; }
                if (d.returns18L > 0) { pdf.text(`18L Returns: ${d.returns18L}`, 25, y); y += 7; }
                if (d.smallReturns > 0) { pdf.text(`Small Returns: ${d.smallReturns}`, 25, y); y += 7; }
                
                if (d.notes) {
                    y += 10;
                    pdf.text('Notes:', 20, y);
                    y += 7;
                    pdf.setFontSize(9);
                    const lines = pdf.splitTextToSize(d.notes, 170);
                    pdf.text(lines, 25, y);
                    y += lines.length * 5;
                }
                
                if (d.signature) {
                    y += 15;
                    pdf.setFontSize(10);
                    pdf.text('Customer Signature:', 20, y);
                    pdf.addImage(d.signature, 'PNG', 20, y + 5, 80, 30);
                }
            }
        } else {
            // Generate daily summary PDF
            pdf.setFontSize(14);
            pdf.text('Daily Route Summary', 20, 50);
            pdf.setFontSize(11);
            
            const completed = stops.filter(s => s.completed).length;
            pdf.text(`Total Stops: ${stops.length}`, 20, 60);
            pdf.text(`Completed: ${completed}`, 20, 67);
            pdf.text(`Pending: ${stops.length - completed}`, 20, 74);
            
            const b18 = deliveryLogs.reduce((s, l) => s + (l.bottles18L || 0), 0);
            const bs = deliveryLogs.reduce((s, l) => s + (l.smallBottles || 0), 0);
            
            pdf.text(`18L Bottles Delivered: ${b18}`, 20, 85);
            pdf.text(`Small Bottles Delivered: ${bs}`, 20, 92);
        }
        
        pdf.setFontSize(9);
        pdf.setTextColor(128, 128, 128);
        pdf.text('Thank you for your business!', 20, 280);
        pdf.text('Culligan Water Delivery Service', 20, 285);
        
        const filename = currentStopIndex !== null 
            ? `culligan-${stops[currentStopIndex].company.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.pdf`
            : `culligan-daily-summary-${Date.now()}.pdf`;
        
        pdf.save(filename);
        showToast('PDF downloaded successfully!', 'success');
        
        return pdf;
    } catch (e) {
        showToast('PDF generation failed: ' + e.message, 'error');
        console.error(e);
        return null;
    }
}

async function emailPDF() {
    const statusDiv = document.getElementById('email-status');
    
    if (currentStopIndex === null) {
        showToast('Please open a customer profile first', 'warning');
        return;
    }
    
    const s = stops[currentStopIndex];
    const d = s.deliveryData;
    
    // Get email from customer profile or delivery data
    let email = document.getElementById('p-email').value || (d && d.email) || s.email;
    
    // If no email in profile, check the manual input field
    if (!email || !email.includes('@')) {
        email = document.getElementById('customer-email').value;
    }
    
    if (!email || !email.includes('@')) {
        showToast('No email address found for this customer. Please add one in their profile.', 'error');
        document.getElementById('customer-email').focus();
        return;
    }
    
    // Auto-populate the email field for reference
    document.getElementById('customer-email').value = email;
    
    statusDiv.style.display = 'block';
    statusDiv.style.background = 'rgba(0, 120, 255, 0.1)';
    statusDiv.style.color = 'var(--primary)';
    statusDiv.innerHTML = `üìß Preparing email for ${email}...`;
    
    try {
        // Generate PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        // Create PDF content
        pdf.setFontSize(22);
        pdf.setTextColor(0, 120, 255);
        pdf.text('CULLIGAN WATER DELIVERY', 20, 20);
        
        pdf.setFontSize(12);
        pdf.setTextColor(0, 0, 0);
        pdf.text(`Date: ${new Date().toLocaleDateString()}`, 20, 30);
        pdf.text(`Time: ${new Date().toLocaleTimeString()}`, 20, 37);
        pdf.text(`Customer: ${s.company}`, 20, 47);
        pdf.text(`Address: ${s.address}`, 20, 54);
        
        if (d) {
            let y = 70;
            pdf.setFontSize(14);
            pdf.text('DELIVERY ITEMS:', 20, y);
            pdf.setFontSize(11);
            y += 10;
            if (d.bottles18L > 0) { pdf.text(`18L Bottles: ${d.bottles18L}`, 25, y); y += 7; }
            if (d.smallBottles > 0) { pdf.text(`Small Bottles: ${d.smallBottles}`, 25, y); y += 7; }
            if (d.cases > 0) { pdf.text(`Cases: ${d.cases}`, 25, y); y += 7; }
            if (d.returns18L > 0) { pdf.text(`18L Returns: ${d.returns18L}`, 25, y); y += 7; }
            if (d.smallReturns > 0) { pdf.text(`Small Returns: ${d.smallReturns}`, 25, y); y += 7; }
            
            if (d.receivedBy) {
                y += 10;
                pdf.text(`Received By: ${d.receivedBy}`, 20, y);
                y += 7;
            }
            
            if (d.notes) {
                y += 10;
                pdf.setFontSize(10);
                pdf.text('Notes:', 20, y);
                y += 5;
                const lines = pdf.splitTextToSize(d.notes, 170);
                pdf.text(lines, 25, y);
                y += lines.length * 5 + 10;
            }
            
            if (d.signature) {
                y += 10;
                pdf.setFontSize(11);
                pdf.text('Customer Signature:', 20, y);
                pdf.addImage(d.signature, 'PNG', 20, y + 5, 80, 30);
            }
        }
        
        pdf.setFontSize(9);
        pdf.setTextColor(128, 128, 128);
        pdf.text('Thank you for your business!', 20, 280);
        pdf.text('Culligan Water Delivery Service', 20, 285);
        
        // Save PDF
        const filename = `culligan-receipt-${s.company.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.pdf`;
        pdf.save(filename);
        
        // Create email content
        const subject = `Culligan Water Delivery Receipt - ${s.company}`;
        let body = `Dear ${s.company},\n\nThank you for your order!\n\nDelivery Details:\n`;
        body += `Date: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}\n`;
        body += `Address: ${s.address}\n\n`;
        
        if (d) {
            if (d.bottles18L > 0) body += `18L Bottles Delivered: ${d.bottles18L}\n`;
            if (d.smallBottles > 0) body += `Small Bottles Delivered: ${d.smallBottles}\n`;
            if (d.cases > 0) body += `Cases Delivered: ${d.cases}\n`;
            if (d.returns18L > 0) body += `18L Returns: ${d.returns18L}\n`;
            if (d.receivedBy) body += `\nReceived By: ${d.receivedBy}\n`;
        }
        
        body += `\n\nYour delivery receipt PDF has been downloaded. Please attach it to this email before sending.\n\n`;
        body += `Thank you for choosing Culligan Water!\n\nBest regards,\nCulligan Delivery Team`;
        
        // Open email client with pre-filled data
        const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailtoLink;
        
        statusDiv.style.background = 'rgba(6, 255, 165, 0.1)';
        statusDiv.style.color = 'var(--success)';
        statusDiv.innerHTML = `‚úÖ Email opened for ${email}<br><small>PDF downloaded - please attach it to the email before sending</small>`;
        
        showToast(`Email prepared for ${s.company}`, 'success');
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 10000);
        
    } catch (e) {
        statusDiv.style.background = 'rgba(220, 53, 69, 0.1)';
        statusDiv.style.color = 'var(--danger)';
        statusDiv.innerHTML = '‚ùå Failed to send email: ' + e.message;
        showToast('Email failed: ' + e.message, 'error');
        console.error(e);
    }
}

function saveToGoogleDrive() {
    if (currentStopIndex === null) {
        showToast('Please open a customer profile first', 'warning');
        return;
    }
    
    showToast('Generating PDF for Google Drive...', 'success');
    
    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const s = stops[currentStopIndex];
        const d = s.deliveryData;
        
        // Create PDF
        pdf.setFontSize(22);
        pdf.setTextColor(0, 120, 255);
        pdf.text('CULLIGAN WATER DELIVERY', 20, 20);
        
        pdf.setFontSize(12);
        pdf.setTextColor(0, 0, 0);
        pdf.text(`Date: ${new Date().toLocaleDateString()}`, 20, 30);
        pdf.text(`Customer: ${s.company}`, 20, 40);
        pdf.text(`Address: ${s.address}`, 20, 47);
        
        if (d) {
            let y = 60;
            if (d.bottles18L > 0) { pdf.text(`18L Bottles: ${d.bottles18L}`, 20, y); y += 7; }
            if (d.smallBottles > 0) { pdf.text(`Small Bottles: ${d.smallBottles}`, 20, y); y += 7; }
            if (d.signature) {
                y += 10;
                pdf.text('Signature:', 20, y);
                pdf.addImage(d.signature, 'PNG', 20, y + 5, 80, 30);
            }
        }
        
        const filename = `culligan-${s.company.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.pdf`;
        
        // Download PDF
        pdf.save(filename);
        
        // Open Google Drive upload page
        setTimeout(() => {
            window.open('https://drive.google.com/drive/my-drive', '_blank');
            showToast('PDF downloaded! Upload it to the Google Drive page that just opened.', 'success');
        }, 500);
        
    } catch (e) {
        showToast('Failed to prepare PDF for Drive', 'error');
        console.error(e);
    }
}

function exportToCSV() {
    if (deliveryLogs.length === 0) {
        showToast('No deliveries to export yet', 'warning');
        return;
    }
    
    try {
        // Create CSV header
        let csv = 'Customer,Address,18L Bottles,Small Bottles,18L Returns,Cases,Small Returns,Received By,Status,Notes,Timestamp\n';
        
        // Add each delivery
        deliveryLogs.forEach(log => {
            csv += `"${log.customer}","${log.address}",${log.bottles18L || 0},${log.smallBottles || 0},${log.returns18L || 0},${log.cases || 0},${log.smallReturns || 0},"${log.receivedBy || ''}","${log.status}","${(log.notes || '').replace(/"/g, '""')}","${new Date(log.timestamp).toLocaleString()}"\n`;
        });
        
        // Create download
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `culligan-deliveries-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showToast('Daily summary exported to CSV!', 'success');
    } catch (e) {
        showToast('Failed to export CSV', 'error');
        console.error(e);
    }
}

<script>
function toggleManager() { document.getElementById('manager-panel').classList.toggle('open'); }
function switchTab(e, id) {
    document.querySelectorAll('.mgr-tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.mgr-content').forEach(c => c.classList.remove('active'));
    e.target.classList.add('active');
    document.getElementById(id).classList.add('active');
}
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast ${type}`;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}
</script>

<script src="online-sync.js"></script>
</body>
</html>
