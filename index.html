<!DOCTYPE html>
<html>
<head>
    <title>Culligan Route Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --culligan-blue: #0078ff; --sidebar-width: 280px; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; background: #f0f2f5; }
        
        /* SIDEBAR RESTORED */
        #sidebar { width: var(--sidebar-width); background: #1e1e2d; color: white; display: flex; flex-direction: column; transition: 0.3s; z-index: 1001; }
        .sidebar-header { padding: 20px; background: #1a1a27; text-align: center; border-bottom: 1px solid #333; }
        .menu-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #2d2d3f; transition: 0.2s; }
        .menu-item:hover { background: var(--culligan-blue); }
        
        /* MAIN AREA */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }
        header { background: var(--culligan-blue); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        #map { flex: 1; width: 100%; }
        #stop-list { height: 250px; overflow-y: auto; padding: 15px; background: white; border-top: 2px solid #ddd; }
        
        /* CARDS */
        .stop-card { background: white; border-left: 5px solid var(--culligan-blue); padding: 12px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        
        /* MODALS (Password & Manager) */
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; color: white; }
        .modal-box { background: #fff; color: #333; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; }
        
        /* DATA INPUT GRID */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        input, textarea { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        
        /* MAP PIN */
        .number-pin { background: var(--culligan-blue); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }
        
        /* SIGNATURE */
        #sig-canvas { border: 1px solid #000; background: #fff; width: 100%; height: 120px; touch-action: none; }
        
        .btn { padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-blue { background: var(--culligan-blue); color: white; }
        
        @media (max-width: 768px) { #sidebar { display: none; } }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">
        <h2 style="margin:0;">CULLIGAN</h2>
    </div>
    <div class="menu-item" onclick="showManager()">Manager Menu</div>
    <div class="menu-item">Driver Logs</div>
    <div class="menu-item">Active Routes</div>
    <div class="menu-item" style="margin-top:auto; background:#dc3545;">Logout</div>
</div>

<div id="main">
    <header>
        <span onclick="toggleSidebar()" style="cursor:pointer; font-size:20px;">â˜°</span>
        <div id="current-route">Select Route</div>
        <div id="stop-count">0 Stops</div>
    </header>

    <div id="map"></div>
    <div id="stop-list"></div>
</div>

<div id="dataModal" class="overlay">
    <div class="modal-box">
        <h2 id="mCustName" style="color:var(--culligan-blue); margin-top:0;">Customer</h2>
        <div class="input-grid">
            <input type="number" id="inv18" placeholder="18L Del">
            <input type="number" id="ret18" placeholder="18L Ret">
            <input type="number" id="invSm" placeholder="Sm Del">
            <input type="number" id="retSm" placeholder="Sm Ret">
            <input type="number" id="cases" placeholder="Cases">
            <input type="text" id="recv" placeholder="Recv By">
        </div>
        <textarea id="notes" placeholder="Notes"></textarea>
        <p>Signature:</p>
        <canvas id="sig-canvas"></canvas>
        <button class="btn btn-blue" onclick="submitData()">SUBMIT DELIVERY</button>
        <button class="btn" style="background:#eee;" onclick="closeModals()">CANCEL</button>
    </div>
</div>

<div id="passModal" class="overlay">
    <div class="modal-box">
        <h3>Manager Access</h3>
        <input type="password" id="managerPass" placeholder="Enter Password">
        <button class="btn btn-blue" onclick="checkPass()">Unlock</button>
        <button class="btn" onclick="closeModals()">Cancel</button>
    </div>
</div>

<div id="ticket-output" style="display:none; width:600px; padding:40px; background:white; color:black;">
    <h1 style="color:#0078ff;">CULLIGAN DELIVERY RECEIPT</h1>
    <hr>
    <p><b>Customer:</b> <span id="t-cust"></span></p>
    <p><b>Date:</b> <span id="t-date"></span></p>
    <div class="input-grid">
        <p>18L Delivered: <span id="t-l18"></span></p>
        <p>18L Returned: <span id="t-r18"></span></p>
    </div>
    <p><b>Received By:</b> <span id="t-recv"></span></p>
    <img id="t-sig" style="width:100%; border-bottom:1px solid #000;">
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbzMfGuDRFTGBWyrG2CVFVOBSUzyORpxd4aTVZaStpuF54zkryeKdFU0PLIIaIgk-w0M/exec";
    let map, activeIdx, canvas, ctx, drawing = false;
    let stops = [
        { company: "TEST_UFA_FARM", address: "123 Farm Road", lat: 55.17, lng: -118.79 },
        { company: "Culligan Main", address: "Warehouse", lat: 55.18, lng: -118.80 }
    ];

    function showManager() { document.getElementById('passModal').style.display = 'flex'; }
    
    function checkPass() {
        if(document.getElementById('managerPass').value === "1234") {
            alert("Manager Menu Unlocked");
            closeModals();
        } else {
            alert("Wrong Password");
        }
    }

    async function submitData() {
        const now = new Date();
        const longDate = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        // Populate PDF template
        document.getElementById('t-cust').innerText = stops[activeIdx].company;
        document.getElementById('t-date').innerText = longDate;
        document.getElementById('t-l18').innerText = document.getElementById('inv18').value;
        document.getElementById('t-r18').innerText = document.getElementById('ret18').value;
        document.getElementById('t-recv').innerText = document.getElementById('recv').value;
        document.getElementById('t-sig').src = canvas.toDataURL();

        const ticket = document.getElementById('ticket-output');
        ticket.style.display = 'block';

        html2pdf().from(ticket).outputPdf('datauristring').then(pdf => {
            ticket.style.display = 'none';
            const payload = {
                Customer: stops[activeIdx].company,
                Address: stops[activeIdx].address,
                DriverID: "Driver_1",
                l18: document.getElementById('inv18').value,
                r18: document.getElementById('ret18').value,
                recv: document.getElementById('recv').value,
                Notes: document.getElementById('notes').value,
                pdfData: pdf,
                LongDate: longDate,
                FileName: `${stops[activeIdx].company} - ${longDate}.pdf`
            };

            fetch(API, { method: 'POST', body: JSON.stringify(payload) })
            .then(() => { alert("Saved!"); closeModals(); });
        });
    }

    function initCanvas() {
        canvas = document.getElementById('sig-canvas');
        ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
        canvas.onmousedown = (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
        canvas.onmousemove = (e) => { if(drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
        window.onmouseup = () => drawing = false;
        canvas.ontouchstart = (e) => { drawing = true; ctx.beginPath(); let t = e.touches[0]; ctx.moveTo(t.clientX - canvas.getBoundingClientRect().left, t.clientY - canvas.getBoundingClientRect().top); };
        canvas.ontouchmove = (e) => { if(drawing) { let t = e.touches[0]; ctx.lineTo(t.clientX - canvas.getBoundingClientRect().left, t.clientY - canvas.getBoundingClientRect().top); ctx.stroke(); } };
    }

    function closeModals() {
        document.querySelectorAll('.overlay').forEach(m => m.style.display = 'none');
    }

    window.onload = () => {
        map = L.map("map").setView([55.17, -118.79], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        
        const list = document.getElementById('stop-list');
        stops.forEach((s, i) => {
            const card = document.createElement('div');
            card.className = "stop-card";
            card.innerHTML = `<b>#${i+1} ${s.company}</b><br><small>${s.address}</small>`;
            card.onclick = () => {
                activeIdx = i;
                document.getElementById('mCustName').innerText = s.company;
                document.getElementById('dataModal').style.display = 'flex';
                initCanvas();
            };
            list.appendChild(card);
            L.marker([s.lat, s.lng], { 
                icon: L.divIcon({ html: `<div class="number-pin">${i+1}</div>`, className: '' }) 
            }).addTo(map);
        });
        document.getElementById('stop-count').innerText = stops.length + " Stops";
    };
</script>
</body>
</html>
