<div class="mgr-tabs">
    <button class="mgr-tab-btn active" onclick="switchTab('reports')">DAILY SUMMARY</button>
    <button class="mgr-tab-btn" onclick="switchTab('live-report')">LIVE REPORT</button>
    <button class="mgr-tab-btn" onclick="switchTab('cust-mgr')">CUSTOMER MGR</button>
</div>

<div id="cust-mgr" class="mgr-content">
    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <input type="text" id="cust-search-input" placeholder="Enter Customer Name..." style="flex:1; padding:10px; border-radius:4px; border:1px solid #0078ff; background:#333; color:white;">
        <button class="btn" onclick="searchCustomer()">SEARCH</button>
    </div>
    
    <div id="edit-modal" style="display:none; background:#222; padding:15px; border:1px solid #444; border-radius:4px;">
        <h3 id="modal-title">Edit Customer</h3>
        <div class="profile-group"><label>NAME</label><input type="text" id="m-name"></div>
        <div class="profile-group"><label>ADDRESS</label><input type="text" id="m-addr"></div>
        <div class="profile-group"><label>PHONE</label><input type="text" id="m-phone"></div>
        <div class="profile-group"><label>EMAIL</label><input type="text" id="m-email"></div>
        <div class="profile-group"><label>NOTES</label><textarea id="m-notes"></textarea></div>
        <div class="profile-group">
            <label>ROUTE & DAY</label>
            <select id="m-route" style="width:100%; padding:8px; background:#333; color:white; border:1px solid #444;">
                <option value="WEEK 1 MONDAY">WEEK 1 MONDAY</option>
                </select>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="flex:1" onclick="saveCustomer()">SAVE TO ROUTE</button>
            <button class="btn-mgr" style="flex:1; background:#dc3545" onclick="triggerRush()">CREATE RUSH ORDER</button>
        </div>
    </div>
</div>

<script>
let pendingRushOrder = null;

async function searchCustomer() {
    const name = document.getElementById('cust-search-input').value.toLowerCase();
    document.getElementById('status').innerText = "Searching all sheets...";
    
    // Logic to search via the Google Script across all sheets
    try {
        const res = await fetch(`${SCRIPT_URL}?action=search&name=${encodeURIComponent(name)}`);
        const data = await res.json();
        
        if (data.found) {
            fillModal(data.customer);
        } else {
            if (confirm("Customer not found. Add new customer?")) {
                fillModal({name: document.getElementById('cust-search-input').value, address:'', phone:'', email:'', notes:'', route:''});
            }
        }
    } catch (e) { alert("Search failed. Check Google Script connection."); }
    document.getElementById('status').innerText = "Ready";
}

function fillModal(c) {
    document.getElementById('edit-modal').style.display = 'block';
    document.getElementById('m-name').value = c.name || "";
    document.getElementById('m-addr').value = c.address || "";
    document.getElementById('m-phone').value = c.phone || "";
    document.getElementById('m-email').value = c.email || "";
    document.getElementById('m-notes').value = c.notes || "";
    document.getElementById('m-route').value = c.route || "WEEK 1 MONDAY";
}

async function saveCustomer() {
    const payload = {
        action: "saveCustomer",
        name: document.getElementById('m-name').value,
        address: document.getElementById('m-addr').value,
        phone: document.getElementById('m-phone').value,
        email: document.getElementById('m-email').value,
        notes: document.getElementById('m-notes').value,
        route: document.getElementById('m-route').value
    };
    await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
    alert("Saved to " + payload.route);
}

function triggerRush() {
    const instr = prompt("ENTER RUSH INSTRUCTIONS:");
    if (!instr) return;
    
    const rushPayload = {
        action: "RUSH",
        route: document.getElementById('m-route').value,
        instructions: instr,
        customer: document.getElementById('m-name').value,
        address: document.getElementById('m-addr').value
    };
    
    // This sends the rush order to the backend to be picked up by the specific route
    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(rushPayload) });
    alert("Rush Order Sent to " + rushPayload.route);
}

// DRIVER SIDE LOGIC: In your existing submitLog function, add this at the very end:
async function checkSpecialOrders() {
    const currentRoute = document.getElementById('route-select').value;
    try {
        const res = await fetch(`${SCRIPT_URL}?action=checkRush&route=${currentRoute}`);
        const data = await res.json();
        if (data.hasRush) {
            // This is the blocking popup the driver must accept
            alert("‚ö†Ô∏è SPECIAL ORDER ENTERED!\n\nCustomer: " + data.customer + "\nInstructions: " + data.instructions);
            
            // Add the rush stop to the current map/list and optimize
            let geo = await geocodeArcGIS(data.address);
            stops.splice(currentStopIndex + 1, 0, {
                company: "üö® RUSH: " + data.customer,
                address: data.address,
                ...geo
            });
            renderRoute();
            renderSidebar();
        }
    } catch (e) { console.log("Rush check failed"); }
}

// Modify your submitLog at the end:
// ... after alert(status...)
checkSpecialOrders(); 
</script>
