<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Culligan Route - Professional</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body { margin:0; height:100vh; display:flex; font-family:'Segoe UI',sans-serif; background:#111; color:white; overflow:hidden;}
    #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column;}
    #sidebar-header { padding:15px; border-bottom:1px solid #444;}
    #stop-list { flex:1; overflow-y:auto; padding:10px;}
    .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer;}
    .stop-card.flagged { border-left-color: #ffc107; background: #443c20; }
    .stop-card:hover { background:#444;}
    #customer-profile { display:none; padding:15px; background:#222; overflow-y:auto; height:100%; }
    .profile-group { margin-bottom:12px; }
    .profile-group label { display:block; font-size:11px; color:#0078ff; font-weight:bold; margin-bottom:4px; text-transform: uppercase;}
    .profile-group input, .profile-group textarea { width:100%; padding:8px; background:#333; border:1px solid #444; color:white; border-radius:4px; box-sizing:border-box; }
    #sig-canvas { background:white; border-radius:4px; width:100%; height:150px; touch-action: none; border: 2px solid #555;}
    .form-btns { display:flex; gap:10px; margin-top:20px; padding-bottom: 40px;}
    .btn-del { flex:1; background:#28a745; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold;}
    .btn-not { flex:1; background:#dc3545; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold;}
    .back-btn { background:none; border:none; color:#0078ff; cursor:pointer; padding:0; margin-bottom:10px; font-weight: bold;}
    
    #main-view { flex:1; display:flex; flex-direction:column; position: relative;}
    #current-stop-info { background:#001a33; padding:10px; border-bottom:2px solid #0078ff; display:flex; justify-content:space-between; align-items:center; min-height:60px;}
    #info-text { flex:1; }
    #info-nav-btns { display:flex; gap:5px; align-items:center;}
    .nav-arrow { background:#333; border:1px solid #0078ff; color:white; padding:10px; cursor:pointer; border-radius:4px;}

    #controls { background:#222; padding:10px; border-bottom:1px solid #444; display: flex; align-items: center; gap: 10px;}
    #map { flex:1; }
    
    #lost-btn { position:absolute; top:130px; right:10px; z-index:1000; background:#ffc107; color:black; border:none; padding:12px 20px; font-weight:bold; border-radius:4px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.5);}
    
    .btn { padding:10px 15px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;}
    .btn-mgr { background:#6c757d; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer; font-weight:bold;}
    #status { font-size:13px; color:#0078ff; font-weight: bold;}
    #route-select { padding: 10px; background: #333; color: white; border: 1px solid #0078ff; border-radius: 4px; }
    
    .custom-div-icon { background:transparent; border:none;}
    .number-pin { background:#0078ff; color:white; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.5);}
    .number-pin.warn { background:#ffc107; color:black;}

    #manager-panel { position: absolute; bottom: -100%; left: 0; width: 100%; height: 90%; background: #1a1a1a; z-index: 1000; transition: bottom 0.4s ease; border-top: 3px solid #0078ff; }
    #manager-panel.open { bottom: 0; }
    .mgr-tabs { display: flex; background: #222; border-bottom: 1px solid #444; overflow-x: auto;}
    .mgr-tab-btn { padding: 15px 20px; border: none; background: none; color: #aaa; cursor: pointer; font-weight: bold; white-space: nowrap;}
    .mgr-tab-btn.active { color: #0078ff; border-bottom: 2px solid #0078ff; background: #2a2a2a; }
    .mgr-content { padding: 20px; display: none; overflow-y: auto; height: calc(100% - 150px); color: white;}
    .mgr-content.active { display: block; }
    .close-mgr { position: absolute; top: 10px; right: 20px; background: none; border: none; color: #dc3545; font-size: 24px; cursor: pointer; z-index: 1001;}
    
    .mgr-card { background: #222; border: 1px solid #444; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
</style>
</head>

<body>

<div id="sidebar">
    <div id="list-view">
        <div id="sidebar-header">
            <h3 style="margin:0">Route Stops</h3>
            <p id="stop-count" style="font-size:12px; color:#aaa;">No route loaded</p>
        </div>
        <div id="stop-list"></div>
    </div>
    <div id="customer-profile">
        <button class="back-btn" onclick="closeProfile()">‚Üê BACK TO LIST</button>
        <h3 id="prof-name">Customer Name</h3>
        <p id="prof-addr" style="font-size:12px; color:#aaa;"></p>
        <div class="profile-group"><label>18L BOTTLES</label><input type="number" id="p-18l" value="0"></div>
        <div class="profile-group"><label>SMALL BOTTLES</label><input type="number" id="p-small" value="0"></div>
        <div class="profile-group"><label>18L RETURNS</label><input type="number" id="p-18l-ret" value="0"></div>
        <div class="profile-group"><label>CASES</label><input type="number" id="p-cases" value="0"></div>
        <div class="profile-group"><label>SMALL BOTTLES RETURNED</label><input type="number" id="p-small-ret" value="0"></div>
        <div class="profile-group"><label>RECEIVED BY</label><input type="text" id="p-rec-by" placeholder="Name"></div>
        <div class="profile-group"><label>NOTES / INSTRUCTIONS</label><textarea id="p-notes" rows="3"></textarea></div>
        <label style="font-size:11px; color:#0078ff; font-weight:bold;">SIGNATURE</label>
        <canvas id="sig-canvas"></canvas>
        <div class="form-btns">
            <button class="btn-del" onclick="submitLog('DELIVERED')">DELIVERED</button>
            <button class="btn-not" onclick="submitLog('NOT DELIVERED')">NOT DELIVERED</button>
        </div>
    </div>
</div>

<div id="main-view">
    <div id="current-stop-info">
        <div id="info-text">
            <b id="head-name">No Route Loaded</b><br>
            <span id="head-addr" style="font-size:12px; color:#aaa;">---</span> | <span id="head-phone" style="font-size:12px; color:#0078ff;">---</span>
        </div>
        <div id="info-nav-btns">
            <button class="nav-arrow" onclick="navStep(-1)">‚óÄ</button>
            <button class="nav-arrow" onclick="navStep(1)">‚ñ∂</button>
        </div>
    </div>
    <div id="controls">
        <select id="route-select">
            <option value="WEEK 1 MONDAY">WEEK 1 MONDAY</option>
            <option value="WEEK 1 TUESDAY">WEEK 1 TUESDAY</option>
            <option value="WEEK 1 WEDNESDAY">WEEK 1 WEDNESDAY</option>
            <option value="WEEK 1 THURSDAY">WEEK 1 THURSDAY</option>
            <option value="WEEK 1 FRIDAY">WEEK 1 FRIDAY</option>
            <option value="WEEK 2 MONDAY">WEEK 2 MONDAY</option>
            <option value="WEEK 2 TUESDAY">WEEK 2 TUESDAY</option>
            <option value="WEEK 2 WEDNESDAY">WEEK 2 WEDNESDAY</option>
            <option value="WEEK 2 THURSDAY">WEEK 2 THURSDAY</option>
            <option value="WEEK 2 FRIDAY">WEEK 2 FRIDAY</option>
            <option value="WEEK 3 MONDAY">WEEK 3 MONDAY</option>
            <option value="WEEK 3 TUESDAY">WEEK 3 TUESDAY</option>
            <option value="WEEK 3 WEDNESDAY">WEEK 3 WEDNESDAY</option>
            <option value="WEEK 3 THURSDAY">WEEK 3 THURSDAY</option>
            <option value="WEEK 3 FRIDAY">WEEK 3 FRIDAY</option>
            <option value="WEEK 4 MONDAY">WEEK 4 MONDAY</option>
            <option value="WEEK 4 TUESDAY">WEEK 4 TUESDAY</option>
            <option value="WEEK 4 WEDNESDAY">WEEK 4 WEDNESDAY</option>
            <option value="WEEK 4 THURSDAY">WEEK 4 THURSDAY</option>
            <option value="WEEK 4 FRIDAY">WEEK 4 FRIDAY</option>
            <option value="VALLEY VIEW">VALLEY VIEW</option>
            <option value="NORTH">NORTH</option>
            <option value="DAWSON CREEK">DAWSON CREEK</option>
            <option value="SALT">SALT</option>
        </select>
        <button class="btn" style="background:#0078ff;" onclick="loadRoute()">Load Route</button>
        <button id="start-btn" class="btn" style="background:#28a745; display:none;" onclick="startRoute()">START ROUTE</button>
        <button class="btn-mgr" onclick="toggleManager()">Manager Panel</button>
        <div id="status">Status: Ready</div>
    </div>
    <div id="map"></div>
    <button id="lost-btn" onclick="openGoogleMaps()">üìç I'M LOST</button>

    <div id="manager-panel">
        <button class="close-mgr" onclick="toggleManager()">√ó</button>
        <div class="mgr-tabs">
            <button class="mgr-tab-btn active" onclick="switchTab('reports')">DAILY SUMMARY</button>
            <button class="mgr-tab-btn" onclick="switchTab('live-report')">LIVE REPORT</button>
            <button class="mgr-tab-btn" onclick="switchTab('rush-orders')">RUSH ORDERS</button>
            <button class="mgr-tab-btn" onclick="switchTab('cust-maint')">CUSTOMER MAINT.</button>
        </div>
        
        <div id="reports" class="mgr-content active">
            <h2 style="color:#0078ff;">DAILY SUMMARY</h2>
            <div id="summary-data"></div>
            <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
            <button class="btn" style="background:#dc3545; width:100%;" onclick="adminResetCounter()">RESET CURRENT SLIP COUNTER</button>
        </div>

        <div id="live-report" class="mgr-content">
            <table id="live-table" style="width:100%; border-collapse:collapse; font-size:11px; color: white;">
                <thead>
                    <tr><th>Customer</th><th>Status</th><th>18L</th><th>Sm</th><th>Cs</th><th>R18</th><th>Rsm</th><th>Time</th></tr>
                </thead>
                <tbody id="live-body"></tbody>
            </table>
        </div>

        <div id="rush-orders" class="mgr-content">
            <h2 style="color:#ffc107;">RUSH ORDER ENTRY</h2>
            <div class="mgr-card">
                <input type="text" id="rush-cust" placeholder="Customer Name" style="width:100%; padding:10px; margin-bottom:10px; background:#333; border:1px solid #444; color:white;">
                <input type="text" id="rush-addr" placeholder="Address" style="width:100%; padding:10px; margin-bottom:10px; background:#333; border:1px solid #444; color:white;">
                <textarea id="rush-note" placeholder="Instructions..." style="width:100%; padding:10px; background:#333; border:1px solid #444; color:white;"></textarea>
                <button class="btn" style="width:100%; margin-top:10px;" onclick="addRushOrder()">ADD TO ROUTE</button>
            </div>
        </div>

        <div id="cust-maint" class="mgr-content">
            <h2 style="color:#0078ff;">CUSTOMER MAINTENANCE</h2>
            <div class="mgr-card">
                <p>Edit Current Stop Details:</p>
                <label>Company Name</label>
                <input type="text" id="edit-name" style="width:100%; padding:10px; margin-bottom:10px; background:#333; border:1px solid #444; color:white;">
                <label>Address</label>
                <input type="text" id="edit-addr" style="width:100%; padding:10px; margin-bottom:10px; background:#333; border:1px solid #444; color:white;">
                <label>Phone</label>
                <input type="text" id="edit-phone" style="width:100%; padding:10px; margin-bottom:10px; background:#333; border:1px solid #444; color:white;">
                <button class="btn" style="width:100%;" onclick="saveCustomerEdits()">UPDATE CURRENT STOP</button>
            </div>
        </div>

        <div class="mgr-footer" style="padding:20px;">
            <button class="btn-eod" style="background:#ffc107; color: black; width:100%; padding:15px; font-weight:bold; border:none; border-radius: 4px;" onclick="executeEOD()">END OF DAY</button>
        </div>
    </div>
</div>

<script>
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMfGuDRFTGBWyrG2CVFVOBSUzyORpxd4aTVZaStpuF54zkryeKdFU0PLIIaIgk-w0M/exec";
let map, markerLayer, routeLine, canvas, ctx, drawing = false, stops = [], deliveryLog = [], currentStopIndex = 0, driverName = "";
const warehouse = [55.1707, -118.7947];

window.onload = () => {
    map = L.map("map").setView(warehouse, 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    markerLayer = L.layerGroup().addTo(map);
    routeLine = L.polyline([], {color: '#0078ff', weight: 4, opacity: 0.6}).addTo(map);
    initSignaturePad();
};

function toggleManager() { 
    document.getElementById('manager-panel').classList.toggle('open'); 
    if(stops[currentStopIndex]) {
        document.getElementById('edit-name').value = stops[currentStopIndex].company;
        document.getElementById('edit-addr').value = stops[currentStopIndex].address;
        document.getElementById('edit-phone').value = stops[currentStopIndex].phone;
    }
}

function switchTab(tabId) {
    document.querySelectorAll('.mgr-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.mgr-tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
}

function adminResetCounter() {
    if (prompt("Enter Admin Password:") === "5645") {
        document.getElementById('p-18l').value = 0; document.getElementById('p-small').value = 0;
        document.getElementById('p-18l-ret').value = 0; document.getElementById('p-cases').value = 0;
        document.getElementById('p-small-ret').value = 0; document.getElementById('p-rec-by').value = "";
        document.getElementById('p-notes').value = ""; ctx.clearRect(0, 0, canvas.width, canvas.height);
        alert("Reset successful.");
    }
}

async function addRushOrder() {
    const name = document.getElementById('rush-cust').value;
    const addr = document.getElementById('rush-addr').value;
    if(!name || !addr) return alert("Fill required fields.");
    let geo = await geocodeArcGIS(addr);
    const rush = { company: "[RUSH] " + name, address: addr, phone: "RUSH", lat: geo?.lat || warehouse[0], lng: geo?.lng || warehouse[1], flagged: !geo };
    stops.splice(currentStopIndex + 1, 0, rush);
    renderRoute(); renderSidebar(); updateHeader();
    alert("Rush Order added as the next stop!");
}

function saveCustomerEdits() {
    if(!stops[currentStopIndex]) return;
    stops[currentStopIndex].company = document.getElementById('edit-name').value;
    stops[currentStopIndex].address = document.getElementById('edit-addr').value;
    stops[currentStopIndex].phone = document.getElementById('edit-phone').value;
    renderSidebar(); updateHeader();
    alert("Customer details updated for this session.");
}

function startRoute() {
    driverName = prompt("Enter your name to start:");
    if (driverName) {
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('status').innerText = `Driver: ${driverName}`;
    }
}

async function loadRoute() {
    const sheetName = document.getElementById("route-select").value;
    document.getElementById("status").innerText = "Optimizing Route...";
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows, cols = json.table.cols;
        const addrIdx = cols.findIndex(c => c.label && c.label.toLowerCase().includes('addr'));
        const compIdx = cols.findIndex(c => c.label && (c.label.toLowerCase().includes('comp') || c.label.toLowerCase().includes('cust')));
        const phoneIdx = cols.findIndex(c => c.label && c.label.toLowerCase().includes('phone'));
        
        let raw = [];
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i].c;
            const addr = row[addrIdx] ? row[addrIdx].v.toString() : "";
            if (!addr || addr.includes("http") || addr.toLowerCase().includes("address")) continue;
            let geo = await geocodeArcGIS(addr);
            raw.push({ company: row[compIdx]?.v || "Customer", address: addr, phone: row[phoneIdx]?.v || "---", lat: geo?.lat || warehouse[0], lng: geo?.lng || warehouse[1], flagged: !geo });
            await new Promise(r => setTimeout(r, 600));
        }

        stops = [];
        let currentPos = { lat: warehouse[0], lng: warehouse[1] };
        while (raw.length > 0) {
            let closestIdx = 0, minDist = Infinity;
            raw.forEach((s, idx) => {
                let d = Math.sqrt(Math.pow(s.lat - currentPos.lat, 2) + Math.pow(s.lng - currentPos.lng, 2));
                if (d < minDist) { minDist = d; closestIdx = idx; }
            });
            let next = raw.splice(closestIdx, 1)[0];
            stops.push(next);
            currentPos = { lat: next.lat, lng: next.lng };
        }
        stops.push({ company: "WAREHOUSE (END)", address: "8805 111 St, Grande Prairie", lat: warehouse[0], lng: warehouse[1], phone: "OFFICE" });
        
        currentStopIndex = 0; renderRoute(); renderSidebar(); updateHeader();
        document.getElementById('start-btn').style.display = 'inline-block';
        document.getElementById("status").innerText = "Route Optimized.";
    } catch (e) { document.getElementById("status").innerText = "Error."; }
}

async function geocodeArcGIS(addr) {
    try {
        const res = await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(addr + ", Grande Prairie, AB")}&maxLocations=1`);
        const data = await res.json();
        return data.candidates.length ? { lat: data.candidates[0].location.y, lng: data.candidates[0].location.x } : null;
    } catch (e) { return null; }
}

function renderRoute() {
    markerLayer.clearLayers();
    const latlngs = stops.map((s, i) => {
        L.marker([s.lat, s.lng], { icon: L.divIcon({ className:'custom-div-icon', html:`<div class="number-pin ${s.flagged?'warn':''}">${i+1}</div>` }) }).addTo(markerLayer);
        return [s.lat, s.lng];
    });
    updateRouteLines();
    if (latlngs.length) map.fitBounds(latlngs, {padding:[50,50]});
}

function updateRouteLines() {
    routeLine.setLatLngs(stops.slice(currentStopIndex).map(s => [s.lat, s.lng]));
}

function updateHeader() {
    const s = stops[currentStopIndex];
    if(!s) return;
    document.getElementById('head-name').innerText = `${currentStopIndex + 1}. ${s.company}`;
    document.getElementById('head-addr').innerText = s.address;
    document.getElementById('head-phone').innerText = s.phone;
}

function navStep(dir) {
    let n = currentStopIndex + dir;
    if (n >= 0 && n < stops.length) { currentStopIndex = n; updateHeader(); updateRouteLines(); map.setView([stops[n].lat, stops[n].lng], 16); }
}

function openGoogleMaps() {
    const s = stops[currentStopIndex];
    if (!s) return alert("Load route.");
    const destination = encodeURIComponent(`${s.address}, Grande Prairie, AB`);
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`, '_blank');
}

function openProfile(i) {
    currentStopIndex = i; updateHeader(); updateRouteLines();
    document.getElementById('list-view').style.display = 'none';
    document.getElementById('customer-profile').style.display = 'block';
    document.getElementById('prof-name').innerText = stops[i].company;
    document.getElementById('prof-addr').innerText = stops[i].address;
    ctx.clearRect(0,0,canvas.width,canvas.height);
}

function closeProfile() {
    document.getElementById('list-view').style.display = 'block';
    document.getElementById('customer-profile').style.display = 'none';
}

async function submitLog(status) {
    if(!driverName) return alert("Click START ROUTE first!");
    const now = new Date(), s = stops[currentStopIndex];
    const entry = { driver: driverName, customer: s.company, status: status, time: now.toLocaleTimeString(), v18l: document.getElementById('p-18l').value, vSmall: document.getElementById('p-small').value, vCases: document.getElementById('p-cases').value, r18l: document.getElementById('p-18l-ret').value, rSmall: document.getElementById('p-small-ret').value, notes: document.getElementById('p-notes').value };
    deliveryLog.push(entry);
    updateReports();
    if (currentStopIndex === stops.length - 1) {
        if(confirm("Route Complete. Run EOD?")) executeEOD();
    } else {
        currentStopIndex++; updateHeader(); updateRouteLines(); closeProfile();
        map.setView([stops[currentStopIndex].lat, stops[currentStopIndex].lng], 16);
    }
}

function updateReports() {
    const body = document.getElementById('live-body'), sum = document.getElementById('summary-data');
    body.innerHTML = ""; sum.innerHTML = "";
    deliveryLog.forEach(l => {
        body.innerHTML += `<tr><td>${l.customer}</td><td>${l.status}</td><td>${l.v18l}</td><td>${l.vSmall}</td><td>${l.vCases}</td><td>${l.r18l}</td><td>${l.rSmall}</td><td>${l.time}</td></tr>`;
        sum.innerHTML += `<div style="padding:5px; border-bottom:1px solid #444;"><b>${l.customer}</b>: ${l.status} (${l.time})</div>`;
    });
}

function renderSidebar() {
    const list = document.getElementById("stop-list"); list.innerHTML = "";
    stops.forEach((s, i) => {
        const d = document.createElement("div"); d.className = `stop-card ${s.flagged?'flagged':''}`;
        d.innerHTML = `<b>${i+1}. ${s.company}</b><br><small>${s.address}</small>`;
        d.onclick = () => openProfile(i);
        list.appendChild(d);
    });
}

async function executeEOD() {
    try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "EOD", driver: driverName, log: deliveryLog }) });
        alert("EOD Successful.");
    } catch(e) { alert("Error."); }
}

function initSignaturePad() {
    canvas = document.getElementById('sig-canvas'); ctx = canvas.getContext('2d');
    const getPos = e => { const r = canvas.getBoundingClientRect(); return { x: (e.touches?e.touches[0].clientX:e.clientX) - r.left, y: (e.touches?e.touches[0].clientY:e.clientY) - r.top }; };
    canvas.addEventListener('mousedown', e => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('mousemove', e => { if(drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); } });
    canvas.addEventListener('touchstart', e => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); if(e.cancelable) e.preventDefault(); }, {passive: false});
    canvas.addEventListener('touchmove', e => { if(drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); if(e.cancelable) e.preventDefault(); } }, {passive: false});
    window.addEventListener('mouseup', () => drawing = false);
    window.addEventListener('touchend', () => drawing = false);
}
</script>
</body>
</html>
