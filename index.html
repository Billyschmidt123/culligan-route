<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Culligan Route - Professional</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body { margin:0; height:100vh; display:flex; font-family:'Segoe UI',sans-serif; background:#111; color:white; overflow:hidden;}
    #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column;}
    #sidebar-header { padding:15px; border-bottom:1px solid #444;}
    #stop-list { flex:1; overflow-y:auto; padding:10px;}
    .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer;}
    .stop-card.flagged { border-left-color: #ffc107; background: #443c20; }
    .stop-card.rush-order { border-left-color: #a335ee; background: #331d44; border-left-width: 8px;}
    #customer-profile { display:none; padding:15px; background:#222; overflow-y:auto; height:100%; }
    .profile-group { margin-bottom:12px; }
    .profile-group label { display:block; font-size:11px; color:#0078ff; font-weight:bold; margin-bottom:4px; text-transform: uppercase;}
    .profile-group input, .profile-group textarea, .profile-group select { width:100%; padding:8px; background:#333; border:1px solid #444; color:white; border-radius:4px; box-sizing:border-box; }
    #sig-canvas { background:white; border-radius:4px; width:100%; height:150px; touch-action: none; border: 2px solid #555;}
    .form-btns { display:flex; gap:10px; margin-top:20px; padding-bottom: 40px;}
    .btn-del { flex:1; background:#28a745; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold;}
    .btn-not { flex:1; background:#dc3545; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold;}
    #main-view { flex:1; display:flex; flex-direction:column; position: relative;}
    #controls { background:#222; padding:15px; border-bottom:2px solid #0078ff; display: flex; align-items: center; gap: 10px;}
    #map { flex:1; }
    .btn { padding:10px 15px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;}
    .btn-rush { background:#a335ee; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer; font-weight:bold; width:100%; margin-top:10px;}
    .btn-mgr { background:#6c757d; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer; font-weight:bold;}
    #status { font-size:13px; color:#0078ff; font-weight: bold;}
    .number-pin { background:#0078ff; color:white; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white;}
    .rush-pin { background:#a335ee !important; }

    /* Manager Panel */
    #manager-panel { position: absolute; bottom: -100%; left: 0; width: 100%; height: 80%; background: #1a1a1a; z-index: 1000; transition: bottom 0.4s ease; border-top: 3px solid #0078ff; }
    #manager-panel.open { bottom: 0; }
    .mgr-tabs { display: flex; background: #222; border-bottom: 1px solid #444; }
    .mgr-tab-btn { padding: 15px 25px; border: none; background: none; color: #aaa; cursor: pointer; font-weight: bold; }
    .mgr-tab-btn.active { color: #0078ff; border-bottom: 2px solid #0078ff; background: #2a2a2a; }
    .mgr-content { padding: 20px; display: none; overflow-y: auto; height: calc(100% - 150px); color: white;}
    .mgr-content.active { display: block; }
    .close-mgr { position: absolute; top: 10px; right: 20px; background: none; border: none; color: #dc3545; font-size: 24px; cursor: pointer; }

    /* Modal Styling */
    .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; }
    .edit-modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#222; border:2px solid #0078ff; padding:20px; z-index:2001; width:90%; max-width:450px; border-radius:8px; max-height: 90vh; overflow-y: auto;}
    .rush-border { border-color: #a335ee !important; }
</style>
</head>

<body>

<div id="sidebar">
    <div id="list-view">
        <div id="sidebar-header">
            <h3 style="margin:0">Route Stops</h3>
            <p id="stop-count" style="font-size:12px; color:#aaa;">No route loaded</p>
        </div>
        <div id="stop-list"></div>
    </div>

    <div id="customer-profile">
        <button class="back-btn" onclick="closeProfile()">← BACK TO LIST</button>
        <h3 id="prof-name">Customer Name</h3>
        <p id="prof-addr" style="font-size:12px; color:#aaa;"></p>
        
        <div class="profile-group"><label>18L BOTTLES</label><input type="number" id="p-18l" value="0"></div>
        <div class="profile-group"><label>SMALL BOTTLES</label><input type="number" id="p-small" value="0"></div>
        <div class="profile-group"><label>18L RETURNS</label><input type="number" id="p-18l-ret" value="0"></div>
        <div class="profile-group"><label>CASES</label><input type="number" id="p-cases" value="0"></div>
        <div class="profile-group"><label>SMALL BOTTLES RETURNED</label><input type="number" id="p-small-ret" value="0"></div>
        <div class="profile-group"><label>RECEIVED BY</label><input type="text" id="p-rec-by" placeholder="Name"></div>
        <div class="profile-group"><label>NOTES / INSTRUCTIONS</label><textarea id="p-notes" rows="3"></textarea></div>
        
        <label style="font-size:11px; color:#0078ff; font-weight:bold;">SIGNATURE</label>
        <canvas id="sig-canvas"></canvas>

        <div class="form-btns">
            <button class="btn-del" onclick="submitLog('DELIVERED')">DELIVERED</button>
            <button class="btn-not" onclick="submitLog('NOT DELIVERED')">NOT DELIVERED</button>
        </div>
    </div>
</div>

<div id="main-view">
    <div id="controls">
        <select id="route-select">
            <option value="WEEK 1 MONDAY">WEEK 1 MONDAY</option>
            <option value="WEEK 1 TUESDAY">WEEK 1 TUESDAY</option>
            <option value="WEEK 1 WEDNESDAY">WEEK 1 WEDNESDAY</option>
            <option value="WEEK 1 THURSDAY">WEEK 1 THURSDAY</option>
            <option value="WEEK 1 FRIDAY">WEEK 1 FRIDAY</option>
            <option value="WEEK 2 MONDAY">WEEK 2 MONDAY</option>
            <option value="WEEK 2 TUESDAY">WEEK 2 TUESDAY</option>
            <option value="WEEK 2 WEDNESDAY">WEEK 2 WEDNESDAY</option>
            <option value="WEEK 2 THURSDAY">WEEK 2 THURSDAY</option>
            <option value="WEEK 2 FRIDAY">WEEK 2 FRIDAY</option>
            <option value="WEEK 3 MONDAY">WEEK 3 MONDAY</option>
            <option value="WEEK 3 TUESDAY">WEEK 3 TUESDAY</option>
            <option value="WEEK 3 WEDNESDAY">WEEK 3 WEDNESDAY</option>
            <option value="WEEK 3 THURSDAY">WEEK 3 THURSDAY</option>
            <option value="WEEK 3 FRIDAY">WEEK 3 FRIDAY</option>
            <option value="WEEK 4 MONDAY">WEEK 4 MONDAY</option>
            <option value="WEEK 4 TUESDAY">WEEK 4 TUESDAY</option>
            <option value="WEEK 4 WEDNESDAY">WEEK 4 WEDNESDAY</option>
            <option value="WEEK 4 THURSDAY">WEEK 4 THURSDAY</option>
            <option value="WEEK 4 FRIDAY">WEEK 4 FRIDAY</option>
            <option value="VALLEY VIEW">VALLEY VIEW</option>
            <option value="NORTH">NORTH</option>
            <option value="DAWSON CREEK">DAWSON CREEK</option>
            <option value="SALT">SALT</option>
        </select>
        <button class="btn" onclick="loadRoute()">Load Route</button>
        <button class="btn-mgr" onclick="toggleManager()">Manager Panel</button>
        <div id="status">Status: Ready</div>
    </div>
    <div id="map"></div>

    <div id="manager-panel">
        <button class="close-mgr" onclick="toggleManager()">&times;</button>
        <div class="mgr-tabs">
            <button class="mgr-tab-btn active" onclick="switchTab('customer-area')">CUSTOMER MAINTENANCE</button>
            <button class="mgr-tab-btn" onclick="switchTab('reports')">DAILY SUMMARY</button>
        </div>

        <div id="customer-area" class="mgr-content active">
            <h3 style="color:#0078ff;">Customer Database Maintenance</h3>
            <div style="background:#222; padding:15px; border:1px solid #444; border-radius:4px;">
                <label style="display:block; margin-bottom:10px; font-weight:bold; color:#0078ff;">CUSTOMER SEARCH</label>
                <input type="text" id="global-search-input" placeholder="Search by name or address..." style="width:100%; padding:10px; background:#333; border:1px solid #444; color:white; border-radius:4px; box-sizing: border-box;">
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn" style="flex: 1;" onclick="performGlobalSearch()">SEARCH DATABASE</button>
                    <button class="btn" style="flex: 1; background: #6c757d;" onclick="openAddCustomerModal()">ADD NEW CUSTOMER</button>
                </div>
                
                <button class="btn-rush" onclick="triggerRushWorkflow()">BUILD A RUSH ORDER</button>
            </div>
            
            <div id="search-results-area" style="margin-top:15px;">
                <div style="text-align:center; color:#777; padding:20px;">Results will appear here</div>
            </div>
        </div>

        <div id="reports" class="mgr-content">
             <div id="summary-data"></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="global-modal-overlay" onclick="closeGlobalModal()"></div>
<div id="global-modal" class="edit-modal">
    <h3 id="modal-title" style="color:#0078ff; margin-top:0;">Customer Details</h3>
    
    <div class="profile-group">
        <label>ASSIGN TO ROUTE / DAY</label>
        <select id="m-cust-route">
            <option value="WEEK 1 MONDAY">WEEK 1 MONDAY</option>
            <option value="WEEK 1 TUESDAY">WEEK 1 TUESDAY</option>
            <option value="WEEK 1 WEDNESDAY">WEEK 1 WEDNESDAY</option>
            <option value="WEEK 1 THURSDAY">WEEK 1 THURSDAY</option>
            <option value="WEEK 1 FRIDAY">WEEK 1 FRIDAY</option>
            <option value="WEEK 2 MONDAY">WEEK 2 MONDAY</option>
            <option value="WEEK 2 TUESDAY">WEEK 2 TUESDAY</option>
            <option value="WEEK 2 WEDNESDAY">WEEK 2 WEDNESDAY</option>
            <option value="WEEK 2 THURSDAY">WEEK 2 THURSDAY</option>
            <option value="WEEK 2 FRIDAY">WEEK 2 FRIDAY</option>
            <option value="WEEK 3 MONDAY">WEEK 3 MONDAY</option>
            <option value="WEEK 3 TUESDAY">WEEK 3 TUESDAY</option>
            <option value="WEEK 3 WEDNESDAY">WEEK 3 WEDNESDAY</option>
            <option value="WEEK 3 THURSDAY">WEEK 3 THURSDAY</option>
            <option value="WEEK 3 FRIDAY">WEEK 3 FRIDAY</option>
            <option value="WEEK 4 MONDAY">WEEK 4 MONDAY</option>
            <option value="WEEK 4 TUESDAY">WEEK 4 TUESDAY</option>
            <option value="WEEK 4 WEDNESDAY">WEEK 4 WEDNESDAY</option>
            <option value="WEEK 4 THURSDAY">WEEK 4 THURSDAY</option>
            <option value="WEEK 4 FRIDAY">WEEK 4 FRIDAY</option>
            <option value="VALLEY VIEW">VALLEY VIEW</option>
            <option value="NORTH">NORTH</option>
            <option value="DAWSON CREEK">DAWSON CREEK</option>
            <option value="SALT">SALT</option>
        </select>
    </div>

    <div class="profile-group"><label>NAME</label><input type="text" id="m-cust-name"></div>
    <div class="profile-group">
        <label>ADDRESS</label>
        <input type="text" id="m-cust-addr">
        <small style="color:#ffc107; font-size:10px; margin-top:4px; display:block;">* MUST include City and Postal Code</small>
    </div>
    <div class="profile-group"><label>PHONE NUMBER</label><input type="tel" id="m-cust-phone"></div>
    <div class="profile-group"><label>EMAIL</label><input type="email" id="m-cust-email"></div>
    <div class="profile-group"><label>NOTES</label><textarea id="m-cust-notes" rows="3"></textarea></div>

    <div style="display:flex; gap:10px; margin-top:20px;">
        <button id="modal-primary-btn" class="btn" style="flex:1;" onclick="handleModalSubmit()">SAVE</button>
        <button class="btn-not" style="flex:1;" onclick="closeGlobalModal()">CANCEL</button>
    </div>
</div>

<script>
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";
const TABS = [
    "WEEK 1 MONDAY", "WEEK 1 TUESDAY", "WEEK 1 WEDNESDAY", "WEEK 1 THURSDAY", "WEEK 1 FRIDAY",
    "WEEK 2 MONDAY", "WEEK 2 TUESDAY", "WEEK 2 WEDNESDAY", "WEEK 2 THURSDAY", "WEEK 2 FRIDAY",
    "WEEK 3 MONDAY", "WEEK 3 TUESDAY", "WEEK 3 WEDNESDAY", "WEEK 3 THURSDAY", "WEEK 3 FRIDAY",
    "WEEK 4 MONDAY", "WEEK 4 TUESDAY", "WEEK 4 WEDNESDAY", "WEEK 4 THURSDAY", "WEEK 4 FRIDAY",
    "VALLEY VIEW", "NORTH", "DAWSON CREEK", "SALT"
];
let map, markerLayer, stops = [], deliveryLog = [], pendingAlert = null, currentStopIndex = null, currentModalMode = 'add';

window.onload = () => {
    map = L.map("map").setView([55.1707, -118.7947], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    markerLayer = L.layerGroup().addTo(map);
};

function toggleManager() { document.getElementById('manager-panel').classList.toggle('open'); }
function switchTab(tabId) {
    document.querySelectorAll('.mgr-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
}

function openAddCustomerModal(name = "") {
    currentModalMode = 'add';
    document.getElementById('modal-title').innerText = "ADD NEW CUSTOMER";
    document.getElementById('modal-title').style.color = "#0078ff";
    document.getElementById('modal-primary-btn').innerText = "SAVE TO DATABASE";
    document.getElementById('m-cust-name').value = name;
    document.getElementById('m-cust-addr').value = "";
    document.getElementById('global-modal-overlay').style.display = 'block';
    document.getElementById('global-modal').style.display = 'block';
}

function openRushModal(data) {
    currentModalMode = 'rush';
    document.getElementById('modal-title').innerText = "BUILD RUSH ORDER";
    document.getElementById('modal-title').style.color = "#a335ee";
    document.getElementById('modal-primary-btn').innerText = "ALERT DRIVER & ADD";
    document.getElementById('m-cust-name').value = data.company || "";
    document.getElementById('m-cust-addr').value = data.address || "";
    if(data.tab) document.getElementById('m-cust-route').value = data.tab;
    document.getElementById('global-modal-overlay').style.display = 'block';
    document.getElementById('global-modal').style.display = 'block';
}

function closeGlobalModal() {
    document.getElementById('global-modal-overlay').style.display = 'none';
    document.getElementById('global-modal').style.display = 'none';
}

async function performGlobalSearch(isRush = false) {
    const term = document.getElementById('global-search-input').value.trim();
    if (!term) return;
    const list = document.getElementById('search-results-area');
    list.innerHTML = "Searching...";
    
    let items = [];
    for (let tab of TABS) {
        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tab)}`;
            const res = await fetch(url);
            const json = JSON.parse((await res.text()).substring(47).slice(0, -2));
            json.table.rows.forEach(row => {
                const r = row.c.map(c => c ? String(c.v) : "");
                if (r.join(" ").toLowerCase().includes(term.toLowerCase())) 
                    items.push({ company: r[2] || r[1], address: r[3], tab: tab });
            });
        } catch(e) {}
    }

    if (items.length > 0) {
        list.innerHTML = "";
        items.forEach(item => {
            const div = document.createElement("div");
            div.className = "stop-card";
            div.innerHTML = `<b>${item.company}</b><br><small>${item.address}</small>`;
            div.onclick = () => isRush ? openRushModal(item) : openAddCustomerModal(item.company);
            list.appendChild(div);
        });
    } else {
        openAddCustomerModal(term);
    }
}

async function handleModalSubmit() {
    const data = {
        company: document.getElementById('m-cust-name').value,
        address: document.getElementById('m-cust-addr').value,
        assignedRoute: document.getElementById('m-cust-route').value
    };

    if (currentModalMode === 'rush') {
        const geo = await geocodeArcGIS(data.address);
        const newStop = { ...data, lat: geo?geo.lat:55.1707, lng: geo?geo.lng:-118.7947, isRush: true };
        stops.splice(currentStopIndex === null ? 0 : currentStopIndex + 1, 0, newStop);
        pendingAlert = `RUSH ORDER: ${data.company} at ${data.address} assigned to ${data.assignedRoute}.`;
        renderSidebar(); renderRoute();
        alert("Alert Sent to Driver.");
    } else {
        alert("Customer Saved to " + data.assignedRoute);
    }
    closeGlobalModal();
}

function triggerRushWorkflow() { performGlobalSearch(true); }

async function submitLog(status) {
    closeProfile();
    if (pendingAlert) {
        setTimeout(() => { alert("⚠️ SYSTEM ALERT: " + pendingAlert); pendingAlert = null; }, 600);
    }
}

async function geocodeArcGIS(addr) {
    try {
        const res = await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(addr)}&maxLocations=1`);
        const data = await res.json();
        return data.candidates.length ? { lat: data.candidates[0].location.y, lng: data.candidates[0].location.x } : null;
    } catch (e) { return null; }
}

function renderRoute() {
    markerLayer.clearLayers();
    stops.forEach((s, i) => {
        L.marker([s.lat, s.lng], { 
            icon: L.divIcon({ className:'custom-div-icon', html:`<div class="number-pin ${s.isRush ? 'rush-pin' : ''}">${i+1}</div>` }) 
        }).addTo(markerLayer);
    });
}

function renderSidebar() {
    const list = document.getElementById("stop-list");
    list.innerHTML = "";
    stops.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = `stop-card ${s.isRush ? 'rush-order' : ''}`;
        div.innerHTML = `<b>${i+1}. ${s.company}</b>`;
        div.onclick = () => openProfile(i);
        list.appendChild(div);
    });
}
</script>
</body>
</html>
