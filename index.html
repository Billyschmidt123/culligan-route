<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Culligan Route Manager</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; height: 100vh; display: flex; flex-direction: row; font-family: 'Segoe UI', sans-serif; background: #111; color: white; overflow: hidden; }
        #sidebar { width: 350px; background: #222; border-right: 2px solid #0078ff; display: flex; flex-direction: column; flex-shrink: 0; }
        #sidebar-header { padding: 15px; border-bottom: 1px solid #444; }
        #stop-list { flex: 1; overflow-y: auto; padding: 10px; }
        .stop-card { background: #333; padding: 12px; margin-bottom: 10px; border-radius: 4px; border-left: 4px solid #0078ff; font-size: 13px; cursor: pointer; }
        .stop-card.active-card { background: #444; border-left-color: #28a745; }
        .card-label { color: #0078ff; font-weight: bold; font-size: 11px; text-transform: uppercase; display: block; margin-top: 4px; }
        .card-val { color: #eee; display: block; margin-bottom: 2px; }
        .inv-grid-sidebar { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; border-top: 1px solid #444; padding-top: 5px; }
        #main-view { flex: 1; display: flex; flex-direction: column; }
        #controls { background: #222; padding: 15px; border-bottom: 2px solid #0078ff; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #current-stop-bar { background: #0078ff; color: white; padding: 10px; font-weight: bold; text-align: center; font-size: 16px; display: none; }
        #map { flex: 1; width: 100%; }
        .btn { padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-nav { background: #444; padding: 8px 12px; }
        .btn-mgr { background: #f39c12; }
        select { padding: 9px; background: #333; color: white; border: 1px solid #444; border-radius: 4px; font-size: 14px; width: 160px; }
        
        #dataModal, #mgrModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:5000; align-items:center; justify-content:center; }
        .modal-content { background:#222; padding:20px; border-radius:8px; width:400px; border:1px solid #444; max-height: 95vh; overflow-y: auto; }
        .field-row { margin-bottom: 12px; }
        .field-row label { display: block; font-size: 12px; color: #aaa; margin-bottom: 4px; }
        .field-row input, .field-row textarea { width: 100%; padding: 8px; background: #111; border: 1px solid #444; color: white; box-sizing: border-box; border-radius: 4px; }
        .inv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #sig-canvas { background: white; border-radius: 4px; cursor: crosshair; width: 100%; height: 100px; }
        .nav-container { display: flex; justify-content: space-between; padding: 10px; background: #222; border-top: 1px solid #444; }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="sidebar-header">
        <h3 style="margin:0">Route List</h3>
        <p id="stop-count" style="font-size: 12px; color: #aaa; margin: 5px 0 10px 0;">No route loaded</p>
        <button class="btn btn-mgr" style="width:100%;" onclick="openManagerMenu()">Manager Menu</button>
    </div>
    <div id="stop-list"></div>
    <div class="nav-container">
        <button class="btn btn-nav" onclick="prevStop()">⬅ Previous</button>
        <button class="btn btn-nav" onclick="nextStop()">Next ➡</button>
    </div>
</div>

<div id="main-view">
    <div id="controls">
        <select id="routeSelector"><option value="">Fetch Routes...</option></select>
        <button class="btn" onclick="loadSelectedRoute()">Load Route</button>
        <div id="status" style="font-size: 13px; color: #aaa;">Status: Ready</div>
    </div>
    <div id="current-stop-bar">Current Stop: <span id="active-addr">None</span></div>
    <div id="map"></div>
</div>

<div id="dataModal">
    <div class="modal-content">
        <h3 id="mCustName" style="color:#0078ff; margin-top:0;">Customer</h3>
        <p id="mCustAddr" style="color:#aaa; font-size:13px; margin-bottom:15px;"></p>
        
        <div class="inv-grid">
            <div class="field-row"><label>18L Bottles</label><input type="number" id="inv18L"></div>
            <div class="field-row"><label>Small Bottles</label><input type="number" id="invSmall"></div>
            <div class="field-row"><label>Cases</label><input type="number" id="invCases"></div>
            <div class="field-row"><label>18L Return</label><input type="number" id="ret18L"></div>
            <div class="field-row"><label>Small Return</label><input type="number" id="retSmall"></div>
            <div class="field-row"><label>Received By</label><input type="text" id="receivedBy"></div>
        </div>

        <div class="field-row"><label>Signature</label><canvas id="sig-canvas"></canvas><button class="btn btn-nav" style="width:100%; margin-top:5px;" onclick="clearSig()">Clear Signature</button></div>
        <div class="field-row"><label>Notes / Reason for Skip</label><textarea id="driverNotes" rows="2"></textarea></div>
        
        <button class="btn" style="width:100%; background:#0078ff; margin-bottom:10px;" onclick="openGoogleMaps()">Google Maps</button>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="flex:1;" onclick="processStop('Delivered')">DELIVERED</button>
            <button class="btn" style="flex:1; background:#dc3545;" onclick="processStop('Not Delivered')">SKIPPED</button>
        </div>
        <button class="btn" style="width:100%; background:#444; margin-top:10px;" onclick="closeModal()">Close</button>
    </div>
</div>

<div id="mgrModal">
    <div class="modal-content">
        <h3 style="color:#f39c12; margin-top:0;">Manager Details</h3>
        <div id="mgrFields"></div>
        <button class="btn" style="width:100%; background:#444; margin-top:10px;" onclick="document.getElementById('mgrModal').style.display='none'">Close</button>
    </div>
</div>

<script>
    const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbyECaDUnW3yvG5J8dWmT1a-5YTykHuwDxEiAgByH91A5zAwIzONqV64_r9olmyd07MSMA/exec";
    let map, markerLayer, routeLine, stops = [], markers = [], activeIndex = -1, canvas, ctx, drawing = false;
    const warehouse = { lat: 55.1707, lng: -118.7947 };

    async function fetchRouteList() {
        try {
            const res = await fetch(SHEETS_API_URL);
            const tabs = await res.json();
            const selector = document.getElementById('routeSelector');
            selector.innerHTML = "";
            tabs.filter(t => t !== 'Deliveries').forEach(tabName => {
                let opt = document.createElement('option'); opt.value = tabName; opt.innerHTML = tabName; selector.appendChild(opt);
            });
            document.getElementById('status').textContent = "Routes Loaded.";
        } catch (e) { document.getElementById('status').textContent = "Error."; }
    }

    async function loadSelectedRoute() {
        const selectedTab = document.getElementById('routeSelector').value;
        if (!selectedTab) return;
        document.getElementById('status').textContent = `Loading...`;
        try {
            const dataRes = await fetch(`${SHEETS_API_URL}?sheet=${encodeURIComponent(selectedTab)}`);
            const rows = await dataRes.json();
            const h = Object.keys(rows[0]);
            const addrKey = h.find(k => k.toLowerCase().includes("addr"));
            const nameKey = h.find(k => k.toLowerCase().includes("comp") || k.toLowerCase().includes("cust"));
            const phoneKey = h.find(k => k.toLowerCase().includes("phone"));
            const noteKey = h.find(k => k.toLowerCase().includes("note"));
            
            // New column matches
            const key18L = h.find(k => k.includes("18 l bottles") || k.includes("18L"));
            const keySmall = h.find(k => k.includes("small bottles"));
            const keyCases = h.find(k => k.includes("cases"));

            let tempStops = [];
            for (let i = 0; i < rows.length; i++) {
                document.getElementById('status').textContent = `Mapping ${i + 1}/${rows.length}...`;
                const geo = await geocodeAddress(rows[i][addrKey]);
                if (geo) tempStops.push({ 
                    company: rows[i][nameKey] || "Stop", 
                    address: rows[i][addrKey], 
                    phone: rows[i][phoneKey] || "N/A",
                    notes: rows[i][noteKey] || "No instructions",
                    inv18L: rows[i][key18L] || 0,
                    invSmall: rows[i][keySmall] || 0,
                    invCases: rows[i][keyCases] || 0,
                    fullData: rows[i], ...geo 
                });
                await new Promise(r => setTimeout(r, 1200));
            }
            stops = optimizeRoute(tempStops);
            renderRoute(); updateSidebar();
            document.getElementById('status').textContent = "Ready.";
        } catch (e) { document.getElementById('status').textContent = "Failed."; }
    }

    async function geocodeAddress(address) {
        try {
            const query = encodeURIComponent(address + ", Grande Prairie, AB");
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
            const data = await res.json();
            return data.length > 0 ? { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) } : null;
        } catch (e) { return null; }
    }

    function optimizeRoute(rawList) {
        let unvisited = [...rawList], ordered = [], currentPos = warehouse;
        while (unvisited.length > 0) {
            unvisited.sort((a, b) => getDistance(currentPos, a) - getDistance(currentPos, b));
            let closest = unvisited.shift(); ordered.push(closest); currentPos = closest;
        }
        return ordered;
    }

    function getDistance(p1, p2) {
        const R = 6371;
        const dLat = (p2.lat - p1.lat) * Math.PI / 180;
        const dLon = (p2.lng - p1.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function renderRoute() {
        markerLayer.clearLayers(); markers = [];
        let pathCoords = [[warehouse.lat, warehouse.lng]];
        stops.forEach((s, i) => {
            pathCoords.push([s.lat, s.lng]);
            const m = L.marker([s.lat, s.lng], {
                icon: L.divIcon({ className: 'custom-div-icon', html: `<div class="number-pin">${i + 1}</div>`, iconSize: [30, 42], iconAnchor: [15, 21] })
            }).addTo(markerLayer).bindPopup(`<b>${i+1}. ${s.company}</b>`);
            markers.push(m);
        });
        if (stops.length > 0) pathCoords.push([warehouse.lat, warehouse.lng]);
        routeLine.setLatLngs(pathCoords);
        if (stops.length > 0) map.fitBounds(L.latLngBounds(pathCoords), { padding: [50, 50] });
    }

    function updateSidebar() {
        const listDiv = document.getElementById('stop-list');
        listDiv.innerHTML = '';
        document.getElementById('stop-count').innerText = `${stops.length} Stops`;
        stops.forEach((s, i) => {
            const card = document.createElement('div');
            card.className = `stop-card ${i === activeIndex ? 'active-card' : ''}`;
            card.innerHTML = `
                <b style="font-size:15px;">#${i + 1} ${s.company}</b>
                <span class="card-label">Address</span><span class="card-val">${s.address}</span>
                <span class="card-label">Notes</span><span class="card-val" style="font-style:italic; color:#aaa;">${s.notes}</span>
                <div class="inv-grid-sidebar">
                    <span>18L: ${s.inv18L}</span>
                    <span>Small: ${s.invSmall}</span>
                    <span>Cases: ${s.invCases}</span>
                </div>
            `;
            card.onclick = () => selectStop(i);
            listDiv.appendChild(card);
        });
    }

    function selectStop(index) {
        if (index < 0 || index >= stops.length) return;
        activeIndex = index;
        const s = stops[index];
        document.getElementById('current-stop-bar').style.display = 'block';
        document.getElementById('active-addr').innerText = s.address;
        map.setView([s.lat, s.lng], 16);
        markers[index].openPopup();
        updateSidebar();
        openEntryModal(s);
    }

    function nextStop() { if (activeIndex < stops.length - 1) selectStop(activeIndex + 1); }
    function prevStop() { if (activeIndex > 0) selectStop(activeIndex - 1); }

    function openEntryModal(s) {
        document.getElementById('mCustName').innerText = s.company;
        document.getElementById('mCustAddr').innerText = s.address;
        document.getElementById('inv18L').value = s.inv18L;
        document.getElementById('invSmall').value = s.invSmall;
        document.getElementById('invCases').value = s.invCases;
        document.getElementById('ret18L').value = "";
        document.getElementById('retSmall').value = "";
        document.getElementById('receivedBy').value = "";
        document.getElementById('driverNotes').value = "";
        clearSig();
        document.getElementById('dataModal').style.display = 'flex';
        initCanvas();
    }

    function initCanvas() {
        canvas = document.getElementById('sig-canvas');
        ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
        canvas.onmousedown = (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
        canvas.onmousemove = (e) => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
        window.onmouseup = () => { drawing = false; };
        // Touch support
        canvas.ontouchstart = (e) => { e.preventDefault(); drawing = true; const t = e.touches[0]; const r = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(t.clientX - r.left, t.clientY - r.top); };
        canvas.ontouchmove = (e) => { e.preventDefault(); if (drawing) { const t = e.touches[0]; const r = canvas.getBoundingClientRect(); ctx.lineTo(t.clientX - r.left, t.clientY - r.top); ctx.stroke(); } };
    }
    function clearSig() { if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height); }

    function openManagerMenu() {
        const pin = prompt("Manager PIN:");
        if (pin !== "5678") return alert("Denied");
        if (activeIndex === -1) return alert("Select a stop.");
        const s = stops[activeIndex];
        const f = document.getElementById('mgrFields'); f.innerHTML = "";
        for (const [k, v] of Object.entries(s.fullData)) { f.innerHTML += `<div class="field-row"><label>${k}</label><input type="text" value="${v}" readonly></div>`; }
        document.getElementById('mgrModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById("dataModal").style.display = "none"; }

    async function processStop(status) {
        const notes = document.getElementById('driverNotes').value;
        const receiver = document.getElementById('receivedBy').value;
        if (status === 'Not Delivered' && !notes.trim()) return alert("Reason required for skip.");
        const now = new Date();
        let formData = { 
            Customer: stops[activeIndex].company, 
            Address: stops[activeIndex].address, 
            Status: status, 
            Timestamp: now.toLocaleString(), 
            Notes: notes, 
            ReceivedBy: receiver, 
            Del18L: document.getElementById('inv18L').value,
            DelSmall: document.getElementById('invSmall').value,
            DelCases: document.getElementById('invCases').value,
            Ret18L: document.getElementById('ret18L').value,
            RetSmall: document.getElementById('retSmall').value,
            Signature: canvas.toDataURL() 
        };
        fetch(SHEETS_API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(formData) }).then(() => { closeModal(); alert(`Recorded.`); });
    }

    function openGoogleMaps() { window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(stops[activeIndex].address + ", Grande Prairie, AB")}`, '_blank'); }

    window.onload = async () => {
        const pw = prompt("Driver access code:");
        if (pw !== "1234") { document.body.innerHTML = "<h1>Access Denied</h1>"; return; }
        map = L.map("map").setView([warehouse.lat, warehouse.lng], 11);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        markerLayer = L.layerGroup().addTo(map);
        routeLine = L.polyline([], { color: '#0078ff', weight: 5, opacity: 0.7 }).addTo(map);
        L.marker([warehouse.lat, warehouse.lng], { icon: L.divIcon({ className: 'custom-div-icon', html: `<div class="number-pin warehouse-pin">W</div>`, iconSize: [30, 42], iconAnchor: [15, 21] }) }).addTo(map);
        fetchRouteList();
    };
</script>
</body>
</html>
