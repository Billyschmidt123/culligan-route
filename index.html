<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Culligan Route Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin:0; height:100vh; display:flex; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#1a1a1a; color:white; overflow:hidden;}
        #sidebar { width:380px; background:#252525; border-right:3px solid #0078ff; display:flex; flex-direction:column; box-shadow: 4px 0 15px rgba(0,0,0,0.5); z-index:10;}
        #stop-list { flex:1; overflow-y:auto; padding:15px; gap:10px; display:flex; flex-direction:column; }
        .stop-card { background:#333; padding:15px; border-radius:8px; border-left:5px solid #0078ff; cursor:pointer; transition: transform 0.2s; position:relative;}
        .stop-card:hover { transform: scale(1.02); background:#3d3d3d; }
        .sheet-label { position:absolute; top:8px; right:8px; font-size:9px; background:#0078ff; padding:2px 6px; border-radius:10px; text-transform:uppercase;}
        #main-view { flex:1; position: relative; display:flex; flex-direction:column;}
        #map { flex:1; }
        #controls { background:#252525; padding:20px; border-bottom:1px solid #444; display:flex; gap:12px; align-items:center;}
        .btn { padding:12px 20px; background:#0078ff; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; transition: 0.2s;}
        .btn:hover { background:#0056b3; }
        input { padding:12px; background:#333; border:1px solid #444; color:white; border-radius:6px; flex:1; font-size:16px;}
        #loader { display:none; color:#0078ff; font-weight:bold; margin-left:10px; animation: blink 1s infinite;}
        @keyframes blink { 0% {opacity:1} 50% {opacity:0.3} 100% {opacity:1}}
    </style>
</head>
<body>

<div id="sidebar">
    <div style="padding:20px; background:#0078ff;">
        <h2 style="margin:0; font-size:20px;">Culligan Water</h2>
        <div id="status" style="font-size:12px; margin-top:5px; opacity:0.9;">System Ready</div>
    </div>
    <div id="stop-list">
        <div style="text-align:center; margin-top:50px; color:#666;">
            Search for a customer name to begin
        </div>
    </div>
</div>

<div id="main-view">
    <div id="controls">
        <input type="text" id="search-input" placeholder="Type Company Name (e.g. Rexall)">
        <button class="btn" onclick="searchAll()">Search Route</button>
        <span id="loader">SCANNING SHEETS...</span>
    </div>
    <div id="map"></div>
</div>

<script>
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";
// These are the exact names from your file tabs
const TABS = [
    "Week 1 Monday", "Week 1 Tuesday", "Week 1 Wednessday", "Week 1 Thursday", "Week 1 Friday",
    "Week 2 Monday", "Week 2 Tuesday", "week 2 tues north ", "Week 2 Wednessday", "Week 2 Thursday", "Week 2 Friday",
    "Week 3 Monday ", "Week 3 Tuesday", "Week 3 Wednessday", "Week3 Thursday", "Week 3 Friday",
    "Week 4 Monday ", "Week 4 Tuesday", "Week 4 Wednessday", "Week 4 Thursday ", "Week 4 Friday",
    "Valleyview ", "North", "Dawson creek", "Salt"
];

let map = L.map("map").setView([55.1707, -118.7947], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: 'Â© OpenStreetMap'
}).addTo(map);

async function searchAll() {
    const term = document.getElementById('search-input').value.trim().toLowerCase();
    if(!term) return;

    const list = document.getElementById('stop-list');
    const loader = document.getElementById('loader');
    const status = document.getElementById('status');
    
    list.innerHTML = "";
    loader.style.display = "inline";
    status.innerText = "Searching all weeks...";

    let foundCount = 0;

    for (let tab of TABS) {
        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tab)}`;
            const res = await fetch(url);
            const text = await res.text();
            const json = JSON.parse(text.substring(47).slice(0, -2));
            
            if (json.table && json.table.rows) {
                json.table.rows.forEach(row => {
                    // Combine all cell data to search
                    const content = row.c.map(c => c ? String(c.v).toLowerCase() : "").join(" ");
                    if (content.includes(term)) {
                        foundCount++;
                        addResultToUI(row, tab);
                    }
                });
            }
        } catch (e) {
            console.error("Error reading tab: " + tab);
        }
    }

    loader.style.display = "none";
    status.innerText = `Found ${foundCount} matches`;
    if(foundCount === 0) list.innerHTML = `<div style="padding:20px; color:#ff4d4d;">No results found for "${term}". Check spelling or sharing permissions.</div>`;
}

function addResultToUI(row, tabName) {
    const list = document.getElementById('stop-list');
    // Map columns: 2 is Company, 3 is Address
    const company = row.c[2] ? row.c[2].v : "Unknown Company";
    const address = row.c[3] ? row.c[3].v : "No Address";
    const phone = row.c[5] ? row.c[5].v : "";
    const notes = row.c[6] ? row.c[6].v : "";

    const card = document.createElement('div');
    card.className = 'stop-card';
    card.innerHTML = `
        <span class="sheet-label">${tabName}</span>
        <div style="font-weight:bold; color:#0078ff; margin-bottom:4px; padding-right:60px;">${company}</div>
        <div style="font-size:13px; color:#bbb;">${address}</div>
        ${phone ? `<div style="font-size:12px; color:#2ecc71; margin-top:5px;">ðŸ“ž ${phone}</div>` : ''}
        ${notes ? `<div style="font-size:11px; color:#999; margin-top:5px; font-style:italic;">Note: ${notes}</div>` : ''}
    `;
    
    card.onclick = () => {
        // Simple search on map for address
        const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ", Grande Prairie")}`;
        fetch(searchUrl).then(r => r.json()).then(data => {
            if(data.length > 0) {
                const loc = [data[0].lat, data[0].lon];
                map.setView(loc, 15);
                L.marker(loc).addTo(map).bindPopup(`<b>${company}</b><br>${address}`).openPopup();
            } else {
                alert("Could not find address on map, but customer is in the list.");
            }
        });
    };
    
    list.appendChild(card);
}
</script>
</body>
</html>
