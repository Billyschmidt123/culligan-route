<div id="lock-screen" style="position:fixed; inset:0; background:#111; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <h2 style="color:#0078ff;">CULLIGAN ACCESS</h2>
    <input type="password" id="pass-input" placeholder="Enter PIN" style="padding:15px; font-size:20px; text-align:center; border-radius:8px; border:none; margin-bottom:10px;">
    <button class="btn" onclick="checkUnlock()" style="width:200px; padding:15px;">UNLOCK</button>
</div>

<div id="controls">
    <select id="route-select">
        </select>
    <button class="btn" style="background:#0078ff;" onclick="loadRoute()">Load Route</button>
    <button id="start-btn" class="btn" style="background:#28a745; display:none;" onclick="startRoute()">START ROUTE</button>
    <button class="btn-mgr" onclick="mgrUnlock()">Manager Panel</button>
    <div id="status">Status: Locked</div>
</div>

<script>
let driverName = "";

// Security Logic
function checkUnlock() {
    const pin = document.getElementById('pass-input').value;
    if (pin === "1234") {
        document.getElementById('lock-screen').style.display = 'none';
        document.getElementById('status').innerText = "Ready";
    } else {
        alert("Incorrect PIN");
    }
}

function mgrUnlock() {
    const pin = prompt("Enter Manager PIN:");
    if (pin === "5678") {
        toggleManager();
    } else {
        alert("Access Denied");
    }
}

// Start Route Logic
function startRoute() {
    const name = prompt("Please enter your name to start the route:");
    if (name && name.trim() !== "") {
        driverName = name;
        document.getElementById('start-btn').style.display = 'none';
        alert(`Route Started. Good luck, ${driverName}!`);
        document.getElementById('status').innerText = `Driver: ${driverName}`;
    } else {
        alert("Driver name is required to start.");
    }
}

// Updated loadRoute to include Warehouse Return & Start Button
async function loadRoute() {
    const sheetName = document.getElementById("route-select").value;
    document.getElementById("status").innerText = "Reading Sheet...";
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;
        const cols = json.table.cols;
        
        const addrIdx = cols.findIndex(c => c.label && c.label.toLowerCase().includes('addr'));
        const compIdx = cols.findIndex(c => c.label && (c.label.toLowerCase().includes('comp') || c.label.toLowerCase().includes('cust')));
        const phoneIdx = cols.findIndex(c => c.label && c.label.toLowerCase().includes('phone'));
        
        let rawStops = [];
        for (let i = 0; i < rows.length; i++) {
            const rowData = rows[i].c;
            const address = rowData[addrIdx] ? rowData[addrIdx].v.toString() : "";
            if (!address || address.includes("http") || address.toLowerCase().includes("address")) continue;
            
            let geo = await geocodeArcGIS(address);
            let flagged = !geo;
            if(flagged) geo = { lat: warehouse[0], lng: warehouse[1] };

            rawStops.push({ 
                company: (rowData[compIdx] && rowData[compIdx].v) ? rowData[compIdx].v : "Customer", 
                address: address, 
                phone: (rowData[phoneIdx] && rowData[phoneIdx].v) ? rowData[phoneIdx].v : "No Phone",
                flagged: flagged, ...geo 
            });
            await new Promise(r => setTimeout(r, 600)); 
        }

        // Circular Optimization Logic
        stops = [];
        let remaining = [...rawStops];
        let currentPos = { lat: warehouse[0], lng: warehouse[1] };

        while (remaining.length > 0) {
            let closestIdx = 0;
            let minDist = Infinity;
            for (let i = 0; i < remaining.length; i++) {
                let d = Math.sqrt(Math.pow(remaining[i].lat - currentPos.lat, 2) + Math.pow(remaining[i].lng - currentPos.lng, 2));
                if (d < minDist) { minDist = d; closestIdx = i; }
            }
            let nextStop = remaining.splice(closestIdx, 1)[0];
            stops.push(nextStop);
            currentPos = { lat: nextStop.lat, lng: nextStop.lng };
        }

        // AUTO-ADD WAREHOUSE RETURN
        stops.push({
            company: "WAREHOUSE (END ROUTE)",
            address: "8805 111 St, Grande Prairie, AB",
            phone: "OFFICE",
            lat: warehouse[0],
            lng: warehouse[1],
            flagged: false
        });

        currentStopIndex = 0;
        renderRoute();
        renderSidebar();
        updateHeader();
        document.getElementById('start-btn').style.display = 'inline-block';
        document.getElementById("status").innerText = "Route Optimized. Click START.";
    } catch (e) { 
        document.getElementById("status").innerText = "Error Loading Route."; 
    }
}

// Include Driver Name in the Delivery Log
async function submitLog(status) {
    if (driverName === "") {
        alert("You must click START ROUTE and enter your name first!");
        return;
    }
    
    const now = new Date();
    const s = stops[currentStopIndex];
    const entry = {
        driver: driverName, // Recorded Name
        customer: s.company, 
        status: status, 
        time: now.toLocaleTimeString(),
        // ... (rest of the entry object same as before)
    };
    
    // ... (rest of the submitLog logic remains the same)
}
</script>
