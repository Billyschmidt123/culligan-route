<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Culligan Route - Professional</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body { margin:0; height:100vh; display:flex; font-family:'Segoe UI',sans-serif; background:#111; color:white; overflow:hidden;}
    #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column;}
    #sidebar-header { padding:15px; border-bottom:1px solid #444;}
    #stop-list { flex:1; overflow-y:auto; padding:10px;}
    .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer;}
    .stop-card.flagged { border-left-color: #ffc107; background: #443c20; }
    .stop-card:hover { background:#444;}
    #customer-profile { display:none; padding:15px; background:#222; overflow-y:auto; height:100%; }
    .profile-group { margin-bottom:12px; }
    .profile-group label { display:block; font-size:11px; color:#0078ff; font-weight:bold; margin-bottom:4px; text-transform: uppercase;}
    .profile-group input, .profile-group textarea { width:100%; padding:8px; background:#333; border:1px solid #444; color:white; border-radius:4px; box-sizing:border-box; }
    #sig-canvas { background:white; border-radius:4px; width:100%; height:150px; touch-action: none; border: 2px solid #555;}
    .form-btns { display:flex; gap:10px; margin-top:20px; padding-bottom: 40px;}
    .btn-del { flex:1; background:#28a745; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold;}
    .btn-not { flex:1; background:#dc3545; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer; font-weight:bold;}
    .back-btn { background:none; border:none; color:#0078ff; cursor:pointer; padding:0; margin-bottom:10px; font-weight: bold;}
    #main-view { flex:1; display:flex; flex-direction:column; position: relative;}
    #controls { background:#222; padding:15px; border-bottom:2px solid #0078ff; display: flex; align-items: center; gap: 10px;}
    #map { flex:1; }
    .btn { padding:10px 15px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;}
    .btn-mgr { background:#6c757d; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer; font-weight:bold;}
    #status { font-size:13px; color:#0078ff; font-weight: bold;}
    #route-select { padding: 10px; background: #333; color: white; border: 1px solid #0078ff; border-radius: 4px; }
    .custom-div-icon { background:transparent; border:none;}
    .number-pin { background:#0078ff; color:white; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white;}

    /* Manager Panel Overlay */
    #manager-panel { position: absolute; bottom: -100%; left: 0; width: 100%; height: 80%; background: #1a1a1a; z-index: 1000; transition: bottom 0.4s ease; border-top: 3px solid #0078ff; }
    #manager-panel.open { bottom: 0; }
    .mgr-tabs { display: flex; background: #222; border-bottom: 1px solid #444; }
    .mgr-tab-btn { padding: 15px 25px; border: none; background: none; color: #aaa; cursor: pointer; font-weight: bold; }
    .mgr-tab-btn.active { color: #0078ff; border-bottom: 2px solid #0078ff; background: #2a2a2a; }
    .mgr-content { padding: 20px; display: none; overflow-y: auto; height: calc(100% - 150px); color: white;}
    .mgr-content.active { display: block; }
    .close-mgr { position: absolute; top: 10px; right: 20px; background: none; border: none; color: #dc3545; font-size: 24px; cursor: pointer; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
    th, td { border: 1px solid #444; padding: 8px; text-align: left; }
    th { background: #333; color: #0078ff; }
    .mgr-footer { padding: 20px; background: #222; border-top: 1px solid #444; position: sticky; bottom: 0; }
    .btn-eod { background: #ffc107; color: black; width: 100%; padding: 15px; font-size: 18px; cursor: pointer; border-radius: 4px; font-weight: bold; border: none;}
</style>
</head>

<body>

<div id="sidebar">
    <div id="list-view">
        <div id="sidebar-header">
            <h3 style="margin:0">Route Stops</h3>
            <p id="stop-count" style="font-size:12px; color:#aaa;">No route loaded</p>
        </div>
        <div id="stop-list"></div>
    </div>

    <div id="customer-profile">
        <button class="back-btn" onclick="closeProfile()">← BACK TO LIST</button>
        <h3 id="prof-name">Customer Name</h3>
        <p id="prof-addr" style="font-size:12px; color:#aaa;"></p>
        
        <div class="profile-group"><label>18L BOTTLES</label><input type="number" id="p-18l" value="0"></div>
        <div class="profile-group"><label>SMALL BOTTLES</label><input type="number" id="p-small" value="0"></div>
        <div class="profile-group"><label>18L RETURNS</label><input type="number" id="p-18l-ret" value="0"></div>
        <div class="profile-group"><label>CASES</label><input type="number" id="p-cases" value="0"></div>
        <div class="profile-group"><label>SMALL BOTTLES RETURNED</label><input type="number" id="p-small-ret" value="0"></div>
        <div class="profile-group"><label>RECEIVED BY</label><input type="text" id="p-rec-by" placeholder="Name"></div>
        <div class="profile-group"><label>NOTES / INSTRUCTIONS</label><textarea id="p-notes" rows="3"></textarea></div>
        
        <label style="font-size:11px; color:#0078ff; font-weight:bold;">SIGNATURE</label>
        <canvas id="sig-canvas"></canvas>

        <div class="form-btns">
            <button class="btn-del" onclick="submitLog('DELIVERED')">DELIVERED</button>
            <button class="btn-not" onclick="submitLog('NOT DELIVERED')">NOT DELIVERED</button>
        </div>
    </div>
</div>

<div id="main-view">
    <div id="controls">
        <select id="route-select">
            <option value="WEEK 1 MONDAY">WEEK 1 MONDAY</option>
            <option value="WEEK 1 TUESDAY">WEEK 1 TUESDAY</option>
            <option value="WEEK 1 WEDNESDAY">WEEK 1 WEDNESDAY</option>
            <option value="WEEK 1 THURSDAY">WEEK 1 THURSDAY</option>
            <option value="WEEK 1 FRIDAY">WEEK 1 FRIDAY</option>
            <option value="WEEK 2 MONDAY">WEEK 2 MONDAY</option>
            <option value="WEEK 2 TUESDAY">WEEK 2 TUESDAY</option>
            <option value="WEEK 2 WEDNESDAY">WEEK 2 WEDNESDAY</option>
            <option value="WEEK 2 THURSDAY">WEEK 2 THURSDAY</option>
            <option value="WEEK 2 FRIDAY">WEEK 2 FRIDAY</option>
            <option value="WEEK 3 MONDAY">WEEK 3 MONDAY</option>
            <option value="WEEK 3 TUESDAY">WEEK 3 TUESDAY</option>
            <option value="WEEK 3 WEDNESDAY">WEEK 3 WEDNESDAY</option>
            <option value="WEEK 3 THURSDAY">WEEK 3 THURSDAY</option>
            <option value="WEEK 3 FRIDAY">WEEK 3 FRIDAY</option>
            <option value="WEEK 4 MONDAY">WEEK 4 MONDAY</option>
            <option value="WEEK 4 TUESDAY">WEEK 4 TUESDAY</option>
            <option value="WEEK 4 WEDNESDAY">WEEK 4 WEDNESDAY</option>
            <option value="WEEK 4 THURSDAY">WEEK 4 THURSDAY</option>
            <option value="WEEK 4 FRIDAY">WEEK 4 FRIDAY</option>
            <option value="VALLEY VIEW">VALLEY VIEW</option>
            <option value="NORTH">NORTH</option>
            <option value="DAWSON CREEK">DAWSON CREEK</option>
            <option value="SALT">SALT</option>
        </select>
        <button class="btn" onclick="loadRoute()">Load Route</button>
        <button class="btn-mgr" onclick="toggleManager()">Manager Panel</button>
        <div id="status">Status: Ready</div>
    </div>
    <div id="map"></div>

    <div id="manager-panel">
        <button class="close-mgr" onclick="toggleManager()">&times;</button>
        <div class="mgr-tabs">
            <button class="mgr-tab-btn active" onclick="switchTab('reports')">DAILY SUMMARY</button>
            <button class="mgr-tab-btn" onclick="switchTab('live-report')">LIVE REPORT</button>
            <button class="mgr-tab-btn" onclick="switchTab('global-search-tab')">GLOBAL SEARCH</button>
        </div>
        
        <div id="reports" class="mgr-content active">
            <h2 style="color:#0078ff; text-align:center;">DAILY SUMMARY CULLIGAN BOTTLE WATER</h2>
            <div id="summary-data"></div>
        </div>
        
        <div id="live-report" class="mgr-content">
            <h3>LIVE REPORT (ACTIVE TRACKING)</h3>
            <table id="live-table">
                <thead>
                    <tr><th>Customer</th><th>Status</th><th>18L</th><th>Small</th><th>Cases</th><th>Ret 18L</th><th>Ret Small</th><th>Time</th></tr>
                </thead>
                <tbody id="live-body"></tbody>
            </table>
            <div id="live-totals" style="margin-top:20px; background:#222; padding:15px; border:1px solid #444;"></div>
        </div>

        <div id="global-search-tab" class="mgr-content">
            <h3>SEARCH ALL ROUTES</h3>
            <input type="text" id="global-search-input" placeholder="Enter Company Name..." style="width:100%; padding:12px; margin-bottom:10px; background:#333; color:white; border:1px solid #0078ff;">
            <button class="btn" onclick="runGlobalSearch()" style="width:100%;">Execute Global Search</button>
            
            <div id="search-progress-container" style="margin-top:15px; display:none;">
                <div style="font-size:11px; color:#0078ff; margin-bottom:5px;">SCANNING DATABASE...</div>
                <div style="width:100%; background:#333; height:10px; border-radius:5px; overflow:hidden;">
                    <div id="search-bar-fill" style="width:0%; height:100%; background:#0078ff; transition: width 0.3s;"></div>
                </div>
                <div id="current-sheet-name" style="font-size:10px; color:#aaa; margin-top:5px;">Preparing...</div>
            </div>
            
            <div id="search-results-list" style="margin-top:20px;"></div>
        </div>

        <div class="mgr-footer">
            <button class="btn-eod" onclick="executeEOD()">END OF DAY</button>
        </div>
    </div>
</div>

<script>
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMfGuDRFTGBWyrG2CVFVOBSUzyORpxd4aTVZaStpuF54zkryeKdFU0PLIIaIgk-w0M/exec";

let map, markerLayer, canvas, ctx, drawing = false;
let stops = [];
let deliveryLog = [];
let currentStopIndex = null;
const warehouse = [55.1707, -118.7947];

window.onload = () => {
    map = L.map("map").setView(warehouse, 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    markerLayer = L.layerGroup().addTo(map);
    initSignaturePad();
};

function toggleManager() { document.getElementById('manager-panel').classList.toggle('open'); }
function switchTab(tabId) {
    document.querySelectorAll('.mgr-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.mgr-tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
}

async function runGlobalSearch() {
    const term = document.getElementById('global-search-input').value.trim();
    const progressContainer = document.getElementById('search-progress-container');
    const barFill = document.getElementById('search-bar-fill');
    const sheetText = document.getElementById('current-sheet-name');
    const resultsDiv = document.getElementById('search-results-list');
    
    if(!term) return alert("Please enter a name to search.");
    
    resultsDiv.innerHTML = "";
    progressContainer.style.display = "block";
    barFill.style.width = "0%";
    
    const routes = [
        "WEEK 1 MONDAY", "WEEK 1 TUESDAY", "WEEK 1 WEDNESDAY", "WEEK 1 THURSDAY", "WEEK 1 FRIDAY",
        "WEEK 2 MONDAY", "WEEK 2 TUESDAY", "WEEK 2 WEDNESDAY", "WEEK 2 THURSDAY", "WEEK 2 FRIDAY",
        "WEEK 3 MONDAY", "WEEK 3 TUESDAY", "WEEK 3 WEDNESDAY", "WEEK 3 THURSDAY", "WEEK 3 FRIDAY",
        "WEEK 4 MONDAY", "WEEK 4 TUESDAY", "WEEK 4 WEDNESDAY", "WEEK 4 THURSDAY", "WEEK 4 FRIDAY",
        "VALLEY VIEW", "NORTH", "DAWSON CREEK", "SALT"
    ];

    let allFound = [];

    for (let i = 0; i < routes.length; i++) {
        const route = routes[i];
        const percent = Math.round(((i + 1) / routes.length) * 100);
        barFill.style.width = percent + "%";
        sheetText.innerText = `Searching: ${route}`;

        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(route)}`;
            const res = await fetch(url);
            const text = await res.text();
            const json = JSON.parse(text.substring(47).slice(0, -2));
            
            const rows = json.table.rows;
            rows.forEach(row => {
                const company = row.c[0] ? row.c[0].v.toString() : "";
                const address = row.c[1] ? row.c[1].v.toString() : "";
                if (company.toLowerCase().includes(term.toLowerCase())) {
                    allFound.push({ company, address, route });
                }
            });
        } catch (e) { console.log("Error scanning " + route); }
    }

    sheetText.innerText = "SCAN COMPLETE";
    if (allFound.length === 0) {
        resultsDiv.innerHTML = `<div style="padding:15px; background:#442222; border-radius:4px; color:#ff8888;">No customers found matching "${term}" in any route.</div>`;
    } else {
        allFound.forEach(item => {
            const card = document.createElement('div');
            card.style = "background:#2a2a2a; padding:12px; margin-bottom:8px; border-left:4px solid #0078ff; border-radius:4px;";
            card.innerHTML = `<b>${item.company}</b><br><small>${item.address}</small><br><span style="color:#0078ff; font-size:10px;">Found in: ${item.route}</span>`;
            resultsDiv.appendChild(card);
        });
    }
}

function initSignaturePad() {
    canvas = document.getElementById('sig-canvas');
    ctx = canvas.getContext('2d');
    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: (clientX - rect.left) * (canvas.width / rect.width), y: (clientY - rect.top) * (canvas.height / rect.height) };
    };
    const start = (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); if(e.cancelable) e.preventDefault(); };
    const move = (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.lineWidth=3; ctx.stroke(); if(e.cancelable) e.preventDefault(); };
    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move);
    canvas.addEventListener('touchstart', start, {passive:false}); canvas.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('mouseup', () => drawing=false); window.addEventListener('touchend', () => drawing=false);
}

function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

async function loadRoute() {
    const sheetName = document.getElementById("route-select").value;
    document.getElementById("status").innerText = "Reading Sheet...";
    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const cols = json.table.cols;
        const addrIdx = cols.findIndex(c => c.label && c.label.toLowerCase().includes('addr'));
        const compIdx = cols.findIndex(c => c.label && (c.label.toLowerCase().includes('comp') || c.label.toLowerCase().includes('cust')));
        
        stops = [];
        const rows = json.table.rows;
        for (let i = 0; i < rows.length; i++) {
            const rowData = rows[i].c;
            const address = rowData[addrIdx] ? rowData[addrIdx].v.toString() : "";
            if (!address || address.includes("http") || address.toLowerCase().includes("address")) continue;
            
            document.getElementById("status").innerText = `Mapping: ${i+1}/${rows.length}`;
            let geo = await geocodeArcGIS(address);
            let flagged = false;
            
            if(!geo) { geo = { lat: warehouse[0], lng: warehouse[1] }; flagged = true; }

            stops.push({ 
                company: (rowData[compIdx] && rowData[compIdx].v) ? rowData[compIdx].v : "Customer", 
                address: address, flagged: flagged, ...geo 
            });
            await new Promise(resolve => setTimeout(resolve, 800));
        }
        renderRoute();
        renderSidebar();
        document.getElementById("status").innerText = "Route Ready";
    } catch (e) { document.getElementById("status").innerText = "Error Loading Route."; }
}

async function geocodeArcGIS(addr) {
    const query = encodeURIComponent(addr + ", Grande Prairie, AB");
    try {
        const res = await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${query}&maxLocations=1`);
        const data = await res.json();
        return data.candidates.length ? { lat: data.candidates[0].location.y, lng: data.candidates[0].location.x } : null;
    } catch (e) { return null; }
}

function renderRoute() {
    markerLayer.clearLayers();
    stops.forEach((s, i) => {
        L.marker([s.lat, s.lng], { 
            icon: L.divIcon({ className:'custom-div-icon', html:`<div class="number-pin" style="${s.flagged ? 'background:#ffc107; color:black' : ''}">${i+1}</div>` }) 
        }).addTo(markerLayer);
    });
}

function renderSidebar() {
    const list = document.getElementById("stop-list");
    list.innerHTML = "";
    stops.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = `stop-card ${s.flagged ? 'flagged' : ''}`;
        div.innerHTML = `<b>${i+1}. ${s.company}</b><br><small>${s.address}</small>${s.flagged ? '<br><b style="color:#ffc107">⚠️ CHECK ADDRESS</b>' : ''}`;
        div.onclick = () => { map.setView([s.lat, s.lng], 16); openProfile(i); };
        list.appendChild(div);
    });
}

function openProfile(i) {
    currentStopIndex = i;
    document.getElementById('list-view').style.display = 'none';
    document.getElementById('customer-profile').style.display = 'block';
    document.getElementById('prof-name').innerText = stops[i].company;
    document.getElementById('prof-addr').innerText = stops[i].address;
    clearSig();
}

function closeProfile() {
    document.getElementById('list-view').style.display = 'block';
    document.getElementById('customer-profile').style.display = 'none';
}

async function submitLog(status) {
    const now = new Date();
    const entry = {
        customer: stops[currentStopIndex].company,
        status: status,
        time: now.toLocaleTimeString(),
        date: now.toLocaleDateString(),
        v18l: document.getElementById('p-18l').value || 0,
        vSmall: document.getElementById('p-small').value || 0,
        vCases: document.getElementById('p-cases').value || 0,
        r18l: document.getElementById('p-18l-ret').value || 0,
        rSmall: document.getElementById('p-small-ret').value || 0,
        receivedBy: document.getElementById('p-rec-by').value || "None",
        notes: document.getElementById('p-notes').value || "",
        reason: ""
    };

    if (status === 'NOT DELIVERED') {
        entry.reason = prompt("Reason for Not Delivered:");
        if(!entry.reason) return;
    } else {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Culligan Receipt", 20, 20);
        doc.text(`Customer: ${entry.customer}`, 20, 40);
        doc.text(`18L: ${entry.v18l} | Small: ${entry.vSmall}`, 20, 50);
        const sigData = canvas.toDataURL("image/png");
        doc.addImage(sigData, 'PNG', 20, 70, 50, 25);
        entry.pdfData = doc.output('datauristring').split(',')[1];
        entry.filename = `Culligan_${entry.customer}_${now.getTime()}.pdf`;
    }

    deliveryLog.push(entry);
    updateReports();

    try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(entry) });
        alert(status === 'NOT DELIVERED' ? "Skip Logged" : "Delivery Slip Saved");
    } catch (e) { alert("NETWORK ERROR"); }
    
    closeProfile();
}

function updateReports() {
    const summaryDiv = document.getElementById('summary-data');
    const liveBody = document.getElementById('live-body');
    const liveTotals = document.getElementById('live-totals');
    summaryDiv.innerHTML = "";
    liveBody.innerHTML = "";
    let t18 = 0, tSm = 0, tCs = 0, r18 = 0, rSm = 0;

    deliveryLog.forEach(log => {
        t18 += Number(log.v18l); tSm += Number(log.vSmall); tCs += Number(log.vCases);
        r18 += Number(log.r18l); rSm += Number(log.rSmall);

        summaryDiv.innerHTML += `
            <div style="border-bottom:1px solid #444; padding:10px;">
                <b>${log.date} - ${log.customer}</b> [${log.status}] @ ${log.time}<br>
                DEL: 18L(${log.v18l}) Small(${log.vSmall}) Cases(${log.vCases})<br>
                RET: 18L(${log.r18l}) Small(${log.rSmall})<br>
                NOTES: ${log.notes} ${log.reason ? '| REASON: ' + log.reason : ''}
            </div>`;

        liveBody.innerHTML += `<tr>
            <td>${log.customer}</td><td>${log.status}</td><td>${log.v18l}</td><td>${log.vSmall}</td><td>${log.vCases}</td><td>${log.r18l}</td><td>${log.rSmall}</td><td>${log.time}</td>
        </tr>`;
    });

    liveTotals.innerHTML = `
        <h3 style="margin:0 0 10px 0; color:#0078ff">LIVE TOTALS</h3>
        <p style="margin:5px 0"><b>Delivered:</b> 18L: ${t18} | Small: ${tSm} | Cases: ${tCs}</p>
        <p style="margin:5px 0"><b>Returned:</b> 18L: ${r18} | Small: ${rSm}</p>
    `;
}

async function executeEOD() {
    if(!confirm("Execute End of Day?")) return;
    const route = document.getElementById("route-select").value;
    const longDate = new Date().toLocaleDateString('en-GB', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    const eodPayload = { action: "EOD", route: route, longDate: longDate, summary: document.getElementById('summary-data').innerText, log: deliveryLog };

    document.getElementById('status').innerText = "Running EOD...";
    try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(eodPayload) });
        alert("EOD Success: PDFs zipped and Summary saved.");
    } catch(e) { alert("EOD Error"); }
    document.getElementById('status').innerText = "Ready";
}
</script>
</body>
</html>
