<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Culligan v25.0 - Master Recovery</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin:0; height:100vh; display:flex; font-family:'Segoe UI',sans-serif; background:#111; color:white; overflow:hidden;}
        #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column;}
        #sidebar-header { padding:15px; border-bottom:1px solid #444;}
        #stop-list { flex:1; overflow-y:auto; padding:10px;}
        .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer;}
        #customer-profile { display:none; padding:15px; background:#222; overflow-y:auto; height:100%; }
        .profile-group { margin-bottom:12px; }
        .profile-group label { display:block; font-size:10px; color:#0078ff; font-weight:bold; margin-bottom:4px; text-transform: uppercase;}
        .profile-group input { width:100%; padding:8px; background:#333; border:1px solid #444; color:white; border-radius:4px; box-sizing:border-box; }
        #sig-canvas { background:white; border-radius:4px; width:100%; height:160px; touch-action: none; border: 2px solid #555; display: block; cursor: crosshair;}
        .btn-del { width:100%; background:#28a745; color:white; border:none; padding:15px; border-radius:4px; cursor:pointer; font-weight:bold; margin-top:10px;}
        .btn-not { width:100%; background:#dc3545; color:white; border:none; padding:15px; border-radius:4px; cursor:pointer; font-weight:bold; margin-top:5px;}
        #main-view { flex:1; display:flex; flex-direction:column; position: relative;}
        #controls { background:#222; padding:15px; border-bottom:2px solid #0078ff; display: flex; align-items: center; gap: 10px;}
        #map { flex:1; }
        .number-pin { color:white; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white;}
    </style>
</head>
<body>

<div id="sidebar">
    <div id="list-view">
        <div id="sidebar-header">
            <h3 style="margin:0">Route Stops</h3>
            <p id="status-display" style="font-size:12px; color:#aaa;">Ready</p>
            <button id="start-route-btn" onclick="startDriverSession()" style="width:100%; padding:10px; background:#0078ff; color:white; border:none; margin-top:10px; display:none; cursor:pointer; font-weight:bold;">START ROUTE</button>
        </div>
        <div id="stop-list"></div>
    </div>
    
    <div id="customer-profile">
        <button onclick="closeProfile()" style="background:#444; color:white; border:none; padding:10px; width:100%; margin-bottom:15px; cursor:pointer;">‚Üê RETURN</button>
        <h3 id="prof-name" style="margin:0;"></h3>
        <p id="prof-addr" style="font-size:11px; color:#0078ff; margin-bottom:15px;"></p>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="profile-group"><label>18L Del</label><input type="number" id="p-18l" value="0"></div>
            <div class="profile-group"><label>18L Ret</label><input type="number" id="p-18l-ret" value="0"></div>
            <div class="profile-group"><label>Sm Del</label><input type="number" id="p-sm-del" value="0"></div>
            <div class="profile-group"><label>Sm Ret</label><input type="number" id="p-sm-ret" value="0"></div>
            <div class="profile-group"><label>Cases</label><input type="number" id="p-cases" value="0"></div>
            <div class="profile-group"><label>Email Rec.</label><input type="checkbox" id="p-send-email" checked style="width:20px; height:20px;"></div>
        </div>

        <label style="font-size:11px; color:#0078ff; font-weight:bold;">SIGNATURE</label>
        <canvas id="sig-canvas"></canvas>
        <button onclick="clearSig()" style="width:100%; margin:5px 0; background:#444; color:white; border:none; padding:8px; cursor:pointer;">CLEAR</button>

        <button class="btn-del" onclick="handleSubmission('DELIVERED')">COMPLETE</button>
        <div style="border-top:1px solid #444; margin-top:10px; padding-top:10px;">
            <input type="text" id="p-fail-reason" placeholder="Skip reason..." style="width:100%; background:#333; color:white; padding:10px; border:1px solid #444;">
            <button class="btn-not" onclick="handleSubmission('NOT DELIVERED')">MARK SKIP</button>
        </div>
    </div>
</div>

<div id="main-view">
    <div id="controls">
        <select id="route-select" style="padding:8px; background:#333; color:white;">
            <option value="666943587">MON WEEK 1</option>
            <option value="1773492755">SALT</option>
            <option value="458612538">VALLEYVIEW</option>
        </select>
        <button onclick="loadRoute()" id="load-btn" style="padding:8px 15px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer;">Load Route</button>
    </div>
    <div id="map"></div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw6avu1yGlo7Ggw7--b4eflAgMOu4vjMYeVj3p1GLOycXS3M3ZA8Z9-UpPW1zeY7kAh/exec"; 
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";

let map, markerLayer, stops = [], currentIdx = null, drawing = false;
let canvas, ctx;

window.onload = () => {
    map = L.map("map").setView([55.1707, -118.7947], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    markerLayer = L.layerGroup().addTo(map);
    initSig();
};

function initSig() {
    canvas = document.getElementById('sig-canvas'); ctx = canvas.getContext('2d');
    const getPos = (e) => {
        const r = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - r.left, y: clientY - r.top };
    };
    const start = (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); if(e.cancelable) e.preventDefault(); };
    const move = (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.lineWidth = 2; ctx.stroke(); if(e.cancelable) e.preventDefault(); };
    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('touchstart', start, {passive: false}); canvas.addEventListener('touchmove', move, {passive: false});
    window.addEventListener('touchend', () => drawing = false);
}

function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

async function loadRoute() {
    const gid = document.getElementById('route-select').value;
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
    document.getElementById('status-display').innerText = "Loading...";
    try {
        const res = await fetch(url);
        const text = await res.text();
        if(text.includes("<!DOCTYPE html>")) { alert("Set Sheet to 'Anyone with the link can view'"); return; }
        const rows = text.split('\n').slice(1);
        stops = [];
        for(let r of rows) {
            const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if(c[3]) {
                const addr = c[3].replace(/"/g,'').trim();
                const g = await (await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(addr)}&maxLocations=1`)).json();
                if(g.candidates && g.candidates.length) {
                    stops.push({ name: c[2].replace(/"/g,'').trim(), addr: addr, email: c[7] ? c[7].replace(/"/g,'').trim() : "", lat: g.candidates[0].location.y, lng: g.candidates[0].location.x, status: 'pending' });
                }
            }
        }
        document.getElementById('status-display').innerText = stops.length + " Stops Loaded";
        document.getElementById('start-route-btn').style.display = 'block';
        renderAll();
    } catch (err) { alert("Load Failed: " + err.message); }
}

function handleSubmission(type) {
    const s = stops[currentIdx];
    const payload = {
        routeName: document.getElementById('route-select').options[document.getElementById('route-select').selectedIndex].text,
        timestamp: new Date().toLocaleString(),
        customer: s.name, customerEmail: s.email, status: type,
        d18: document.getElementById('p-18l').value || 0, r18: document.getElementById('p-18l-ret').value || 0,
        dSm: document.getElementById('p-sm-del').value || 0, rSm: document.getElementById('p-sm-ret').value || 0,
        cs: document.getElementById('p-cases').value || 0, notes: document.getElementById('p-fail-reason').value || "None",
        sig: canvas.toDataURL()
    };
    fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
    s.status = 'completed';
    renderAll(); closeProfile();
}

function renderAll() {
    markerLayer.clearLayers();
    const list = document.getElementById('stop-list'); list.innerHTML = "";
    stops.forEach((s, i) => {
        const d = document.createElement('div');
        d.className = 'stop-card'; d.style.opacity = s.status === 'completed' ? '0.4' : '1';
        d.innerHTML = `<b>${i+1}. ${s.name}</b><br><small>${s.addr}</small>`;
        d.onclick = () => openProfile(i);
        list.appendChild(d);
        L.marker([s.lat, s.lng], {icon: L.divIcon({html:`<div class="number-pin" style="background:${s.status==='completed'?'#28a745':'#0078ff'}">${i+1}</div>`, className:''})}).addTo(markerLayer);
    });
}

function openProfile(i) {
    currentIdx = i; const s = stops[i];
    document.getElementById('list-view').style.display = 'none';
    document.getElementById('customer-profile').style.display = 'block';
    document.getElementById('prof-name').innerText = s.name;
    document.getElementById('prof-addr').innerText = s.addr;
    clearSig();
}

function closeProfile() { document.getElementById('list-view').style.display='block'; document.getElementById('customer-profile').style.display='none'; }
</script>
</body>
</html>

