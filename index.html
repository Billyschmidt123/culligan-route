<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Culligan Route Manager</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { margin: 0; height: 100vh; display: flex; flex-direction: row; font-family: 'Segoe UI', sans-serif; background: #111; color: white; overflow: hidden; }
        #sidebar { width: 350px; background: #222; border-right: 2px solid #0078ff; display: flex; flex-direction: column; flex-shrink: 0; }
        #sidebar-header { padding: 15px; border-bottom: 1px solid #444; }
        #stop-list { flex: 1; overflow-y: auto; padding: 10px; }
        .stop-card { background: #333; padding: 12px; margin-bottom: 10px; border-radius: 4px; border-left: 4px solid #0078ff; font-size: 13px; cursor: pointer; }
        .stop-card.active-card { background: #444; border-left-color: #e74c3c; }
        .card-label { color: #0078ff; font-weight: bold; font-size: 11px; text-transform: uppercase; display: block; margin-top: 4px; }
        .card-val { color: #eee; display: block; margin-bottom: 2px; }
        #main-view { flex: 1; display: flex; flex-direction: column; }
        #controls { background: #222; padding: 15px; border-bottom: 2px solid #0078ff; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #current-stop-bar { background: #0078ff; color: white; padding: 10px; font-weight: bold; text-align: center; font-size: 16px; display: none; }
        #map { flex: 1; width: 100%; }
        .btn { padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-nav { background: #444; padding: 8px 12px; }
        .btn-mgr { background: #f39c12; }
        select { padding: 9px; background: #333; color: white; border: 1px solid #444; border-radius: 4px; font-size: 14px; width: 160px; }
        
        #dataModal, #mgrModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:5000; align-items:center; justify-content:center; }
        .modal-content { background:#222; padding:20px; border-radius:8px; width:400px; border:1px solid #444; max-height: 95vh; overflow-y: auto; }
        .field-row { margin-bottom: 12px; }
        .field-row label { display: block; font-size: 12px; color: #aaa; margin-bottom: 4px; }
        .field-row input, .field-row textarea { width: 100%; padding: 8px; background: #111; border: 1px solid #444; color: white; box-sizing: border-box; border-radius: 4px; }
        #sig-canvas { background: white; border-radius: 4px; cursor: crosshair; width: 100%; height: 100px; }
        
        .number-pin { background: #0078ff; color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; font-size: 13px; }
        .active-pin { background: #e74c3c !important; scale: 1.2; box-shadow: 0 0 10px #e74c3c; }
        .warehouse-pin { background: #222 !important; border-color: #f39c12 !important; color: #f39c12 !important; }
        .leaflet-tooltip-own { background: rgba(0,0,0,0.7); border: 1px solid #0078ff; color: white; font-weight: bold; border-radius: 4px; padding: 2px 6px; }

        /* Hidden Template for PDF */
        #ticket-output { display: none; padding: 30px; background: white; color: black; width: 500px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="sidebar-header">
        <h3 style="margin:0">Route List</h3>
        <p id="driver-display" style="font-size: 14px; color: #0078ff; margin: 5px 0; font-weight: bold;"></p>
        <p id="stop-count" style="font-size: 12px; color: #aaa; margin-bottom: 10px;">No route loaded</p>
        <button class="btn btn-mgr" style="width:100%;" onclick="openManagerMenu()">Manager Menu</button>
    </div>
    <div id="stop-list"></div>
    <div style="display: flex; justify-content: space-between; padding: 10px; background: #222;">
        <button class="btn btn-nav" onclick="prevStop()">⬅ Previous</button>
        <button class="btn btn-nav" onclick="nextStop()">Next ➡</button>
    </div>
</div>

<div id="main-view">
    <div id="controls">
        <select id="routeSelector"><option value="">Fetching...</option></select>
        <button class="btn" onclick="loadSelectedRoute()">Load Route</button>
        <div id="status" style="font-size: 13px; color: #aaa;">Status: Ready</div>
    </div>
    <div id="current-stop-bar">Current Stop: <span id="active-addr">None</span></div>
    <div id="map"></div>
</div>

<div id="ticket-output">
    <div style="text-align: center; border-bottom: 2px solid #0078ff;">
        <h2>Culligan Bottle Water</h2>
        <p>Delivery Ticket #<span id="t-slip"></span></p>
    </div>
    <p><strong>Customer:</strong> <span id="t-cust"></span></p>
    <p><strong>Driver:</strong> <span id="t-driver"></span></p>
    <p><strong>Items:</strong> 18L: <span id="t-18l"></span> | Cases: <span id="t-cases"></span></p>
    <p><strong>Signature:</strong></p>
    <img id="t-sig" style="width:200px; border-bottom:1px solid #000;">
</div>

<div id="dataModal">
    <div class="modal-content">
        <h3 id="mCustName" style="color:#0078ff; margin-top:0;">Customer</h3>
        <div class="field-row"><label>18L Bottles</label><input type="number" id="inv18L"></div>
        <div class="field-row"><label>Cases</label><input type="number" id="invCases"></div>
        <div class="field-row"><label>Signature</label><canvas id="sig-canvas"></canvas></div>
        <div class="field-row"><label>Notes</label><textarea id="driverNotes"></textarea></div>
        <button class="btn" style="width:100%; margin-bottom:10px;" onclick="processStop('Delivered')">DELIVERED</button>
        <button class="btn" style="width:100%; background:#444;" onclick="closeModal()">Close</button>
    </div>
</div>

<script>
    // REPLACE WITH YOUR DEPLOYED URL
    const SHEETS_API_URL = "REPLACE_WITH_YOUR_NEW_WEB_APP_URL";
    
    let map, markerLayer, routeLine, stops = [], markers = [], activeIndex = -1, canvas, ctx, drawing = false;
    let driverName = "Unknown";
    const warehouse = { lat: 55.1707, lng: -118.7947 };

    // 1. Fetch the Route Names for Dropdown
    async function fetchRouteList() {
        try {
            const res = await fetch(SHEETS_API_URL);
            const tabs = await res.json();
            const selector = document.getElementById('routeSelector');
            selector.innerHTML = "";
            tabs.filter(t => t !== 'Deliveries').forEach(tabName => {
                let opt = document.createElement('option'); opt.value = tabName; opt.innerHTML = tabName; selector.appendChild(opt);
            });
        } catch (e) { document.getElementById('status').textContent = "CORS Error: Check Script URL"; }
    }

    // 2. Load and Map the Stops
    async function loadSelectedRoute() {
        const selectedTab = document.getElementById('routeSelector').value;
        if (!selectedTab) return;
        document.getElementById('status').textContent = `Loading...`;
        try {
            const dataRes = await fetch(`${SHEETS_API_URL}?sheet=${encodeURIComponent(selectedTab)}`);
            const rows = await dataRes.json();
            
            let tempStops = [];
            for (let i = 0; i < rows.length; i++) {
                const addr = rows[i]["Address"] || rows[i]["address"];
                const geo = await geocodeAddress(addr);
                if (geo) tempStops.push({ company: rows[i]["Company"] || rows[i]["Customer"], address: addr, ...geo, fullData: rows[i] });
            }
            stops = tempStops; // Add optimization if needed
            renderRoute();
            updateSidebar();
            document.getElementById('status').textContent = "Ready.";
        } catch (e) { document.getElementById('status').textContent = "Load Failed."; }
    }

    async function geocodeAddress(address) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ", Grande Prairie, AB")}`);
            const data = await res.json();
            return data.length > 0 ? { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) } : null;
        } catch (e) { return null; }
    }

    function renderRoute() {
        markerLayer.clearLayers();
        let path = [[warehouse.lat, warehouse.lng]];
        stops.forEach((s, i) => {
            path.push([s.lat, s.lng]);
            const m = L.marker([s.lat, s.lng], {
                icon: L.divIcon({ className: '', html: `<div id="pin-${i}" class="number-pin">${i+1}</div>`, iconSize:[30,30] })
            }).addTo(markerLayer);
            m.bindTooltip(s.address, { className: 'leaflet-tooltip-own' });
        });
        routeLine.setLatLngs(path);
        map.fitBounds(L.polyline(path).getBounds());
    }

    function updateSidebar() {
        const list = document.getElementById('stop-list');
        list.innerHTML = "";
        stops.forEach((s, i) => {
            const card = document.createElement('div');
            card.className = "stop-card";
            card.innerHTML = `<b>#${i+1} ${s.company}</b><br>${s.address}`;
            card.onclick = () => selectStop(i);
            list.appendChild(card);
        });
        document.getElementById('stop-count').innerText = `${stops.length} Stops Found`;
    }

    function selectStop(index) {
        activeIndex = index;
        const s = stops[index];
        document.getElementById('active-addr').innerText = s.address;
        document.getElementById('current-stop-bar').style.display = "block";
        document.getElementById('mCustName').innerText = s.company;
        document.getElementById('dataModal').style.display = "flex";
        initCanvas();
    }

    // 3. Process Stop (PDF + Trip Log + Sheet)
    async function processStop(status) {
        const now = new Date();
        const routeName = document.getElementById('routeSelector').value;
        const slipNum = now.getTime().toString().slice(-6);
        const longDate = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const fileName = `${stops[activeIndex].company} - ${routeName} - ${slipNum} - ${longDate}.pdf`;

        // Update Ticket UI
        document.getElementById('t-slip').innerText = slipNum;
        document.getElementById('t-cust').innerText = stops[activeIndex].company;
        document.getElementById('t-driver').innerText = driverName;
        document.getElementById('t-sig').src = canvas.toDataURL();

        const ticket = document.getElementById('ticket-output');
        ticket.style.display = "block";

        html2pdf().from(ticket).outputPdf('datauristring').then(pdfBase64 => {
            ticket.style.display = "none";
            const payload = {
                Timestamp: now.toLocaleString(),
                DriverID: driverName,
                Customer: stops[activeIndex].company,
                Address: stops[activeIndex].address,
                Status: status,
                Notes: document.getElementById('driverNotes').value,
                Slip: slipNum,
                Signature: canvas.toDataURL(),
                RouteName: routeName,
                LongDate: longDate,
                FileName: fileName,
                pdfData: pdfBase64
            };

            fetch(SHEETS_API_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(() => { closeModal(); alert("Saved!"); });
        });
    }

    function initCanvas() {
        canvas = document.getElementById('sig-canvas'); ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth; canvas.height = 100;
        canvas.onmousedown = (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
        canvas.onmousemove = (e) => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
        window.onmouseup = () => drawing = false;
    }

    function closeModal() { document.getElementById('dataModal').style.display = "none"; }

    window.onload = () => {
        const pw = prompt("Code:");
        if (pw !== "1234") return;
        driverName = prompt("Name:");
        document.getElementById('driver-display').innerText = `Driver: ${driverName}`;

        map = L.map("map").setView([55.17, -118.79], 12);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        markerLayer = L.layerGroup().addTo(map);
        routeLine = L.polyline([], { color: '#0078ff' }).addTo(map);
        fetchRouteList();
    };
</script>
</body>
</html>
