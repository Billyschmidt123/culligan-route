<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Culligan Route Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin:0; height:100vh; display:flex; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#111; color:white; overflow:hidden;}
        #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column; z-index: 10;}
        #map { flex:1; background: #000; }
        #stop-list { flex:1; overflow-y:auto; padding:10px; }
        .stop-card { background:#333; padding:12px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer;}
        .stop-card:hover { background:#444; }
        #customer-profile { display:none; padding:20px; background:#222; height:100%; overflow-y:auto; }
        .mgr-panel { position:fixed; bottom:-100%; left:0; width:100%; height:85%; background:#1a1a1a; transition:0.4s; z-index:2000; padding:20px; box-sizing:border-box; border-top:4px solid #0078ff;}
        .mgr-panel.open { bottom:0; }
        .btn { padding:12px; background:#0078ff; color:white; border:none; cursor:pointer; border-radius:4px; font-weight:bold; width:100%; margin-bottom:10px; text-transform: uppercase;}
        .btn-red { background: #dc3545; }
        .btn-green { background: #28a745; }
        input, select, textarea { padding:12px; width:100%; margin-bottom:15px; background:#333; color:white; border:1px solid #444; border-radius:4px; box-sizing:border-box;}
        #sig-canvas { background:white; width:100%; height:150px; border-radius:4px; border:2px solid #555; touch-action:none; }
        #status-bar { background:#001a33; padding:10px; font-size:12px; color:#0078ff; border-bottom:1px solid #0078ff; font-weight: bold;}
    </style>
</head>
<body>

<div id="sidebar">
    <div id="status-bar">SYSTEM ONLINE</div>
    
    <div id="list-view">
        <div style="padding:15px; border-bottom:1px solid #444;">
            <h3 style="margin:0 0 10px 0; color: #0078ff;">ROUTE SELECTION</h3>
            <select id="route-select">
                <option value="WEEK 1 MONDAY">WEEK 1 MONDAY</option>
                <option value="WEEK 1 TUESDAY">WEEK 1 TUESDAY</option>
                <option value="WEEK 1 WEDNESDAY">WEEK 1 WEDNESDAY</option>
                <option value="WEEK 1 THURSDAY">WEEK 1 THURSDAY</option>
                <option value="WEEK 1 FRIDAY">WEEK 1 FRIDAY</option>
            </select>
            <button class="btn" onclick="loadRoute()">Load Route</button>
            <button class="btn" style="background:#555;" onclick="toggleManager()">Manager Tools</button>
        </div>
        <div id="stop-list"></div>
    </div>

    <div id="customer-profile">
        <button class="btn" style="background:#444;" onclick="closeProfile()">‚Üê Back to List</button>
        <h2 id="prof-name" style="margin: 10px 0; color: #0078ff;">Customer</h2>
        <p id="prof-addr" style="color:#aaa; font-size:13px; margin-bottom: 20px;"></p>
        
        <label style="font-size: 11px; font-weight: bold; color: #0078ff;">DELIVERY NOTES</label>
        <textarea id="p-notes" rows="3" placeholder="Enter service notes..."></textarea>
        
        <label style="font-size: 11px; font-weight: bold; color: #0078ff;">SIGNATURE</label>
        <canvas id="sig-canvas"></canvas>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-green" style="flex:2;" onclick="submitLog('DELIVERED')">Complete</button>
            <button class="btn btn-red" style="flex:1;" onclick="submitLog('SKIPPED')">Skip</button>
        </div>
    </div>
</div>

<div id="map"></div>

<div id="manager-panel" class="mgr-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0; color:#0078ff;">ADMINISTRATION</h2>
        <button class="btn btn-red" style="width:auto; padding:5px 20px;" onclick="toggleManager()">Close</button>
    </div>
    
    <div style="background:#222; padding:20px; border-radius:8px; border: 1px solid #444;">
        <h3 style="margin-top:0;">Global Customer Search</h3>
        <p style="font-size: 12px; color: #888;">Queries all sheets in the database for matches.</p>
        <input type="text" id="global-search-input" placeholder="Search Company Name...">
        <button class="btn" onclick="runGlobalSearch()">Execute Global Search</button>
        
        <label style="margin-top: 10px; display: block;">Search Results:</label>
        <select id="global-results-drop">
            <option>-- Results will appear here --</option>
        </select>
    </div>

    <div style="margin-top:30px;">
        <button class="btn" style="background:#ffc107; color:black;" onclick="executeEOD()">Submit Trip Report & End Day</button>
    </div>
</div>

<script>
    /** CONFIG **/
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMfGuDRFTGBWyrG2CVFVOBSUzyORpxd4aTVZaStpuF54zkryeKdFU0PLIIaIgk-w0M/exec"; 
    const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";

    let map, markerLayer, stops = [], currentStopIndex = 0, deliveryLog = [], canvas, ctx, drawing = false;
    const warehouse = [55.1707, -118.7947];

    window.onload = () => {
        map = L.map('map').setView(warehouse, 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        markerLayer = L.layerGroup().addTo(map);
        initSig();
    };

    function toggleManager() { document.getElementById('manager-panel').classList.toggle('open'); }

    async function runGlobalSearch() {
        const term = document.getElementById('global-search-input').value;
        if(term.length < 3) return alert("Please enter at least 3 characters.");
        
        document.getElementById('status-bar').innerText = "QUERYING DATABASE...";
        try {
            const response = await fetch(`${SCRIPT_URL}?action=searchGlobal&name=${encodeURIComponent(term)}`, {
                method: 'GET',
                redirect: 'follow'
            });
            const data = await response.json();
            const drop = document.getElementById('global-results-drop');
            drop.innerHTML = '';

            if(!data || data.length === 0) {
                alert("No matches found.");
            } else {
                data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.text = `${item.company} | ${item.route}`;
                    drop.add(opt);
                });
                alert(`Found ${data.length} matches!`);
            }
        } catch (err) {
            console.error(err);
            alert("Database Connection Error.");
        }
        document.getElementById('status-bar').innerText = "SYSTEM ONLINE";
    }

    async function loadRoute() {
        const sheetName = document.getElementById('route-select').value;
        document.getElementById('status-bar').innerText = `LOADING ${sheetName}...`;
        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
            const res = await fetch(url);
            const text = await res.text();
            const json = JSON.parse(text.substring(47).slice(0, -2));
            const rows = json.table.rows;
            
            stops = rows.map(r => ({
                company: r.c[0]?.v || "Unknown",
                address: r.c[1]?.v || "No Address Found"
            })).filter(s => s.address !== "No Address Found");

            renderSidebar();
            document.getElementById('status-bar').innerText = `ROUTE READY: ${stops.length} STOPS`;
        } catch (e) { 
            alert("Spreadsheet Access Denied."); 
            document.getElementById('status-bar').innerText = "OFFLINE";
        }
    }

    function renderSidebar() {
        const list = document.getElementById('stop-list');
        list.innerHTML = "";
        stops.forEach((s, i) => {
            const d = document.createElement('div');
            d.className = 'stop-card';
            d.innerHTML = `<b>${i+1}. ${s.company}</b><br><small style="color:#aaa;">${s.address}</small>`;
            d.onclick = () => openProfile(i);
            list.appendChild(d);
        });
    }

    function openProfile(i) {
        currentStopIndex = i;
        document.getElementById('list-view').style.display = 'none';
        document.getElementById('customer-profile').style.display = 'block';
        document.getElementById('prof-name').innerText = stops[i].company;
        document.getElementById('prof-addr').innerText = stops[i].address;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function closeProfile() {
        document.getElementById('list-view').style.display = 'block';
        document.getElementById('customer-profile').style.display = 'none';
    }

    function submitLog(status) {
        deliveryLog.push({
            customer: stops[currentStopIndex].company,
            status: status,
            time: new Date().toLocaleTimeString(),
            notes: document.getElementById('p-notes').value
        });
        document.getElementById('p-notes').value = "";
        closeProfile();
        alert("Visit Logged Locally.");
    }

    async function executeEOD() {
        if(deliveryLog.length === 0) return alert("Nothing to submit.");
        document.getElementById('status-bar').innerText = "UPLOADING TO DRIVE...";
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: "EOD", log: deliveryLog })
            });
            alert("Trip Report Successfully Uploaded.");
            deliveryLog = [];
        } catch(e) { alert("Upload Failed."); }
        document.getElementById('status-bar').innerText = "SYSTEM ONLINE";
    }

    function initSig() {
        canvas = document.getElementById('sig-canvas');
        ctx = canvas.getContext('2d');
        const getPos = e => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        };
        const start = e => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
        const move = e => { if(drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); } };
        const end = () => drawing = false;
        canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
        canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move); window.addEventListener('touchend', end);
    }
</script>
</body>
</html>
