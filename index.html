<!DOCTYPE html>
<html>
<head>
    <title>Culligan Route Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { --culligan-blue: #0078ff; --dark-bg: #1a1a1a; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; }
        
        /* Header Styling */
        header { background: var(--culligan-blue); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; }
        
        /* Map and List Container */
        #main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #map { flex: 2; width: 100%; border-bottom: 3px solid var(--culligan-blue); }
        
        /* Stop List Styling */
        .stop-list { flex: 1; overflow-y: auto; padding: 15px; background: white; }
        .stop-card { background: #fff; border-left: 5px solid var(--culligan-blue); padding: 15px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.1s; }
        .stop-card:active { transform: scale(0.98); background: #f9f9f9; }
        .stop-card b { font-size: 1.1em; color: #333; }
        
        /* Modal Overlay */
        #dataModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; flex-direction: column; align-items: center; justify-content: flex-start; color: white; padding-top: 40px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--dark-bg); width: 90%; max-width: 450px; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Grid Input Styling */
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 15px 0; }
        input, textarea, select { padding: 12px; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: white; font-size: 16px; width: 100%; box-sizing: border-box; }
        input::placeholder { color: #888; }
        
        /* Signature Canvas */
        #sig-canvas { background: white; border-radius: 8px; margin: 15px 0; touch-action: none; width: 100%; height: 150px; }
        
        /* Buttons */
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; text-transform: uppercase; }
        .btn-save { background: #28a745; color: white; }
        .btn-cancel { background: #dc3545; color: white; }
        
        /* PDF Template (Hidden) */
        #ticket-output { display: none; width: 600px; padding: 40px; background: white; color: black; }
        .number-pin { background: var(--culligan-blue); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; font-size: 1.2em;">CULLIGAN ROUTE</div>
    <select id="routeSelector" style="width: auto; padding: 5px; background: white; color: black; border: none;">
        <option>City Route A</option>
        <option>Rural Route B</option>
    </select>
    <div id="stop-count">0 Stops</div>
</header>

<div id="main-container">
    <div id="map"></div>
    <div class="stop-list" id="stop-list"></div>
</div>

<div id="dataModal">
    <div class="modal-content">
        <h2 id="mCustName" style="margin-top: 0; color: var(--culligan-blue);">Customer Name</h2>
        <div class="grid-inputs">
            <div><label>18L Del.</label><input type="number" id="inv18L" value="0"></div>
            <div><label>18L Ret.</label><input type="number" id="ret18L" value="0"></div>
            <div><label>Sm Del.</label><input type="number" id="invSm" value="0"></div>
            <div><label>Sm Ret.</label><input type="number" id="retSm" value="0"></div>
            <div style="grid-column: span 2;"><input type="text" id="recvBy" placeholder="Received By"></div>
        </div>
        <textarea id="driverNotes" rows="2" placeholder="Add notes here..."></textarea>
        <p style="margin: 10px 0 5px 0; font-size: 0.9em; color: #aaa;">Authorized Signature:</p>
        <canvas id="sig-canvas"></canvas>
        <div class="btn-row">
            <button class="btn btn-save" onclick="processStop('Delivered')">Submit</button>
            <button class="btn btn-cancel" onclick="closeModal()">Back</button>
        </div>
    </div>
</div>

<div id="ticket-output">
    <div style="text-align: center; border-bottom: 2px solid #0078ff; padding-bottom: 10px;">
        <h1 style="color: #0078ff; margin: 0;">CULLIGAN WATER</h1>
        <p style="margin: 0;">Official Delivery Confirmation</p>
    </div>
    <div style="margin-top: 20px; font-size: 1.2em;">
        <p><b>Customer:</b> <span id="t-cust"></span></p>
        <p><b>Address:</b> <span id="t-addr"></span></p>
        <p><b>Date:</b> <span id="t-date"></span></p>
        <hr>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <p>18L Delivered: <span id="t-l18"></span></p>
            <p>18L Returned: <span id="t-r18"></span></p>
            <p>Small Delivered: <span id="t-lSm"></span></p>
            <p>Small Returned: <span id="t-rSm"></span></p>
        </div>
        <p><b>Notes:</b> <span id="t-notes"></span></p>
        <p><b>Received By:</b> <span id="t-recv"></span></p>
    </div>
    <div style="margin-top: 40px; border-top: 1px solid #ccc; padding-top: 10px;">
        <p><b>Signature:</b></p>
        <img id="t-sig" style="width: 100%; max-height: 150px; object-fit: contain;">
    </div>
</div>

<script>
    const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbzMfGuDRFTGBWyrG2CVFVOBSUzyORpxd4aTVZaStpuF54zkryeKdFU0PLIIaIgk-w0M/exec";
    let map, markerLayer, activeIndex, canvas, ctx, drawing = false;
    let stops = [
        { company: "TEST_UFA_FARM", address: "123 Farm Road", lat: 55.1700, lng: -118.7900 },
        { company: "Culligan Main", address: "Warehouse", lat: 55.1800, lng: -118.8000 }
    ];

    async function processStop(status) {
        const now = new Date();
        const longDate = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        const payload = {
            Timestamp: now.toLocaleString(),
            DriverID: "Driver_1",
            Customer: stops[activeIndex].company,
            Address: stops[activeIndex].address,
            Status: status,
            l18: document.getElementById('inv18L').value,
            r18: document.getElementById('ret18L').value,
            lSm: document.getElementById('invSm').value,
            rSm: document.getElementById('retSm').value,
            recv: document.getElementById('recvBy').value,
            Notes: document.getElementById('driverNotes').value,
            RouteName: document.getElementById('routeSelector').value,
            LongDate: longDate,
            FileName: `${stops[activeIndex].company} - ${longDate}.pdf`
        };

        // Fill PDF
        document.getElementById('t-cust').innerText = payload.Customer;
        document.getElementById('t-addr').innerText = payload.Address;
        document.getElementById('t-date').innerText = longDate;
        document.getElementById('t-l18').innerText = payload.l18;
        document.getElementById('t-r18').innerText = payload.r18;
        document.getElementById('t-lSm').innerText = payload.lSm;
        document.getElementById('t-rSm').innerText = payload.rSm;
        document.getElementById('t-notes').innerText = payload.Notes;
        document.getElementById('t-recv').innerText = payload.recv;
        document.getElementById('t-sig').src = canvas.toDataURL();

        const ticket = document.getElementById('ticket-output');
        ticket.style.display = "block";

        html2pdf().from(ticket).outputPdf('datauristring').then(pdfData => {
            ticket.style.display = "none";
            payload.pdfData = pdfData;

            fetch(SHEETS_API_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(() => { 
                alert("SUCCESS: Delivery Recorded & PDF Sent.");
                closeModal();
            });
        });
    }

    function initCanvas() {
        canvas = document.getElementById('sig-canvas'); ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth; canvas.height = 150;
        ctx.strokeStyle = "#000"; ctx.lineWidth = 3;
        const getXY = (e) => { 
            const r = canvas.getBoundingClientRect(); 
            const x = (e.clientX || (e.touches ? e.touches[0].clientX : 0)) - r.left;
            const y = (e.clientY || (e.touches ? e.touches[0].clientY : 0)) - r.top;
            return {x,y};
        };
        canvas.onmousedown = (e) => { drawing = true; const p = getXY(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
        canvas.onmousemove = (e) => { if(drawing) { const p = getXY(e); ctx.lineTo(p.x, p.y); ctx.stroke(); } };
        window.onmouseup = () => drawing = false;
        canvas.ontouchstart = (e) => { drawing = true; const p = getXY(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
        canvas.ontouchmove = (e) => { if(drawing) { e.preventDefault(); const p = getXY(e); ctx.lineTo(p.x, p.y); ctx.stroke(); } };
    }

    function closeModal() { document.getElementById('dataModal').style.display = 'none'; }

    window.onload = () => {
        map = L.map("map").setView([55.17, -118.79], 12);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        markerLayer = L.layerGroup().addTo(map);
        
        const list = document.getElementById('stop-list');
        stops.forEach((s, i) => {
            const card = document.createElement('div');
            card.className = "stop-card";
            card.innerHTML = `<b>#${i+1} ${s.company}</b><br><small>${s.address}</small>`;
            card.onclick = () => {
                activeIndex = i;
                document.getElementById('mCustName').innerText = s.company;
                document.getElementById('dataModal').style.display = 'flex';
                setTimeout(initCanvas, 100);
            };
            list.appendChild(card);
            L.marker([s.lat, s.lng], { 
                icon: L.divIcon({ html: `<div class="number-pin">${i+1}</div>`, className: '' }) 
            }).addTo(markerLayer);
        });
        document.getElementById('stop-count').innerText = stops.length + " Stops";
    };
</script>
</body>
</html>
