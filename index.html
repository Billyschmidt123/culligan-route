<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Culligan Route Pro</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    body { margin:0; height:100vh; display:flex; font-family:'Segoe UI',sans-serif; background:#111; color:white; overflow:hidden;}
    #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column;}
    #sidebar-header { padding:15px; border-bottom:1px solid #444;}
    #stop-list { flex:1; overflow-y:auto; padding:10px;}
    .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer;}
    .stop-card.flagged { border-left-color: #ffc107; background: #443c20; }
    #customer-profile { display:none; padding:15px; background:#222; overflow-y:auto; height:100%; }
    .profile-group { margin-bottom:12px; }
    .profile-group label { display:block; font-size:11px; color:#0078ff; font-weight:bold; margin-bottom:4px; text-transform: uppercase;}
    .profile-group input, .profile-group textarea { width:100%; padding:8px; background:#333; border:1px solid #444; color:white; border-radius:4px; box-sizing:border-box; }
    #sig-canvas { background:white; border-radius:4px; width:100%; height:150px; touch-action: none; border: 2px solid #555;}
    .btn { padding:10px 15px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;}
    #main-view { flex:1; display:flex; flex-direction:column; position: relative;}
    #current-stop-info { background:#001a33; padding:10px; border-bottom:2px solid #0078ff; display:flex; justify-content:space-between; align-items:center; min-height:60px;}
    #controls { background:#222; padding:10px; border-bottom:1px solid #444; display: flex; align-items: center; gap: 10px;}
    #map { flex:1; }
    .mgr-panel { position: absolute; bottom: -100%; left: 0; width: 100%; height: 90%; background: #1a1a1a; z-index: 1000; transition: bottom 0.4s ease; border-top: 3px solid #0078ff; padding:20px; box-sizing: border-box;}
    .mgr-panel.open { bottom: 0; }
</style>
</head>

<body>

<div id="sidebar">
    <div id="list-view">
        <div id="sidebar-header">
            <h3 style="margin:0">Route Stops</h3>
            <p id="stop-count" style="font-size:12px; color:#aaa;">Ready</p>
        </div>
        <div id="stop-list"></div>
    </div>
    <div id="customer-profile">
        <button class="btn" style="background:#444;" onclick="closeProfile()">‚Üê BACK</button>
        <h3 id="prof-name">Customer</h3>
        <p id="prof-addr" style="font-size:12px; color:#aaa;"></p>
        <div class="profile-group"><label>18L BOTTLES</label><input type="number" id="p-18l" value="0"></div>
        <div class="profile-group"><label>SMALL BOTTLES</label><input type="number" id="p-small" value="0"></div>
        <div class="profile-group"><label>NOTES</label><textarea id="p-notes" rows="3"></textarea></div>
        <canvas id="sig-canvas"></canvas>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn" onclick="submitLog('DELIVERED')">DELIVERED</button>
            <button class="btn" style="background:#dc3545;" onclick="submitLog('FAILED')">FAILED</button>
        </div>
    </div>
</div>

<div id="main-view">
    <div id="current-stop-info">
        <div id="info-text"><b id="head-name">No Route Loaded</b><br><span id="head-addr">Select route</span></div>
    </div>
    <div id="controls">
        <select id="route-select" class="btn" style="background:#333;">
            <option value="WEEK 1 MONDAY">WEEK 1 MONDAY</option>
            <option value="WEEK 1 TUESDAY">WEEK 1 TUESDAY</option>
            <option value="WEEK 1 WEDNESDAY">WEEK 1 WEDNESDAY</option>
            <option value="WEEK 1 THURSDAY">WEEK 1 THURSDAY</option>
            <option value="WEEK 1 FRIDAY">WEEK 1 FRIDAY</option>
            <option value="WEEK 2 MONDAY">WEEK 2 MONDAY</option>
            <option value="WEEK 2 TUESDAY">WEEK 2 TUESDAY</option>
            <option value="WEEK 2 WEDNESDAY">WEEK 2 WEDNESDAY</option>
            <option value="WEEK 2 THURSDAY">WEEK 2 THURSDAY</option>
            <option value="WEEK 2 FRIDAY">WEEK 2 FRIDAY</option>
            <option value="VALLEY VIEW">VALLEY VIEW</option>
            <option value="DAWSON CREEK">DAWSON CREEK</option>
            <option value="SALT">SALT</option>
        </select>
        <button class="btn" onclick="loadRoute()">Load</button>
        <button class="btn" style="background:#666;" onclick="toggleManager()">Manager Panel</button>
    </div>
    <div id="map"></div>

    <div id="manager-panel" class="mgr-panel">
        <button class="btn" style="background:red;" onclick="toggleManager()">CLOSE</button>
        <h2>Global Search</h2>
        <input type="text" id="global-search-input" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Company Name...">
        <button class="btn" onclick="runGlobalSearch()">SEARCH ALL SHEETS</button>
        <select id="global-results-drop" style="width:100%; margin-top:10px; padding:10px;"></select>
        <button class="btn" style="background:#ffc107; color:black; margin-top:20px; width:100%;" onclick="executeEOD()">END OF DAY</button>
    </div>
</div>

<script>
    /** CONFIG **/
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMfGuDRFTGBWyrG2CVFVOBSUzyORpxd4aTVZaStpuF54zkryeKdFU0PLIIaIgk-w0M/exec"; 
    const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";

    let map, stops = [], currentStopIndex = 0, deliveryLog = [], canvas, ctx, drawing = false;

    window.onload = () => {
        map = L.map('map').setView([55.1707, -118.7947], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        initSig();
    };

    function toggleManager() { document.getElementById('manager-panel').classList.toggle('open'); }

    async function runGlobalSearch() {
        const term = document.getElementById('global-search-input').value;
        try {
            const res = await fetch(`${SCRIPT_URL}?action=searchGlobal&name=${encodeURIComponent(term)}`, {
                method: 'GET',
                redirect: 'follow'
            });
            const data = await res.json();
            const drop = document.getElementById('global-results-drop');
            drop.innerHTML = '';
            data.forEach(item => {
                const opt = document.createElement('option');
                opt.text = `${item.company} (${item.route})`;
                drop.add(opt);
            });
            alert("Search Complete.");
        } catch (e) { alert("Search Error."); }
    }

    async function loadRoute() {
        const sheetName = document.getElementById('route-select').value;
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        stops = json.table.rows.map(r => ({ company: r.c[0]?.v || "Unknown", address: r.c[1]?.v || "" }));
        renderSidebar();
    }

    function renderSidebar() {
        const list = document.getElementById('stop-list');
        list.innerHTML = "";
        stops.forEach((s, i) => {
            const d = document.createElement('div');
            d.className = 'stop-card';
            d.innerHTML = `<b>${i+1}. ${s.company}</b>`;
            d.onclick = () => openProfile(i);
            list.appendChild(d);
        });
    }

    function openProfile(i) {
        currentStopIndex = i;
        document.getElementById('list-view').style.display = 'none';
        document.getElementById('customer-profile').style.display = 'block';
        document.getElementById('prof-name').innerText = stops[i].company;
        document.getElementById('prof-addr').innerText = stops[i].address;
    }

    function closeProfile() {
        document.getElementById('list-view').style.display = 'block';
        document.getElementById('customer-profile').style.display = 'none';
    }

    function submitLog(status) {
        deliveryLog.push({ customer: stops[currentStopIndex].company, status: status, time: new Date().toLocaleTimeString() });
        closeProfile();
    }

    function initSig() {
        canvas = document.getElementById('sig-canvas');
        ctx = canvas.getContext('2d');
        const getPos = e => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        };
        const start = e => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
        const move = e => { if(drawing) { const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); } };
        const end = () => drawing = false;
        canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
        canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move); window.addEventListener('touchend', end);
    }

    async function executeEOD() {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "EOD", driver: "User", log: deliveryLog }) });
        alert("EOD Saved.");
    }
</script>
</body>
</html>
