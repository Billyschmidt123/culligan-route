<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Culligan Route Manager</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* RESTORED: Factory Colors and Layout */
        body { margin: 0; height: 100vh; display: flex; flex-direction: row; font-family: 'Segoe UI', sans-serif; background: #111; color: white; overflow: hidden; }
        #sidebar { width: 320px; background: #222; border-right: 2px solid #0078ff; display: flex; flex-direction: column; flex-shrink: 0; }
        #sidebar-header { padding: 15px; border-bottom: 1px solid #444; }
        #stop-list { flex: 1; overflow-y: auto; padding: 10px; }
        .stop-card { background: #333; padding: 12px; margin-bottom: 10px; border-radius: 4px; border-left: 4px solid #0078ff; font-size: 13px; cursor: pointer; }
        .stop-card:hover { background: #444; }

        #main-view { flex: 1; display: flex; flex-direction: column; }
        #controls { background: #222; padding: 15px; border-bottom: 2px solid #0078ff; display: flex; gap: 10px; align-items: center; }
        #map { flex: 1; width: 100%; }
        
        /* RESTORED: Blue Action Buttons */
        .btn { padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-blue { background: #0078ff; }
        select { padding: 9px; background: #333; color: white; border: 1px solid #444; border-radius: 4px; width: 160px; }

        /* Map Pin Styling */
        .number-pin { background: #0078ff; color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5); }
        
        #dataModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:5000; align-items:center; justify-content:center; }
        .modal-content { background:#222; padding:20px; border-radius:8px; width:380px; border:1px solid #444; }
        .field-row { margin-bottom: 12px; }
        .field-row label { display: block; font-size: 12px; color: #aaa; margin-bottom: 4px; }
        .field-row input, .field-row textarea { width: 100%; padding: 8px; background: #111; border: 1px solid #444; color: white; box-sizing: border-box; }
        #sig-canvas { background: white; width: 100%; height: 120px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="sidebar-header">
        <h3 style="margin:0">Culligan Logistics</h3>
        <p id="stop-count" style="font-size: 12px; color: #aaa;">No route loaded</p>
        <button class="btn btn-blue" style="width:100%; margin-top:10px;" onclick="alert('Admin Login Required')">Manager Portal</button>
    </div>
    <div id="stop-list"></div>
</div>

<div id="main-view">
    <div id="controls">
        <select id="routeSelector"><option value="">Loading Routes...</option></select>
        <button class="btn btn-blue" onclick="loadSelectedRoute()">Load & Optimize</button>
        <div id="status" style="font-size: 13px; color: #aaa;">Status: Ready</div>
    </div>
    <div id="map"></div>
</div>

<div id="dataModal">
    <div class="modal-content">
        <h3 id="mCustName" style="color:#0078ff; margin-top:0;">Customer</h3>
        <div class="field-row"><label>18L Delivered</label><input type="number" id="inv18L" value="0"></div>
        <div class="field-row"><label>Signature</label><canvas id="sig-canvas"></canvas></div>
        <div class="field-row"><label>Notes</label><textarea id="driverNotes" rows="2"></textarea></div>
        <button class="btn btn-blue" style="width:100%; margin-bottom:10px;" onclick="processStop()">COMPLETE DELIVERY</button>
        <button class="btn" style="width:100%; background:#444;" onclick="document.getElementById('dataModal').style.display='none'">Cancel</button>
    </div>
</div>

<script>
    const API_URL = "YOUR_DEPLOYED_APPS_SCRIPT_URL"; // REPLACE THIS
    let map, markerLayer, routeLine, stops = [], activeIndex = -1, canvas, ctx, drawing = false;

    window.onload = () => {
        map = L.map("map").setView([55.17, -118.79], 12);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        markerLayer = L.layerGroup().addTo(map);
        routeLine = L.polyline([], { color: '#0078ff', weight: 5, opacity: 0.7 }).addTo(map);
        fetchRouteList();
    };

    async function fetchRouteList() {
        const res = await fetch(API_URL);
        const tabs = await res.json();
        const selector = document.getElementById('routeSelector');
        selector.innerHTML = tabs.filter(t => t !== 'Deliveries').map(t => `<option value="${t}">${t}</option>`).join('');
    }

    async function loadSelectedRoute() {
        const tab = document.getElementById('routeSelector').value;
        document.getElementById('status').innerText = "Loading...";
        const res = await fetch(`${API_URL}?sheet=${encodeURIComponent(tab)}`);
        let rawStops = await res.json();
        
        // FEATURE: Auto-Optimization Logic 
        const warehouse = { lat: 55.1707, lng: -118.7947 };
        let unvisited = [...rawStops], ordered = [], currentPos = warehouse;
        while (unvisited.length > 0) {
            unvisited.sort((a, b) => Math.hypot(a.lat - currentPos.lat, a.lng - currentPos.lng) - Math.hypot(b.lat - currentPos.lat, b.lng - currentPos.lng));
            let closest = unvisited.shift();
            ordered.push(closest);
            currentPos = closest;
        }
        stops = ordered;
        render();
        document.getElementById('status').innerText = "Optimized";
    }

    function render() {
        markerLayer.clearLayers();
        let path = [[55.1707, -118.7947]];
        const list = document.getElementById('stop-list'); 
        list.innerHTML = "";
        
        stops.forEach((s, i) => {
            path.push([s.lat, s.lng]);
            // RESTORED: Numbered Pin [cite: 108, 144]
            L.marker([s.lat, s.lng], { icon: L.divIcon({ html: `<div class="number-pin">${i+1}</div>`, className:'' }) }).addTo(markerLayer);
            
            const card = document.createElement('div');
            card.className = "stop-card";
            card.innerHTML = `<b>#${i+1} ${s.Company || s.Customer}</b><br><small>${s.Address}</small>`;
            card.onclick = () => openModal(i);
            list.appendChild(card);
        });
        routeLine.setLatLngs(path);
        map.fitBounds(L.polyline(path).getBounds(), { padding: [30, 30] });
        document.getElementById('stop-count').innerText = `${stops.length} Stops Found`;
    }

    function openModal(idx) {
        activeIndex = idx;
        document.getElementById('mCustName').innerText = stops[idx].Company || stops[idx].Customer;
        document.getElementById('dataModal').style.display = "flex";
        initCanvas();
    }

    function initCanvas() {
        canvas = document.getElementById('sig-canvas');
        ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = 120;
        ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
        canvas.onmousedown = (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
        canvas.onmousemove = (e) => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
        window.onmouseup = () => drawing = false;
    }

    async function processStop() {
        // Logic for PDF generation and POST to Spreadsheet goes here
        alert("Delivery Recorded and PDF Generated.");
        document.getElementById('dataModal').style.display = 'none';
    }
</script>
</body>
</html>
