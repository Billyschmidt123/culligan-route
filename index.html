<div id="global-search-tab" class="mgr-content">
    <h3>SEARCH ALL ROUTES</h3>
    <input type="text" id="global-search-input" placeholder="Enter Company Name..." style="width:100%; padding:12px; margin-bottom:10px;">
    <button class="btn" onclick="runGlobalSearch()" style="width:100%;">Execute Global Search</button>
    
    <div id="search-progress" style="margin-top:10px; font-size:12px; color:#0078ff; font-weight:bold; min-height:15px;"></div>
    
    <div id="search-results-list" style="margin-top:20px;"></div>
</div>

<script>
/** RESTORED & IMPROVED GLOBAL SEARCH LOGIC **/
async function runGlobalSearch() {
    const term = document.getElementById('global-search-input').value;
    const progressDiv = document.getElementById('search-progress');
    const resultsDiv = document.getElementById('search-results-list');
    
    if(!term) return alert("Enter a name");
    
    resultsDiv.innerHTML = "";
    // Reset Progress Bar
    progressDiv.innerHTML = "Initializing Deep Scan...";

    try {
        // We use a list of your specific routes to show progress as it "looks" through them
        const routesToSearch = [
            "WEEK 1 MONDAY", "WEEK 1 TUESDAY", "WEEK 1 WEDNESDAY", "WEEK 1 THURSDAY", "WEEK 1 FRIDAY",
            "WEEK 2 MONDAY", "WEEK 2 TUESDAY", "WEEK 2 WEDNESDAY", "WEEK 2 THURSDAY", "WEEK 2 FRIDAY",
            "WEEK 3 MONDAY", "WEEK 3 TUESDAY", "WEEK 3 WEDNESDAY", "WEEK 3 THURSDAY", "WEEK 3 FRIDAY",
            "WEEK 4 MONDAY", "WEEK 4 TUESDAY", "WEEK 4 WEDNESDAY", "WEEK 4 THURSDAY", "WEEK 4 FRIDAY",
            "VALLEY VIEW", "NORTH", "DAWSON CREEK", "SALT"
        ];

        let allFound = [];
        
        for (let route of routesToSearch) {
            // Update the Progress Bar below the search box
            progressDiv.innerHTML = `Searching in: <span style="color:white">${route}</span>...`;
            
            // Call the Script for this specific sheet
            const res = await fetch(`${SCRIPT_URL}?action=searchGlobal&name=${encodeURIComponent(term)}&targetSheet=${encodeURIComponent(route)}`, {
                method: 'GET',
                redirect: 'follow'
            });
            const data = await res.json();
            
            if (data && data.length > 0) {
                allFound = [...allFound, ...data];
            }
        }

        // Final UI Update
        progressDiv.innerHTML = "SEARCH COMPLETE";
        resultsDiv.innerHTML = "";
        
        if(allFound.length === 0) {
            resultsDiv.innerHTML = `<div style="color:#dc3545">No matches found for "${term}" in any route file.</div>`;
        } else {
            allFound.forEach(item => {
                const card = document.createElement('div');
                card.style = "background:#333; padding:10px; margin-bottom:5px; border-left:4px solid #0078ff; border-radius:4px;";
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <b>${item.company}</b>
                        <span style="color:#0078ff; font-size:10px;">${item.route}</span>
                    </div>
                    <small style="color:#aaa;">${item.address}</small>
                `;
                resultsDiv.appendChild(card);
            });
        }
    } catch (e) { 
        progressDiv.innerHTML = `<span style="color:red">ERROR: Check Script Permissions</span>`;
        resultsDiv.innerHTML = "Search failed to connect to database."; 
    }
}
</script>
