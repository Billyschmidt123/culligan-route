<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Culligan Route - Professional</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    body { margin:0; height:100vh; display:flex; font-family:'Segoe UI',sans-serif; background:#111; color:white; overflow:hidden;}
    #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column; z-index: 20;}
    #sidebar-header { padding:15px; border-bottom:1px solid #444;}
    #stop-list { flex:1; overflow-y:auto; padding:10px;}
    .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer;}
    #main-view { flex:1; display:flex; flex-direction:column; position: relative;}
    #controls { background:#222; padding:15px; border-bottom:2px solid #0078ff; display: flex; align-items: center; gap: 10px; z-index: 100;}
    #map { flex:1; z-index: 1;}
    .btn { padding:12px 20px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold; min-width: 120px;}
    #status { font-size:13px; color:#0078ff; font-weight: bold; margin-left: 10px;}
    .number-pin { background:#0078ff; color:white; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white;}
</style>
</head>

<body>

<div id="sidebar">
    <div id="sidebar-header">
        <h3 style="margin:0">Route Stops</h3>
        <p id="stop-count" style="font-size:12px; color:#aaa;">Ready to load</p>
    </div>
    <div id="stop-list"></div>
</div>

<div id="main-view">
    <div id="controls">
        <select id="route-select" style="padding:10px; background:#333; color:white; border:1px solid #444;">
            <option value="WEEK 1 MONDAY">WEEK 1 MONDAY</option>
            <option value="WEEK 1 TUESDAY">WEEK 1 TUESDAY</option>
            <option value="WEEK 1 WEDNESDAY">WEEK 1 WEDNESDAY</option>
            <option value="WEEK 1 THURSDAY">WEEK 1 THURSDAY</option>
            <option value="WEEK 1 FRIDAY">WEEK 1 FRIDAY</option>
            <option value="WEEK 2 MONDAY">WEEK 2 MONDAY</option>
            <option value="WEEK 2 TUESDAY">WEEK 2 TUESDAY</option>
            <option value="WEEK 3 MONDAY">WEEK 3 MONDAY</option>
            <option value="WEEK 4 MONDAY">WEEK 4 MONDAY</option>
            <option value="VALLEY VIEW">VALLEY VIEW</option>
            <option value="NORTH">NORTH</option>
            <option value="DAWSON CREEK">DAWSON CREEK</option>
            <option value="SALT">SALT</option>
        </select>
        <button type="button" class="btn" id="load-btn" onclick="loadRoute()">LOAD ROUTE</button>
        <div id="status">STATUS: READY</div>
    </div>
    <div id="map"></div>
</div>

<script>
// 1. GLOBALS FIRST
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";
let map, markerLayer, stops = [];
const warehouse = [55.1707, -118.7947];

// 2. DEFINE THE FUNCTION GLOBALLY SO THE BUTTON CAN SEE IT
async function loadRoute() {
    console.log("Load Route Clicked");
    const sheetName = document.getElementById("route-select").value;
    const statusDiv = document.getElementById("status");
    const list = document.getElementById("stop-list");
    
    statusDiv.innerText = "STATUS: FETCHING...";
    list.innerHTML = "Loading data from Google Sheets...";

    try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
        const res = await fetch(url);
        const text = await res.text();
        
        // Clean up Google's JSON response
        const jsonText = text.substring(text.indexOf("(") + 1, text.lastIndexOf(")"));
        const json = JSON.parse(jsonText);
        
        stops = [];
        const rows = json.table.rows;
        
        rows.forEach((row, i) => {
            const cols = row.c;
            // Column 3 is the address
            if (cols && cols[3] && cols[3].v) {
                stops.push({
                    company: cols[2] ? cols[2].v : "Customer",
                    address: cols[3].v,
                    lat: warehouse[0],
                    lng: warehouse[1]
                });
            }
        });

        updateSidebar();
        updateMap();
        
        statusDiv.innerText = "STATUS: LOADED";
        document.getElementById('stop-count').innerText = `${stops.length} Stops Found`;

    } catch (err) {
        console.error(err);
        statusDiv.innerText = "STATUS: ERROR";
        list.innerHTML = "Failed to load. Check Sheet permissions.";
    }
}

function updateSidebar() {
    const list = document.getElementById("stop-list");
    list.innerHTML = "";
    stops.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "stop-card";
        div.innerHTML = `<b>${i+1}. ${s.company}</b><br><small>${s.address}</small>`;
        div.onclick = () => map.setView([s.lat, s.lng], 14);
        list.appendChild(div);
    });
}

function updateMap() {
    if (!markerLayer) return;
    markerLayer.clearLayers();
    stops.forEach((s, i) => {
        L.marker([s.lat, s.lng], { 
            icon: L.divIcon({ className:'custom-div-icon', html:`<div class="number-pin">${i+1}</div>` }) 
        }).addTo(markerLayer);
    });
}

// 3. INITIALIZE MAP SEPARATELY
try {
    map = L.map("map").setView(warehouse, 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    markerLayer = L.layerGroup().addTo(map);
} catch (e) {
    console.error("Map initialization failed", e);
}
</script>
</body>
</html>
