<script>
// ... (Keep existing variables at the top)

// 1. UPDATED RENDER ROUTE: Initialize the polyline with all stops
function renderRoute() {
    markerLayer.clearLayers();
    const latlngs = [];
    stops.forEach((s, i) => {
        const pinClass = s.flagged ? 'number-pin warn' : 'number-pin';
        latlngs.push([s.lat, s.lng]);
        L.marker([s.lat, s.lng], { 
            icon: L.divIcon({ className:'custom-div-icon', html:`<div class="${pinClass}">${i+1}</div>` }) 
        }).addTo(markerLayer).bindPopup(`<b>${s.company}</b><br><button onclick="openProfile(${i})">Open Stop</button>`);
    });
    updateRouteLines(); // Call the dynamic line updater
    if (stops.length > 0) map.fitBounds(latlngs, {padding: [50, 50]});
}

// 2. NEW FUNCTION: Dynamic Route Lines (Removes completed legs)
function updateRouteLines() {
    // Only draw the line starting from the current stop index to the end
    const remainingPath = stops.slice(currentStopIndex).map(s => [s.lat, s.lng]);
    routeLine.setLatLngs(remainingPath);
}

// 3. UPDATED GOOGLE MAPS LINK: Fixed for mobile/turn-by-turn
function openGoogleMaps() {
    if (stops.length === 0) return;
    const s = stops[currentStopIndex];
    const destination = encodeURIComponent(`${s.address}, Grande Prairie, AB`);
    // 'google.navigation' works on Android/iOS to trigger the app directly
    const url = `https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`;
    window.open(url, '_blank');
}

// 4. UPDATED SUBMIT LOG: Handles Auto-EOD and Line Updates
async function submitLog(status) {
    const now = new Date();
    const s = stops[currentStopIndex];
    
    const entry = {
        customer: s.company,
        status: status,
        time: now.toLocaleTimeString(),
        date: now.toLocaleDateString(),
        v18l: document.getElementById('p-18l').value || 0,
        vSmall: document.getElementById('p-small').value || 0,
        vCases: document.getElementById('p-cases').value || 0,
        r18l: document.getElementById('p-18l-ret').value || 0,
        rSmall: document.getElementById('p-small-ret').value || 0,
        notes: document.getElementById('p-notes').value || "",
        reason: ""
    };

    if (status === 'NOT DELIVERED') {
        entry.reason = prompt("Reason for skip:");
        if(!entry.reason) return;
    } else {
        // PDF Receipt Generation (kept from previous version)
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Culligan Receipt", 20, 20);
        doc.text(`Customer: ${entry.customer}`, 20, 40);
        const sigData = canvas.toDataURL("image/png");
        doc.addImage(sigData, 'PNG', 20, 70, 50, 25);
        entry.pdfData = doc.output('datauristring').split(',')[1];
        entry.filename = `Culligan_${entry.customer}_${now.getTime()}.pdf`;
    }

    deliveryLog.push(entry);
    updateReports();

    // Check if this was the last stop
    if (currentStopIndex === stops.length - 1) {
        updateRouteLines(); // Clear the last line
        closeProfile();
        setTimeout(() => {
            if (confirm("üèÅ ROUTE COMPLETE!\n\nWould you like to run the End of Day report and zip today's slips?")) {
                executeEOD();
            }
        }, 500);
    } else {
        // Move to next stop
        currentStopIndex++;
        updateHeader();
        updateRouteLines(); // Shorten the blue line
        closeProfile();
        map.setView([stops[currentStopIndex].lat, stops[currentStopIndex].lng], 16);
    }

    // Send to Google Sheet
    try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(entry) });
    } catch (e) { console.error("Sheet sync failed"); }
}

// 5. UPDATED EOD: Adds success confirmation
async function executeEOD() {
    const route = document.getElementById("route-select").value;
    const longDate = new Date().toLocaleDateString('en-GB', { 
        weekday:'long', year:'numeric', month:'long', day:'numeric' 
    });
    
    const eodPayload = { 
        action: "EOD", 
        route: route, 
        longDate: longDate, 
        summary: document.getElementById('summary-data').innerText, 
        log: deliveryLog 
    };

    document.getElementById('status').innerText = "Running EOD...";
    try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(eodPayload) });
        alert("‚úÖ End of Day Successful!\nSummary saved and PDFs zipped.");
    } catch(e) { 
        alert("EOD Error. Please check connection."); 
    }
    document.getElementById('status').innerText = "Ready";
}
</script>
