<!DOCTYPE html>
<html>
<head>
    <title>Culligan Delivery Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 350px; width: 100%; border-bottom: 2px solid #ccc; }
        .stop-list { padding: 15px; }
        .stop-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        #dataModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 20px; }
        #sig-canvas { background: white; border-radius: 5px; margin: 15px 0; touch-action: none; width: 100%; max-width: 400px; height: 150px; }
        #ticket-output { display: none; width: 500px; padding: 40px; background: white; color: black; }
        input, textarea { width: 90%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; font-size: 16px; }
        .btn { padding: 15px 30px; border: none; border-radius: 5px; font-weight: bold; margin: 10px; width: 45%; font-size: 16px; }
        .btn-save { background: #28a745; color: white; }
        .btn-cancel { background: #dc3545; color: white; }
    </style>
</head>
<body>

<div id="map"></div>
<div class="stop-list" id="stop-list"></div>

<div id="dataModal">
    <h2 id="mCustName">Customer</h2>
    <input type="number" id="inv18L" placeholder="18L Bottles Delivered">
    <textarea id="driverNotes" rows="3" placeholder="Notes (optional)"></textarea>
    <p>Customer Signature:</p>
    <canvas id="sig-canvas"></canvas>
    <div style="width: 100%; text-align: center;">
        <button class="btn btn-save" onclick="processStop('Delivered')">SUBMIT</button>
        <button class="btn btn-cancel" onclick="closeModal()">CANCEL</button>
    </div>
</div>

<div id="ticket-output">
    <div style="text-align: center; border-bottom: 2px solid #0078ff; padding-bottom: 10px;">
        <h1 style="color: #0078ff; margin: 0;">CULLIGAN WATER</h1>
        <p style="margin: 0;">Delivery Confirmation</p>
    </div>
    <div style="margin-top: 20px;">
        <p><b>Customer:</b> <span id="t-cust"></span></p>
        <p><b>Date:</b> <span id="t-date"></span></p>
        <p><b>Driver:</b> <span id="t-driver"></span></p>
        <p><b>Quantity:</b> 18L Bottles: <span id="t-inv"></span></p>
        <p><b>Notes:</b> <span id="t-notes"></span></p>
    </div>
    <div style="margin-top: 30px;">
        <p><b>Authorized Signature:</b></p>
        <img id="t-sig" style="width: 100%; border: 1px solid #eee;">
    </div>
</div>

<script>
    // YOUR URL INTEGRATED BELOW
    const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbzMfGuDRFTGBWyrG2CVFVOBSUzyORpxd4aTVZaStpuF54zkryeKdFU0PLIIaIgk-w0M/exec";

    let map, activeIndex, canvas, ctx, drawing = false;
    let driverName = "Driver_1";
    let stops = [
        { company: "TEST_UFA_FARM", address: "123 Farm Road", lat: 55.17, lng: -118.79 },
        { company: "Culligan Warehouse", address: "101 Main St", lat: 55.18, lng: -118.80 }
    ];

    async function processStop(status) {
        const now = new Date();
        const longDate = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const bottles = document.getElementById('inv18L').value;
        const notes = document.getElementById('driverNotes').value;

        document.getElementById('t-cust').innerText = stops[activeIndex].company;
        document.getElementById('t-driver').innerText = driverName;
        document.getElementById('t-date').innerText = longDate;
        document.getElementById('t-inv').innerText = bottles;
        document.getElementById('t-notes').innerText = notes;
        document.getElementById('t-sig').src = canvas.toDataURL();

        const ticket = document.getElementById('ticket-output');
        ticket.style.display = "block";

        const opt = { margin: 0.5, filename: 'delivery.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };

        html2pdf().set(opt).from(ticket).outputPdf('datauristring').then(pdfData => {
            ticket.style.display = "none";
            
            const payload = {
                Customer: stops[activeIndex].company,
                DriverID: driverName,
                LongDate: longDate,
                pdfData: pdfData,
                FileName: `${stops[activeIndex].company} - ${longDate}.pdf`
            };

            fetch(SHEETS_API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(() => {
                alert("Success! PDF Sent to Drive.");
                closeModal();
            })
            .catch(err => alert("Error: " + err));
        });
    }

    function initCanvas() {
        canvas = document.getElementById('sig-canvas');
        ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth; 
        canvas.height = 150;
        ctx.strokeStyle = "#000"; ctx.lineWidth = 3;

        const getXY = (e) => {
            const r = canvas.getBoundingClientRect();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            return { x: clientX - r.left, y: clientY - r.top };
        };
        const start = (e) => { drawing = true; const p = getXY(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
        const move = (e) => { if(!drawing) return; e.preventDefault(); const p = getXY(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
        const stop = () => drawing = false;

        canvas.onmousedown = start; canvas.onmousemove = move; window.onmouseup = stop;
        canvas.ontouchstart = start; canvas.ontouchmove = move; canvas.ontouchend = stop;
    }

    function closeModal() { document.getElementById('dataModal').style.display = 'none'; }

    window.onload = () => {
        map = L.map("map").setView([55.17, -118.79], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        
        const list = document.getElementById('stop-list');
        stops.forEach((s, i) => {
            const card = document.createElement('div');
            card.className = "stop-card";
            card.innerHTML = `<b>${s.company}</b><br>${s.address}`;
            card.onclick = () => {
                activeIndex = i;
                document.getElementById('mCustName').innerText = s.company;
                document.getElementById('dataModal').style.display = 'flex';
                setTimeout(initCanvas, 100);
            };
            list.appendChild(card);
            L.marker([s.lat, s.lng]).addTo(map);
        });
    };
</script>
</body>
</html>
