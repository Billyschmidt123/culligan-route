<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Culligan Route - Brute Force Debug</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    body { margin:0; height:100vh; display:flex; font-family:sans-serif; background:#111; color:white; overflow:hidden;}
    #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column;}
    #stop-list { flex:1; overflow-y:auto; padding:10px;}
    .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer;}
    #main-view { flex:1; position: relative; display:flex; flex-direction:column;}
    #map { flex:1; }
    #controls { background:#222; padding:15px; border-bottom:2px solid #0078ff; display:flex; gap:10px; align-items:center;}
    .btn { padding:10px; background:#0078ff; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;}
    input { padding:10px; background:#333; border:1px solid #444; color:white; border-radius:4px; flex:1;}
    
    #debug-panel { position:absolute; bottom:0; left:0; right:0; height:150px; background:rgba(0,0,0,0.9); border-top:2px solid #ffc107; font-family:monospace; font-size:11px; padding:10px; overflow-y:auto; z-index:2000; display:none;}
    .debug-err { color: #ff4d4d; }
    .debug-ok { color: #2ecc71; }
</style>
</head>
<body>

<div id="sidebar">
    <div id="sidebar-header" style="padding:15px; border-bottom:1px solid #444;">
        <h3 style="margin:0">Culligan Route</h3>
        <p id="status" style="font-size:12px; color:#0078ff;">Ready</p>
    </div>
    <div id="stop-list"></div>
</div>

<div id="main-view">
    <div id="controls">
        <input type="text" id="search-input" placeholder="Search customer (e.g. Rexall)">
        <button class="btn" onclick="runGlobalSearch()">Global Search</button>
        <button class="btn" style="background:#6c757d" onclick="toggleDebug()">Debug Log</button>
    </div>
    <div id="map"></div>
    <div id="debug-panel" id="debug-log">
        <div style="color:#ffc107; font-weight:bold; margin-bottom:5px;">SYSTEM DEBUG LOG:</div>
        <div id="log-content"></div>
    </div>
</div>

<script>
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";
const ALL_SHEETS = ["WEEK 1 MONDAY", "WEEK 1 TUESDAY", "WEEK 1 WEDNESDAY", "WEEK 1 THURSDAY", "WEEK 1 FRIDAY", "VALLEY VIEW", "NORTH", "DAWSON CREEK", "SALT"];

let map = L.map("map").setView([55.1707, -118.7947], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

function addLog(msg, type='') {
    const log = document.getElementById('log-content');
    log.innerHTML += `<div class="${type}">${new Date().toLocaleTimeString()}: ${msg}</div>`;
    log.scrollTop = log.scrollHeight;
}

function toggleDebug() {
    const p = document.getElementById('debug-panel');
    p.style.display = p.style.display === 'none' ? 'block' : 'none';
}

async function runGlobalSearch() {
    const term = document.getElementById('search-input').value.trim().toLowerCase();
    if(!term) return alert("Enter a name");

    document.getElementById('status').innerText = "Scanning Sheets...";
    document.getElementById('stop-list').innerHTML = "";
    document.getElementById('debug-panel').style.display = 'block';
    addLog(`Starting global search for: "${term}"`);

    let totalMatches = 0;

    for (let name of ALL_SHEETS) {
        addLog(`Requesting Sheet: ${name}...`);
        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}`;
            const res = await fetch(url);
            const text = await res.text();
            
            // Clean the JSON response from Google
            const json = JSON.parse(text.substring(47).slice(0, -2));
            
            if (!json.table || !json.table.rows) {
                addLog(`Sheet ${name} returned no data structure.`, 'debug-err');
                continue;
            }

            const rows = json.table.rows;
            addLog(`Sheet ${name} loaded. Rows found: ${rows.length}`, 'debug-ok');

            rows.forEach((row, idx) => {
                // Flatten row to searchable text
                const rowStr = row.c.map(cell => (cell && cell.v) ? cell.v.toString() : "").join(" ").toLowerCase();
                
                if (rowStr.includes(term)) {
                    totalMatches++;
                    createResultCard(row, name);
                }
            });

        } catch (e) {
            addLog(`Error reading ${name}: ${e.message}`, 'debug-err');
        }
    }

    document.getElementById('status').innerText = `Done: ${totalMatches} found`;
    addLog(`Search finished. Total matches: ${totalMatches}`);
}

function createResultCard(row, sheetName) {
    const list = document.getElementById('stop-list');
    // Attempt to extract Company/Address by skipping "NONE"
    const data = row.c.map(c => (c && c.v) ? c.v.toString() : "").filter(v => v !== "NONE" && v !== "");
    
    const div = document.createElement('div');
    div.className = 'stop-card';
    div.innerHTML = `
        <div style="font-size:10px; color:#0078ff;">FOUND IN: ${sheetName}</div>
        <b>${data[1] || "Unknown"}</b><br>
        <small>${data[2] || "No Address Found"}</small>
    `;
    list.appendChild(div);
}
</script>
</body>
</html>
