<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Culligan Route - Smart Search</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin:0; height:100vh; display:flex; font-family: sans-serif; background:#1a1a1a; color:white; }
        #sidebar { width:380px; background:#252525; border-right:3px solid #0078ff; display:flex; flex-direction:column; }
        #stop-list { flex:1; overflow-y:auto; padding:15px; }
        .stop-card { background:#333; padding:15px; border-radius:8px; border-left:5px solid #0078ff; margin-bottom:10px; cursor:pointer; }
        .sheet-label { font-size:10px; background:#0078ff; padding:2px 6px; border-radius:4px; float:right; }
        #main-view { flex:1; display:flex; flex-direction:column; }
        #map { flex:1; }
        #controls { background:#252525; padding:20px; border-bottom:1px solid #444; display:flex; gap:10px; }
        .btn { padding:12px; background:#0078ff; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
        input { padding:12px; background:#333; border:1px solid #444; color:white; border-radius:6px; flex:1; }
    </style>
</head>
<body>

<div id="sidebar">
    <div style="padding:20px; background:#0078ff;">
        <h2 style="margin:0;">Culligan Search</h2>
        <div id="status">Ready</div>
    </div>
    <div id="stop-list"></div>
</div>

<div id="main-view">
    <div id="controls">
        <input type="text" id="search-input" placeholder="Enter Name (e.g. Rexall or BearCom)">
        <button class="btn" onclick="smartSearch()">Search All Sheets</button>
    </div>
    <div id="map"></div>
</div>

<script>
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";

// Updated to match your exact file structure (including typos like 'Wednessday')
const TABS = [
    "Week 1 Monday", "Week 1 Tuesday", "Week 1 Wednessday", "Week 1 Thursday", "Week 1 Friday",
    "Week 2 Monday", "Week 2 Tuesday", "week 2 tues north ", "Week 2 Wednessday", "Week 2 Thursday", "Week 2 Friday",
    "Week 3 Monday ", "Week 3 Tuesday", "Week 3 Wednessday", "Week3 Thursday", "Week 3 Friday",
    "Week 4 Monday ", "Week 4 Tuesday", "Week 4 Wednessday", "Week 4 Thursday ", "Week 4 Friday",
    "Valleyview ", "North", "Dawson creek", "Salt"
];

let map = L.map("map").setView([55.1707, -118.7947], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

async function smartSearch() {
    const term = document.getElementById('search-input').value.trim().toLowerCase();
    if(!term) return;

    const list = document.getElementById('stop-list');
    const status = document.getElementById('status');
    list.innerHTML = "Searching...";
    
    let foundCount = 0;

    for (let tab of TABS) {
        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tab)}`;
            const res = await fetch(url);
            const text = await res.text();
            const json = JSON.parse(text.substring(47).slice(0, -2));
            
            if (json.table && json.table.rows) {
                json.table.rows.forEach(row => {
                    // Combine the entire row into one string to find the term anywhere
                    const rowData = row.c.map(cell => cell ? String(cell.v) : "");
                    const fullRowString = rowData.join(" ").toLowerCase();

                    if (fullRowString.includes(term)) {
                        foundCount++;
                        // Use a helper to find which column looks like an address
                        const displayTitle = rowData.find(v => v.toLowerCase().includes(term)) || rowData[2];
                        const displayAddress = rowData.find(v => /\d+/.test(v) && v.length > 5) || "Address not found";
                        
                        renderCard(displayTitle, displayAddress, tab, rowData.join(" | "));
                    }
                });
            }
        } catch (e) { console.log("Skip tab: " + tab); }
    }

    status.innerText = `Found ${foundCount} results`;
    if(foundCount === 0) list.innerHTML = "No matches. Check 'Share' settings on the Sheet.";
}

function renderCard(title, addr, tab, raw) {
    const list = document.getElementById('stop-list');
    if(list.innerHTML === "Searching...") list.innerHTML = "";
    
    const div = document.createElement('div');
    div.className = 'stop-card';
    div.innerHTML = `
        <span class="sheet-label">${tab}</span>
        <b>${title}</b><br>
        <small style="color:#bbb">${addr}</small>
    `;
    div.onclick = () => {
        const query = `${addr}, Grande Prairie, AB`;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(r => r.json()).then(data => {
                if(data[0]) {
                    const pos = [data[0].lat, data[0].lon];
                    map.setView(pos, 16);
                    L.marker(pos).addTo(map).bindPopup(title).openPopup();
                } else {
                    alert("Location found in list, but address is too vague for the map.");
                }
            });
    };
    list.appendChild(div);
}
</script>
</body>
</html>
