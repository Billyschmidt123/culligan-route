/**
 * Google Apps Script for Culligan Route Manager
 * Destination: cbwdeliveries@outlook.com
 * OneDrive Folder: deliveries
 */

function doGet(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  if (e.parameter.sheet) {
    const sheet = ss.getSheetByName(e.parameter.sheet);
    if (!sheet) return ContentService.createTextOutput("Sheet not found").setMimeType(ContentService.MimeType.TEXT);
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const json = data.slice(1).map(row => {
      let obj = {};
      headers.forEach((h, i) => obj[h] = row[i]);
      return obj;
    });
    return ContentService.createTextOutput(JSON.stringify(json)).setMimeType(ContentService.MimeType.JSON);
  }
  const sheets = ss.getSheets().map(s => s.getName());
  return ContentService.createTextOutput(JSON.stringify(sheets)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let deliverySheet = ss.getSheetByName("Deliveries");
    
    if (!deliverySheet) {
      deliverySheet = ss.insertSheet("Deliveries");
      deliverySheet.appendRow([
        "Timestamp", "Driver ID", "Customer", "Address", "Status", 
        "18L Delivered", "18L Returns", "Small Delivered", "Small Returns", 
        "Cases", "Received By", "Notes", "Route Name", "Long Date"
      ]);
    }

    deliverySheet.appendRow([
      data.Timestamp, data.DriverID, data.Customer, data.Address, data.Status,
      data.l18, data.r18, data.lSm, data.rSm, data.cs, data.recv,
      data.Notes, data.RouteName, data.LongDate
    ]);

    if (data.pdfData) {
      const pdfBlob = Utilities.newBlob(
        Utilities.base64Decode(data.pdfData.split(',')[1]), 
        'application/pdf', 
        data.FileName
      );

      // Sends to the OneDrive-mapped email address
      MailApp.sendEmail({
        to: "cbwdeliveries@outlook.com",
        subject: `Delivery Slip: ${data.Customer} - ${data.LongDate}`,
        body: `Culligan Delivery Log Entry\n\n` +
              `OneDrive Link: https://1drv.ms/f/c/b07d549f2e7d84b0/IgCJmNKMkKAzRJpPtk1JxN53ATccBNb97HwccTNHzCnxxk0?e=CzbUqh\n` +
              `Target Directory: deliveries`,
        attachments: [pdfBlob]
      });
    }

    return ContentService.createTextOutput("Success").setMimeType(ContentService.MimeType.TEXT);
  } catch (err) {
    return ContentService.createTextOutput("Error: " + err.toString()).setMimeType(ContentService.MimeType.TEXT);
  }
}
