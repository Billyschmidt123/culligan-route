<!DOCTYPE html>
<html>
<head>
    <title>Culligan Route Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #map { flex: 1; width: 100%; }
        .stop-list { height: 30%; overflow-y: auto; background: #f4f4f4; padding: 10px; }
        .stop-card { background: white; padding: 10px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #dataModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; color: white; }
        #sig-canvas { background: white; border: 1px solid #000; width: 90%; max-width: 400px; touch-action: none; }
        #ticket-output { display: none; width: 400px; padding: 20px; background: white; color: black; }
        .number-pin { background: #0078ff; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div class="stop-list" id="stop-list"></div>

    <div id="dataModal">
        <h2 id="mCustName">Customer Name</h2>
        <input type="number" id="inv18L" placeholder="18L Bottles" style="width: 80%; padding: 10px; margin: 10px;">
        <textarea id="driverNotes" placeholder="Notes" style="width: 80%; padding: 10px; margin: 10px;"></textarea>
        <canvas id="sig-canvas"></canvas>
        <div style="margin-top: 20px;">
            <button onclick="processStop('Delivered')" style="padding: 15px; background: green; color: white; border: none; border-radius: 5px;">Submit Delivery</button>
            <button onclick="document.getElementById('dataModal').style.display='none'" style="padding: 15px; background: red; color: white; border: none; border-radius: 5px;">Cancel</button>
        </div>
    </div>

    <div id="ticket-output">
        <h1 style="color: #0078ff;">CULLIGAN DELIVERY SLIP</h1>
        <hr>
        <p><b>Customer:</b> <span id="t-cust"></span></p>
        <p><b>Date:</b> <span id="t-date"></span></p>
        <p><b>Driver:</b> <span id="t-driver"></span></p>
        <p><b>Items:</b> 18L Bottles: <span id="t-inv"></span></p>
        <p><b>Notes:</b> <span id="t-notes"></span></p>
        <p><b>Signature:</b></p>
        <img id="t-sig" style="width: 100%; border-bottom: 1px solid black;">
    </div>

<script>
    const SHEETS_API_URL = "PASTE_YOUR_WEB_APP_URL_HERE";
    let map, markerLayer, routeLine, activeIndex, canvas, ctx, drawing = false;
    let driverName = "Driver 1"; // Replace with your driver login logic
    let stops = [
        { company: "TEST_UFA_FARM", address: "123 Farm Road", lat: 55.17, lng: -118.79 },
        { company: "Culligan Main", address: "Warehouse", lat: 55.18, lng: -118.80 }
    ];

    async function processStop(status) {
        const now = new Date();
        const longDate = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const bottles = document.getElementById('inv18L').value;
        const notes = document.getElementById('driverNotes').value;

        // Populate PDF template
        document.getElementById('t-cust').innerText = stops[activeIndex].company;
        document.getElementById('t-driver').innerText = driverName;
        document.getElementById('t-date').innerText = longDate;
        document.getElementById('t-inv').innerText = bottles;
        document.getElementById('t-notes').innerText = notes;
        document.getElementById('t-sig').src = canvas.toDataURL();

        const ticket = document.getElementById('ticket-output');
        ticket.style.display = "block";

        // Generate PDF as Data URI String
        html2pdf().from(ticket).outputPdf('datauristring').then(pdfData => {
            ticket.style.display = "none";
            
            const payload = {
                Timestamp: now.toLocaleString(), 
                DriverID: driverName, 
                Customer: stops[activeIndex].company,
                Address: stops[activeIndex].address, 
                Status: status, 
                Notes: notes,
                LongDate: longDate,
                FileName: `${stops[activeIndex].company}_${Date.now()}.pdf`, 
                pdfData: pdfData
            };

            fetch(SHEETS_API_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify(payload) 
            }).then(() => {
                document.getElementById('dataModal').style.display = 'none';
                alert("Delivery Saved and PDF Uploaded to Drive");
            });
        });
    }

    function initCanvas() {
        canvas = document.getElementById('sig-canvas');
        ctx = canvas.getContext('2d');
        canvas.width = 400; canvas.height = 150;
        ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
        canvas.onmousedown = (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); };
        canvas.onmousemove = (e) => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
        window.onmouseup = () => drawing = false;
        // Touch support
        canvas.ontouchstart = (e) => { 
            drawing = true; ctx.beginPath(); 
            let t = e.touches[0];
            ctx.moveTo(t.clientX - canvas.getBoundingClientRect().left, t.clientY - canvas.getBoundingClientRect().top);
        };
        canvas.ontouchmove = (e) => {
            if(drawing) {
                let t = e.touches[0];
                ctx.lineTo(t.clientX - canvas.getBoundingClientRect().left, t.clientY - canvas.getBoundingClientRect().top);
                ctx.stroke();
            }
        };
    }

    // Simplified Render for this example
    function render() {
        const list = document.getElementById('stop-list');
        stops.forEach((s, i) => {
            const card = document.createElement('div');
            card.className = "stop-card";
            card.innerHTML = `<b>${s.company}</b><br>${s.address}`;
            card.onclick = () => {
                activeIndex = i;
                document.getElementById('mCustName').innerText = s.company;
                document.getElementById('dataModal').style.display = "flex";
                initCanvas();
            };
            list.appendChild(card);
        });
    }

    window.onload = () => {
        map = L.map("map").setView([55.17, -118.79], 12);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        render();
    };
</script>
</body>
</html>
