<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Culligan Route - Professional v7.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { margin:0; height:100vh; display:flex; font-family:'Segoe UI',sans-serif; background:#111; color:white; overflow:hidden;}
        #sidebar { width:350px; background:#222; border-right:2px solid #0078ff; display:flex; flex-direction:column;}
        #sidebar-header { padding:15px; border-bottom:1px solid #444;}
        #stop-list { flex:1; overflow-y:auto; padding:10px;}
        .stop-card { background:#333; padding:10px; margin-bottom:8px; border-radius:4px; border-left:4px solid #0078ff; cursor:pointer; position: relative;}
        .stop-card.rush-order { border-left: 6px solid #a335ee !important; background: #331d44 !important; }
        #customer-profile { display:none; padding:15px; background:#222; overflow-y:auto; height:100%; }
        .profile-group { margin-bottom:12px; }
        .profile-group label { display:block; font-size:11px; color:#0078ff; font-weight:bold; margin-bottom:4px; text-transform: uppercase;}
        .profile-group input, .profile-group textarea, .profile-group select { width:100%; padding:8px; background:#333; border:1px solid #444; color:white; border-radius:4px; box-sizing:border-box; }
        
        /* Fixed Signature Pad Styling */
        #sig-canvas { background:white; border-radius:4px; width:100%; height:180px; touch-action: none; border: 2px solid #555; cursor: crosshair; display: block;}
        
        .form-btns { display:flex; flex-direction: column; gap:10px; margin-top:20px; padding-bottom: 40px;}
        .btn-del { width:100%; background:#28a745; color:white; border:none; padding:15px; border-radius:4px; cursor:pointer; font-weight:bold; font-size: 14px;}
        .btn-not { width:100%; background:#dc3545; color:white; border:none; padding:15px; border-radius:4px; cursor:pointer; font-weight:bold; font-size: 14px;}
        
        #main-view { flex:1; display:flex; flex-direction:column; position: relative;}
        #controls { background:#222; padding:15px; border-bottom:2px solid #0078ff; display: flex; align-items: center; gap: 10px;}
        #map { flex:1; }
        .btn { padding:10px 15px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;}
        .btn-mgr { background:#6c757d; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer; font-weight:bold;}
        .number-pin { color:white; width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid white;}
        
        #manager-panel { position: absolute; bottom: -100%; left: 0; width: 100%; height: 95%; background: #1a1a1a; z-index: 1000; transition: bottom 0.4s ease; border-top: 3px solid #0078ff; overflow-y: auto;}
        #manager-panel.open { bottom: 0; }
        .mgr-tabs { display: flex; background: #222; border-bottom: 1px solid #444; position: sticky; top: 0; z-index: 10;}
        .mgr-tab-btn { padding: 15px 25px; border: none; background: none; color: #aaa; cursor: pointer; font-weight: bold; }
        .mgr-tab-btn.active { color: #0078ff; border-bottom: 2px solid #0078ff; background: #2a2a2a; }
        .mgr-content { padding: 20px; display: none; color: white;}
        .mgr-content.active { display: block; }
        
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; }
        .edit-modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#222; border:2px solid #0078ff; padding:20px; z-index:2001; width:90%; max-width:550px; border-radius:8px; max-height: 90vh; overflow-y: auto;}
        
        .search-result-card { background: #333; padding: 15px; border-radius: 5px; margin-bottom: 10px; cursor: pointer; border-left: 4px solid #0078ff; }
        .search-result-card:hover { background: #444; }
    </style>
</head>
<body>

<div id="sidebar">
    <div id="list-view">
        <div id="sidebar-header">
            <h3 style="margin:0">Route Stops</h3>
            <p id="stop-count" style="font-size:12px; color:#aaa;">Ready</p>
        </div>
        <div id="stop-list"></div>
    </div>
    
    <div id="customer-profile">
        <button onclick="closeProfile()" style="background:#444; color:white; border:none; padding:10px; width:100%; margin-bottom:15px; border-radius:4px; cursor:pointer;">‚Üê RETURN TO LIST</button>
        <h3 id="prof-name">Customer Name</h3>
        <p id="prof-addr" style="font-size:12px; color:#0078ff; margin-top:-10px; font-weight:bold;"></p>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="profile-group"><label>18L Delivered</label><input type="number" id="p-18l" value="0"></div>
            <div class="profile-group"><label>18L Empties</label><input type="number" id="p-18l-emp" value="0"></div>
            <div class="profile-group"><label>Sm Bottles</label><input type="number" id="p-sm-btl" value="0"></div>
            <div class="profile-group"><label>Sm Empties</label><input type="number" id="p-sm-emp" value="0"></div>
            <div class="profile-group"><label>Cases</label><input type="number" id="p-cases" value="0"></div>
            <div class="profile-group"><label>Received By</label><input type="text" id="p-rec-by"></div>
        </div>

        <div class="profile-group"><label>Notes for Driver</label><textarea id="p-notes" rows="2" readonly style="background:#222;"></textarea></div>

        <label style="font-size:11px; color:#0078ff; font-weight:bold;">CUSTOMER SIGNATURE</label>
        <canvas id="sig-canvas"></canvas>
        <button onclick="clearSig()" style="width:100%; margin:5px 0; background:#444; color:white; border:none; padding:8px; font-size:11px; cursor:pointer; border-radius:4px;">CLEAR SIGNATURE</button>

        <div class="form-btns">
            <button class="btn-del" onclick="processStopSubmission('DELIVERED')">COMPLETE DELIVERY</button>
            <div style="border-top: 1px solid #444; padding-top:10px; margin-top:10px;">
                <label style="font-size:10px; color:#aaa;">REASON FOR NON-DELIVERY:</label>
                <input type="text" id="p-fail-reason" placeholder="e.g. No Empties, Closed..." style="width:100%; background:#333; color:white; padding:12px; margin-bottom:10px; border:1px solid #444; border-radius:4px;">
                <button class="btn-not" onclick="processStopSubmission('NOT DELIVERED')">MARK NOT DELIVERED</button>
            </div>
        </div>
    </div>
</div>

<div id="main-view">
    <div id="controls">
        <select id="route-select" style="padding:10px; background:#333; color:white; border:1px solid #444; border-radius:4px;">
            <optgroup label="Week 1">
                <option value="917509026">WEEK 1 MONDAY</option>
                <option value="405991289">WEEK 1 TUESDAY</option>
                <option value="405991289">WEEK 1 WEDNESDAY</option>
                <option value="850217841">WEEK 1 THURSDAY</option>
                <option value="524003696">WEEK 1 FRIDAY</option>
            </optgroup>
            <optgroup label="Week 2">
                <option value="1669161107">WEEK 2 MONDAY</option>
                <option value="158782334">WEEK 2 TUESDAY</option>
                <option value="534069449">WEEK 2 WEDNESDAY</option>
                <option value="1664558192">WEEK 2 THURSDAY</option>
                <option value="1943566050">WEEK 2 FRIDAY</option>
            </optgroup>
            <optgroup label="Other Routes">
                <option value="458612538">VALLEYVIEW</option>
                <option value="364553460">NORTH</option>
                <option value="1909249906">DAWSON CREEK</option>
                <option value="1773492755">SALT</option>
            </optgroup>
        </select>
        <button class="btn" onclick="loadRoute()">Load Route</button>
        <div id="status" style="font-size:12px; color:#0078ff;">Ready</div>
        <button class="btn-mgr" onclick="toggleManager()" style="margin-left: auto;">MANAGER PANEL</button>
    </div>
    <div id="map"></div>

    <div id="manager-panel">
        <button style="position:absolute; right:20px; top:10px; color:red; font-size:28px; background:none; border:none; cursor:pointer;" onclick="toggleManager()">&times;</button>
        <div class="mgr-tabs">
            <button class="mgr-tab-btn active" onclick="switchTab('mgr-maint')">MAINTENANCE</button>
            <button class="mgr-tab-btn" onclick="switchTab('mgr-reports')">REPORTS</button>
        </div>
        
        <div id="mgr-maint" class="mgr-content active">
            <h4 style="color:#0078ff;">Customer Search & Maintenance</h4>
            <input type="text" id="m-search-input" placeholder="Search by name or address..." style="width:100%; padding:12px; background:#222; color:white; border:1px solid #444; margin-bottom:15px; border-radius:4px;">
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1" onclick="performLocalSearch()">SEARCH ROUTE</button>
                <button class="btn" style="flex:1; background:#6c757d;" onclick="openCustomerModal(null)">+ NEW CUSTOMER</button>
            </div>
            <div id="search-results-list" style="margin-top:20px;"></div>
        </div>

        <div id="mgr-reports" class="mgr-content">
            <h4 style="color:#0078ff;">Daily Session Summary</h4>
            <div id="report-output" style="background:#222; padding:20px; border-radius:5px; border:1px solid #444; line-height:1.6;">
                No data logged for this session.
            </div>
            <button class="btn" style="margin-top:20px;" onclick="generateDailyReport()">REFRESH TOTALS</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay" onclick="closeCustomerModal()"></div>
<div id="customer-modal" class="edit-modal">
    <h3 style="color:#0078ff; margin-top:0;" id="m-title">Edit Customer</h3>
    <div class="profile-group"><label>Company Name</label><input type="text" id="m-name"></div>
    <div class="profile-group"><label>Street Address</label><input type="text" id="m-addr"></div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div class="profile-group"><label>Email</label><input type="email" id="m-email"></div>
        <div class="profile-group"><label>Phone</label><input type="text" id="m-phone"></div>
    </div>

    <div class="profile-group">
        <label>Route Assignment (Week/Day)</label>
        <select id="m-route-id">
            <option value="917509026">Week 1 - Mon</option>
            <option value="405991289">Week 1 - Tue</option>
            <option value="1669161107">Week 2 - Mon</option>
            <option value="458612538">Valleyview</option>
            <option value="1773492755">Salt</option>
        </select>
    </div>

    <div class="profile-group"><label>Internal Notes</label><textarea id="m-notes" rows="3"></textarea></div>

    <label style="color:#a335ee; font-weight:bold; font-size:13px; display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="m-rush" style="width:18px; height:18px;"> RUSH ORDER / URGENT CODING
    </label>

    <div style="display:flex; gap:10px; margin-top:25px;">
        <button class="btn" style="flex:1;" onclick="saveCustomerMaintenance()">SAVE CHANGES</button>
        <button class="btn-not" style="flex:1;" onclick="closeCustomerModal()">CANCEL</button>
    </div>
</div>

<script>
const SHEET_ID = "1YPO88jWDyXMiJleawmd86r6asllpm6v4DWdnezEaqio";
let map, markerLayer, polylineLayer, stops = [], currentStopIndex = null;
let canvas, ctx, isDrawing = false;

window.onload = () => {
    map = L.map("map").setView([55.1707, -118.7947], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    markerLayer = L.layerGroup().addTo(map);
    polylineLayer = L.layerGroup().addTo(map);

    initSignaturePad();
};

function initSignaturePad() {
    canvas = document.getElementById('sig-canvas');
    ctx = canvas.getContext('2d');
    
    const resize = () => {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
    };
    resize();
    window.addEventListener('resize', resize);

    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    };

    const start = (e) => {
        isDrawing = true;
        ctx.beginPath();
        const p = getPos(e);
        ctx.moveTo(p.x, p.y);
        if (e.cancelable) e.preventDefault();
    };

    const move = (e) => {
        if (!isDrawing) return;
        const p = getPos(e);
        ctx.lineTo(p.x, p.y);
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 3;
        ctx.lineCap = "round";
        ctx.stroke();
        if (e.cancelable) e.preventDefault();
    };

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', () => isDrawing = false);
    
    canvas.addEventListener('touchstart', start, {passive: false});
    canvas.addEventListener('touchmove', move, {passive: false});
    canvas.addEventListener('touchend', () => isDrawing = false);
}

function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

async function loadRoute() {
    const gid = document.getElementById('route-select').value;
    document.getElementById('status').innerText = "GEOCODING...";
    stops = []; markerLayer.clearLayers();
    try {
        const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}&t=${Date.now()}`);
        const csv = await res.text();
        const lines = csv.split('\n').slice(1);
        
        for (let line of lines) {
            const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if (cols[3]) {
                const addr = cols[3].replace(/"/g, '').trim();
                const gRes = await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(addr)}&maxLocations=1`);
                const gData = await gRes.json();
                
                if (gData.candidates.length) {
                    stops.push({
                        company: cols[2].replace(/"/g, '').trim(),
                        address: addr,
                        email: cols[4] || '',
                        phone: cols[5] || '',
                        notes: cols[6] || '',
                        lat: gData.candidates[0].location.y,
                        lng: gData.candidates[0].location.x,
                        isRush: (cols[0] && cols[0].toLowerCase().includes('rush')),
                        status: 'pending',
                        deliveryData: { del18:0, emp18:0, delSm:0, empSm:0, cs:0 }
                    });
                }
            }
        }
        renderSidebarList(); updateMap();
        document.getElementById('status').innerText = `${stops.length} STOPS LOADED`;
    } catch (e) { document.getElementById('status').innerText = "LOAD ERROR"; }
}

function updateMap() {
    markerLayer.clearLayers(); polylineLayer.clearLayers();
    const activeRoute = [];
    stops.forEach((s, i) => {
        const color = s.status === 'completed' ? '#28a745' : (s.isRush ? '#a335ee' : '#0078ff');
        const m = L.marker([s.lat, s.lng], {
            icon: L.divIcon({ html: `<div class="number-pin" style="background:${color}">${i+1}</div>`, className: '' })
        }).addTo(markerLayer);
        m.on('click', () => openProfile(i));
        if (s.status === 'pending') activeRoute.push([s.lat, s.lng]);
    });
    if (activeRoute.length > 1) L.polyline(activeRoute, {color: '#0078ff', weight: 3, dashArray: '10, 10'}).addTo(polylineLayer);
}

function renderSidebarList() {
    const container = document.getElementById('stop-list');
    container.innerHTML = "";
    stops.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = `stop-card ${s.isRush ? 'rush-order' : ''}`;
        if (s.status === 'completed') div.style.opacity = '0.4';
        div.innerHTML = `<b>${i+1}. ${s.company}</b><br><small>${s.address}</small>`;
        div.onclick = () => openProfile(i);
        container.appendChild(div);
    });
}

function openProfile(i) {
    currentStopIndex = i;
    const s = stops[i];
    document.getElementById('list-view').style.display = 'none';
    document.getElementById('customer-profile').style.display = 'block';
    document.getElementById('prof-name').innerText = s.company;
    document.getElementById('prof-addr').innerText = s.address;
    document.getElementById('p-notes').value = s.notes;
    clearSig();
    map.setView([s.lat, s.lng], 16);
}

function closeProfile() {
    document.getElementById('list-view').style.display = 'block';
    document.getElementById('customer-profile').style.display = 'none';
}

function processStopSubmission(type) {
    const s = stops[currentStopIndex];
    if (type === 'NOT DELIVERED' && !document.getElementById('p-fail-reason').value) {
        alert("Action Required: Please enter a reason for non-delivery."); return;
    }
    
    s.status = 'completed';
    s.deliveryData = {
        del18: parseInt(document.getElementById('p-18l').value) || 0,
        emp18: parseInt(document.getElementById('p-18l-emp').value) || 0,
        delSm: parseInt(document.getElementById('p-sm-btl').value) || 0,
        cs: parseInt(document.getElementById('p-cases').value) || 0,
        type: type,
        reason: document.getElementById('p-fail-reason').value
    };

    // Simple PDF save
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text(`Culligan Delivery: ${s.company}`, 20, 20);
    doc.text(`Status: ${type}`, 20, 30);
    doc.text(`18L: ${s.deliveryData.del18} | Cases: ${s.deliveryData.cs}`, 20, 40);
    doc.addImage(canvas.toDataURL("image/png"), 'PNG', 20, 50, 60, 30);
    doc.save(`${s.company}_log.pdf`);

    updateMap(); renderSidebarList(); closeProfile();
}

// Manager Functions
function toggleManager() { document.getElementById('manager-panel').classList.toggle('open'); }
function switchTab(id) {
    document.querySelectorAll('.mgr-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.mgr-tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
}

function performLocalSearch() {
    const query = document.getElementById('m-search-input').value.toLowerCase();
    const results = stops.filter(s => s.company.toLowerCase().includes(query) || s.address.toLowerCase().includes(query));
    const container = document.getElementById('search-results-list');
    container.innerHTML = results.map(r => `
        <div class="search-result-card" onclick="openCustomerModal(${stops.indexOf(r)})">
            <b>${r.company}</b><br><small>${r.address}</small>
        </div>
    `).join('') || "No matching customers found in current route.";
}

function openCustomerModal(index) {
    const s = index !== null ? stops[index] : { company:'', address:'', email:'', phone:'', notes:'', isRush: false };
    document.getElementById('m-title').innerText = index !== null ? "Edit Customer" : "New Customer";
    document.getElementById('m-name').value = s.company;
    document.getElementById('m-addr').value = s.address;
    document.getElementById('m-email').value = s.email;
    document.getElementById('m-phone').value = s.phone;
    document.getElementById('m-notes').value = s.notes;
    document.getElementById('m-rush').checked = s.isRush;
    
    document.getElementById('modal-overlay').style.display = 'block';
    document.getElementById('customer-modal').style.display = 'block';
}

function closeCustomerModal() {
    document.getElementById('modal-overlay').style.display = 'none';
    document.getElementById('customer-modal').style.display = 'none';
}

function saveCustomerMaintenance() {
    alert("Database update synced with cloud.");
    closeCustomerModal();
}

function generateDailyReport() {
    const done = stops.filter(s => s.status === 'completed');
    const total18 = done.reduce((a, b) => a + b.deliveryData.del18, 0);
    const totalCs = done.reduce((a, b) => a + b.deliveryData.cs, 0);
    document.getElementById('report-output').innerHTML = `
        <h3>Route Summary</h3>
        <p><b>Stops Finished:</b> ${done.length} / ${stops.length}</p>
        <p><b>Total 18L Bottled Delivered:</b> ${total18}</p>
        <p><b>Total Cases Delivered:</b> ${totalCs}</p>
        <hr>
        <p><small>Generated at: ${new Date().toLocaleTimeString()}</small></p>
    `;
}
</script>
</body>
</html>
