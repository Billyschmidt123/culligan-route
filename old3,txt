<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Culligan Grande Prairie - Driver Portal</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

<style>
  :root { --culligan-blue: #002b7f; --accent-blue: #0078ff; }
  body { margin: 0; font-family: sans-serif; background: #f4f4f4; display: flex; flex-direction: column; height: 100vh; }
  header { background: var(--culligan-blue); color: white; padding: 15px; text-align: center; }
  #controls { padding: 10px; background: white; border-bottom: 2px solid #ddd; }
  select, button { width: 100%; padding: 12px; margin: 5px 0; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
  button { background: var(--accent-blue); color: white; font-weight: bold; cursor: pointer; border: none; }
  #map { flex-grow: 1; width: 100%; }
  .stop-card { background: white; padding: 15px; border-top: 2px solid var(--culligan-blue); }
</style>
</head>
<body>

<header>
  <strong>CULLIGAN GP - ROUTE SYNC</strong>
</header>

<div id="controls">
  <select id="routeSelect">
    <option value="">-- SELECT TODAY'S ROUTE --</option>
    <option value="data/Bottle-water.xlsx - Week 1 Monday.csv">Week 1 - Monday</option>
    <option value="data/Bottle-water.xlsx - Week 1 Tuesday.csv">Week 1 - Tuesday</option>
    <option value="data/Bottle-water.xlsx - Week 1 Wednessday.csv">Week 1 - Wednesday</option>
    <option value="data/Bottle-water.xlsx - Week 1 Thursday.csv">Week 1 - Thursday</option>
    <option value="data/Bottle-water.xlsx - Week 1 Friday.csv">Week 1 - Friday</option>
    <option value="data/Bottle-water.xlsx - Week 2 Monday.csv">Week 2 - Monday</option>
    <option value="data/Bottle-water.xlsx - Week 2 Tuesday.csv">Week 2 - Tuesday</option>
    <option value="data/Bottle-water.xlsx - North.csv">North Route (Peace River)</option>
    <option value="data/Bottle-water.xlsx - Valley view .csv">Valleyview</option>
    <option value="data/Bottle-water.xlsx - Dawson creek.csv">Dawson Creek</option>
    <option value="data/Bottle-water.xlsx - Salt.csv">Salt Deliveries</option>
  </select>
  <button onclick="loadRoute()">LOAD ROUTE</button>
</div>

<div id="map"></div>

<div id="currentStop" class="stop-card">
  <h3 id="companyName">Select a Route to Begin</h3>
  <p id="addressText">---</p>
  <button id="syncBtn" style="background: green; display:none;" onclick="syncData()">END ROUTE & SYNC TO OFFICE</button>
</div>

<script>
let stops = [];
let map = L.map('map').setView([55.1707, -118.7947], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// IMPORTANT: Replace this with your new Web App URL from Google Script
const scriptURL = "REPLACE_WITH_YOUR_NEW_GOOGLE_SCRIPT_URL";

async function loadRoute() {
  const file = document.getElementById('routeSelect').value;
  if(!file) return alert("Please select a route");

  try {
    const response = await fetch(file);
    if(!response.ok) throw new Error("File not found");
    const csvData = await response.text();
    
    Papa.parse(csvData, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        stops = results.data;
        alert("Route Loaded: " + stops.length + " stops found.");
        displayStopsOnMap();
        document.getElementById('syncBtn').style.display = 'block';
      }
    });
  } catch (err) {
    alert("Error: " + err.message + ". Check that the 'data' folder and files are named correctly on GitHub.");
  }
}

function displayStopsOnMap() {
  stops.forEach((stop, index) => {
    if(stop.Address) {
        // This is a simplified version; real geocoding would happen here
        L.marker([55.17, -118.79]).addTo(map)
          .bindPopup(`<b>${stop.Company}</b><br>${stop.Address}`);
    }
  });
}

async function syncData() {
  if(!confirm("Are you sure you want to end the route and send data to the office?")) return;

  const payload = {
    route: document.getElementById('routeSelect').selectedOptions[0].text,
    timestamp: new Date().toLocaleString(),
    data: stops
  };

  try {
    // Using 'no-cors' to prevent the 401/Authorization block
    await fetch(scriptURL, {
      method: 'POST',
      mode: 'no-cors',
      cache: 'no-cache',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    alert("SUCCESS! Data sent to Google Drive.");
  } catch (e) {
    alert("Sync Error: " + e.message);
  }
}
</script>

</body>
</html>
